---
import BaseLayout from '@/layouts/BaseLayout.astro';
import StatCard from '@/components/cards/StatCard.astro';
import MilestonePrediction from '@/components/cards/MilestonePrediction.astro';
import GitHubHistoryChart from '@/components/charts/GitHubHistoryChart.astro';
import GitHubIssuesChart from '@/components/charts/GitHubIssuesChart.astro';
import ReleaseTimelineChart from '@/components/charts/ReleaseTimelineChart.astro';
import NpmDownloadsChart from '@/components/charts/NpmDownloadsChart.astro';
import DataSourcesSection from '@/components/DataSourcesSection.astro';
import { formatNumber } from '@/lib/utils/formatters';
import { predictMilestone, getNextMilestones } from '@/lib/utils/predictions';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load GitHub data from stored history files (populated daily by scripts)
// No API calls during build - all data comes from version-controlled JSON files
const historyPath = join(process.cwd(), 'public', 'data', 'github-history.json');
const releasesPath = join(process.cwd(), 'public', 'data', 'github-releases.json');
const landscapePath = join(process.cwd(), 'public', 'data', 'history', 'landscape.json');

let githubStats = { stars: 0, forks: 0, watchers: 0, openIssues: 0, subscribers: 0 };
let releases: Array<{ tagName: string; name: string; publishedAt: string; htmlUrl: string; prerelease: boolean; body: string }> = [];
let starHistory: Array<{ date: string; value: number }> = [];

try {
  const historyData = JSON.parse(readFileSync(historyPath, 'utf-8'));
  // Get latest stats from most recent monthly entry
  const latest = historyData.monthly?.[historyData.monthly.length - 1];
  if (latest) {
    githubStats = {
      stars: latest.stars || 0,
      forks: latest.forks || 0,
      watchers: latest.watchers || 0,
      openIssues: latest.openIssues || 0,
      subscribers: latest.watchers || 0,
    };
  }
  // Use monthly data for predictions
  starHistory = historyData.monthly?.map((d: any) => ({
    date: d.date,
    value: d.stars,
  })) || [];
} catch (e) {
  console.warn('Could not load GitHub history');
}

// Extract sparkline data (last 12 months)
const starsSparklineData = starHistory.slice(-12).map(d => d.value);

// Load releases if available
try {
  if (existsSync(releasesPath)) {
    releases = JSON.parse(readFileSync(releasesPath, 'utf-8'));
  }
} catch (e) {
  console.warn('Could not load GitHub releases');
}

// Load velocity data from landscape
let velocityData = {
  commits90d: 0,
  releases90d: 0,
  weeklyCommits: 0,
  latestRelease: null as string | null,
};
try {
  if (existsSync(landscapePath)) {
    const landscapeData = JSON.parse(readFileSync(landscapePath, 'utf-8'));
    const latestVelocity = landscapeData?.velocity?.daily?.slice(-1)[0] || {};
    velocityData = {
      commits90d: latestVelocity['n8n_commits90d'] || 0,
      releases90d: latestVelocity['n8n_releases90d'] || 0,
      weeklyCommits: latestVelocity['n8n_weeklyCommits'] || 0,
      latestRelease: latestVelocity['n8n_latestRelease'] || null,
    };
  }
} catch (e) {
  console.warn('Could not load velocity data');
}

// Calculate milestone predictions
const currentStars = githubStats.stars;
const milestones = getNextMilestones(currentStars, 'stars');
const predictions = milestones.map(milestone =>
  predictMilestone(starHistory, milestone, { lookbackMonths: 6 })
);

// Format date helper
const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// Get recent releases (last 5)
const recentReleases = releases.slice(0, 5);

// GitHub Octicons (official GitHub icons)
const icons = {
  github: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="32" height="32" fill="currentColor"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>`,
  star: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"></path></svg>`,
  fork: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"></path></svg>`,
  eye: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M8 2c1.981 0 3.671.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.45.678-1.367 1.932-2.637 3.023C11.67 13.008 9.981 14 8 14c-1.981 0-3.671-.992-4.933-2.078C1.797 10.83.88 9.576.43 8.898a1.62 1.62 0 0 1 0-1.798c.45-.677 1.367-1.931 2.637-3.022C4.33 2.992 6.019 2 8 2ZM1.679 7.932a.12.12 0 0 0 0 .136c.411.622 1.241 1.75 2.366 2.717C5.176 11.758 6.527 12.5 8 12.5c1.473 0 2.825-.742 3.955-1.715 1.124-.967 1.954-2.096 2.366-2.717a.12.12 0 0 0 0-.136c-.412-.621-1.242-1.75-2.366-2.717C10.824 4.242 9.473 3.5 8 3.5c-1.473 0-2.824.742-3.955 1.715-1.124.967-1.954 2.096-2.366 2.717ZM8 10a2 2 0 1 1-.001-3.999A2 2 0 0 1 8 10Z"></path></svg>`,
  issue: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"></path><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"></path></svg>`,
  commit: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M11.93 8.5a4.002 4.002 0 0 1-7.86 0H.75a.75.75 0 0 1 0-1.5h3.32a4.002 4.002 0 0 1 7.86 0h3.32a.75.75 0 0 1 0 1.5Zm-1.43-.75a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path></svg>`,
  tag: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"></path></svg>`,
  pulse: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="24" height="24" fill="currentColor"><path d="M6 2c.306 0 .582.187.696.471L10 10.731l1.304-3.26A.751.751 0 0 1 12 7h3.25a.75.75 0 0 1 0 1.5h-2.742l-1.812 4.528a.751.751 0 0 1-1.392 0L6 4.77 4.696 8.03A.75.75 0 0 1 4 8.5H.75a.75.75 0 0 1 0-1.5h2.742l1.812-4.529A.751.751 0 0 1 6 2Z"></path></svg>`,
};
---

<BaseLayout title="Dev Stats" description="n8n development metrics: GitHub activity, npm downloads, and release cadence">
  <div class="container-narrow py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
        <span class="text-white" set:html={icons.github} />
        Dev Stats
      </h1>
      <p class="text-gray-400">
        Development metrics for <a href="https://github.com/n8n-io/n8n" target="_blank" rel="noopener" class="text-n8n-primary hover:underline">n8n-io/n8n</a> and <a href="https://www.npmjs.com/package/n8n" target="_blank" rel="noopener" class="text-n8n-primary hover:underline">npm</a>
      </p>
    </div>

    <!-- Repository Stats + Milestones (Hero Block) -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Repository Overview</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard label="Stars" value={githubStats.stars} sparklineData={starsSparklineData} />
        <StatCard label="Forks" value={githubStats.forks} icon={icons.fork} />
        <StatCard label="Watchers" value={githubStats.subscribers} icon={icons.eye} />
        <StatCard label="Open Issues" value={githubStats.openIssues} icon={icons.issue} />
      </div>

      {/* Star Milestones - within hero block */}
      {predictions.length > 0 && (
        <div class="mt-8">
          <h3 class="text-xl font-bold text-white mb-2">Star Milestones</h3>
          <p class="text-gray-400 mb-4">
            Predicted dates based on recent growth trends (last 6 months)
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {predictions.map((pred) => (
              <MilestonePrediction
                label="GitHub Stars"
                milestone={pred.milestone}
                predictedDate={pred.predictedDate}
                daysUntil={pred.daysUntil}
                confidence={pred.confidence}
                currentValue={pred.currentValue}
                icon="â­"
              />
            ))}
          </div>
        </div>
      )}
    </section>

    <!-- Development Velocity -->
    {velocityData.commits90d > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-n8n-primary" set:html={icons.pulse} />
        Development Velocity
      </h2>
      <p class="text-gray-400 mb-6">
        Commit and release activity over the last 90 days
      </p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card">
          <div class="flex items-start gap-3">
            <span class="text-n8n-primary mt-1" set:html={icons.commit} />
            <div>
              <p class="text-gray-400 text-sm">Commits (90 days)</p>
              <p class="text-3xl font-bold text-white">{velocityData.commits90d.toLocaleString()}</p>
              <p class="text-gray-500 text-xs mt-1">~{Math.round(velocityData.commits90d / 13)} per week</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-start gap-3">
            <span class="text-green-400 mt-1" set:html={icons.tag} />
            <div>
              <p class="text-gray-400 text-sm">Releases (90 days)</p>
              <p class="text-3xl font-bold text-white">{velocityData.releases90d}</p>
              <p class="text-gray-500 text-xs mt-1">~{(velocityData.releases90d / 3).toFixed(1)} per month</p>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-start gap-3">
            <span class="text-blue-400 mt-1" set:html={icons.commit} />
            <div>
              <p class="text-gray-400 text-sm">Weekly Commits</p>
              <p class="text-3xl font-bold text-white">{velocityData.weeklyCommits}</p>
              {velocityData.latestRelease && (
                <p class="text-gray-500 text-xs mt-1">Latest: {velocityData.latestRelease}</p>
              )}
            </div>
          </div>
        </div>
      </div>
      <p class="text-gray-500 text-xs mt-4 text-center">
        Compare n8n development velocity with competitors on the <a href="/market" class="text-n8n-primary hover:underline">Market page</a>
      </p>
    </section>
    )}

    <!-- Star History Chart -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Star History</h2>
      <GitHubHistoryChart />
    </section>

    <!-- npm Downloads History -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#cb3837"><path d="M0 0v24h24V0H0zm19.2 19.2H12v-9.6H7.2v9.6H4.8V4.8h14.4v14.4z"/></svg>
        npm Downloads
      </h2>
      <p class="text-gray-400 mb-6">
        Weekly download counts for the <a href="https://www.npmjs.com/package/n8n" target="_blank" rel="noopener" class="text-n8n-primary hover:underline">n8n</a> npm package since 2019.
      </p>
      <NpmDownloadsChart />
    </section>

    <!-- Issues Chart -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Issue Activity</h2>
      <p class="text-gray-400 mb-4">Monthly issues opened and closed, with cumulative open issues over time.</p>
      <GitHubIssuesChart />
    </section>

    <!-- Release Timeline -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Release Timeline</h2>
      <p class="text-gray-400 mb-4">Official releases since 1.0 (July 2023). Click a release to view details.</p>
      <ReleaseTimelineChart />
    </section>

    <!-- Recent Releases -->
    {recentReleases.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Recent Releases</h2>
      <div class="space-y-4">
        {recentReleases.map((release, index) => (
          <a
            href={release.htmlUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="card block hover:border-n8n-primary/30 transition-colors"
          >
            <div class="flex items-start justify-between">
              <div>
                <div class="flex items-center gap-3">
                  <h3 class="font-semibold text-white">{release.tagName}</h3>
                  {index === 0 && (
                    <span class="px-2 py-0.5 text-xs font-medium bg-n8n-primary/20 text-n8n-primary rounded-full">
                      Latest
                    </span>
                  )}
                  {release.prerelease && (
                    <span class="px-2 py-0.5 text-xs font-medium bg-yellow-500/20 text-yellow-400 rounded-full">
                      Pre-release
                    </span>
                  )}
                </div>
                {release.name && release.name !== release.tagName && (
                  <p class="text-sm text-gray-400 mt-1">{release.name}</p>
                )}
              </div>
              <span class="text-sm text-gray-500">{formatDate(release.publishedAt)}</span>
            </div>
          </a>
        ))}
      </div>
    </section>
    )}

    <!-- Link to GitHub -->
    <div class="text-center">
      <a
        href="https://github.com/n8n-io/n8n"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-6 py-3 bg-n8n-primary text-white rounded-lg font-medium hover:bg-n8n-primary/90 transition-colors"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        View on GitHub
      </a>
    </div>

    <!-- Data Sources Attribution -->
    <DataSourcesSection sources={[
      { label: "GitHub stats", source: "GitHub API", url: "https://api.github.com", note: "updated daily" },
      { label: "Historical stars", source: "ossinsight.io", note: "scaled estimates" },
      { label: "npm downloads", source: "npm API", url: "https://npmjs.com/package/n8n", note: "updated daily" },
    ]} />
  </div>
</BaseLayout>
