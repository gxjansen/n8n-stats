---
import BaseLayout from '@/layouts/BaseLayout.astro';
import TemplatesHistoryChart from '@/components/charts/TemplatesHistoryChart.astro';
import CategoryTreemapChart from '@/components/charts/CategoryTreemapChart.astro';
import MilestonePrediction from '@/components/cards/MilestonePrediction.astro';
import StatCard from '@/components/cards/StatCard.astro';
import { fetchTemplateAnalytics } from '@/lib/api/n8n';
import { formatNumber, n8nUrls } from '@/lib/utils/formatters';
import { predictMilestone, getNextMilestones } from '@/lib/utils/predictions';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load n8n Arena creators data (insertions)
interface ArenaCreator {
  username: string;
  name: string;
  verified: boolean;
  avatar: string;
  templateCount: number;
  totalViews: number;
  totalInserters: number;
  monthlyInserters: number;
  weeklyInserters: number;
}

let arenaCreators: ArenaCreator[] = [];
try {
  const arenaPath = join(process.cwd(), 'public', 'data', 'external', 'n8narena-creators.json');
  if (existsSync(arenaPath)) {
    arenaCreators = JSON.parse(readFileSync(arenaPath, 'utf-8'));
  }
} catch (e) {
  console.warn('n8narena-creators.json not found');
}

// Top creators by insertions (from Arena)
const topCreatorsByInsertions = arenaCreators
  .filter(c => c.totalInserters > 0)
  .sort((a, b) => b.totalInserters - a.totalInserters)
  .slice(0, 10);

// Fetch comprehensive analytics
const analytics = await fetchTemplateAnalytics();

// Load complete template data (fetched weekly)
let allTemplatesData: any = null;
try {
  const dataPath = join(process.cwd(), 'public', 'data', 'all-templates-data.json');
  allTemplatesData = JSON.parse(readFileSync(dataPath, 'utf-8'));
} catch (e) {
  console.warn('all-templates-data.json not found, using sample data');
}

// Sort categories by count
const sortedCategories = [...analytics.categories].sort((a, b) => b.count - a.count);

// Prepare chart data
const viewsData = [
  { label: 'Viral (100K+)', value: analytics.viewsDistribution.viral, color: '#ff6384', tier: 'viral' },
  { label: 'Popular (10K-100K)', value: analytics.viewsDistribution.popular, color: '#36a2eb', tier: 'popular' },
  { label: 'Growing (1K-10K)', value: analytics.viewsDistribution.growing, color: '#ffce56', tier: 'growing' },
  { label: 'New (<1K)', value: analytics.viewsDistribution.new, color: '#4bc0c0', tier: 'new' },
];

// Templates by views tier (for expandable sections)
const templatesByViews = analytics.templatesByViews;
const topTemplatesByViews = analytics.topTemplatesByViews;

// Use complete data for complexity if available, otherwise fall back to sample
const complexityData = allTemplatesData?.complexity?.distribution || analytics.nodeCountBreakdown.map(n => ({
  label: n.nodes,
  count: n.count,
}));

// Creation timeline from complete data
const creationTimeline = allTemplatesData?.timeline?.monthly || [];

// Prepare template history for milestone predictions
const templateHistory = creationTimeline.map((d: { month: string; cumulative: number }) => ({
  date: d.month,
  value: d.cumulative,
}));

// Calculate milestone predictions for templates
const currentTemplates = templateHistory.length > 0 ? templateHistory[templateHistory.length - 1].value : 0;
const templateMilestones = getNextMilestones(currentTemplates, 'generic');
const templatePredictions = templateMilestones.map(milestone =>
  predictMilestone(templateHistory, milestone, { lookbackMonths: 6 })
);

// AI categories breakdown for horizontal bar chart
const aiCategoriesData = analytics.aiStats.aiCategories;

const nodeCategoryData = analytics.nodeCategories.slice(0, 10).map(c => ({
  name: c.value,
  count: c.count,
}));

// Complete data stats
const hasCompleteData = !!allTemplatesData;
const completeDataStats = allTemplatesData ? {
  totalCreators: allTemplatesData.creators.total,
  uniqueNodes: allTemplatesData.nodes.unique,
  avgComplexity: allTemplatesData.complexity.average,
  medianComplexity: allTemplatesData.complexity.median,
  lastUpdated: allTemplatesData.lastUpdated,
} : null;
---

<BaseLayout title="Template Statistics" description="Comprehensive statistics and insights for n8n workflow templates">
  <div class="container-narrow py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Template Statistics</h1>
      <p class="text-gray-400">
        Comprehensive insights into the n8n workflow template ecosystem
      </p>
    </div>

    <!-- Overview Stats -->
    <section class="mb-12">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <StatCard
          label="Total Templates"
          value={analytics.totalWorkflows}
        />
        <StatCard
          label="Unique Nodes Used"
          value={completeDataStats?.uniqueNodes || analytics.topNodes.length}
        />
        <StatCard
          label="Template Creators"
          value={completeDataStats?.totalCreators || 0}
        />
      </div>
    </section>

    <!-- Growth Chart -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-4">Template Growth Over Time</h2>
      <p class="text-gray-400 mb-6">
        Track how the template library grows. Historical data builds daily.
      </p>
      <TemplatesHistoryChart />
    </section>

    <!-- Template Milestones -->
    {templatePredictions.length > 0 && templatePredictions.some(p => p.predictedDate) && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-white mb-2">Template Milestones</h2>
        <p class="text-gray-400 mb-6">
          Predicted dates based on recent growth trends (last 6 months)
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {templatePredictions.map((pred) => (
            <MilestonePrediction
              label="Total Templates"
              milestone={pred.milestone}
              predictedDate={pred.predictedDate}
              daysUntil={pred.daysUntil}
              confidence={pred.confidence}
              currentValue={pred.currentValue}
              icon="ðŸ“‹"
            />
          ))}
        </div>
      </section>
    )}

    <!-- AI Dominance - uses complete API data -->
    <section class="mb-12 ai-templates-section">
      <h2 class="text-2xl font-bold text-white mb-6">AI in Templates</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card ai-adoption-inline">
          <h4 class="text-lg font-semibold text-white mb-4">AI Adoption</h4>
          <!-- AI Category Templates -->
          <div class="mb-5">
            <div class="flex items-center justify-between mb-2">
              <span class="text-gray-300">AI Category Templates</span>
              <span class="text-2xl font-bold text-purple-400 ai-pct-display" data-target={Math.round((analytics.aiStats.aiCategories[0]?.count || 0) / analytics.totalWorkflows * 100)}>
                {Math.round((analytics.aiStats.aiCategories[0]?.count || 0) / analytics.totalWorkflows * 100)}%
              </span>
            </div>
            <div class="relative h-5 bg-n8n-darker rounded overflow-hidden">
              <div
                class="ai-inline-bar absolute inset-y-0 left-0 bg-gradient-to-r from-purple-600 to-purple-400 rounded"
                style={`--target-width: ${Math.round((analytics.aiStats.aiCategories[0]?.count || 0) / analytics.totalWorkflows * 100)}%;`}
                data-target-width={Math.round((analytics.aiStats.aiCategories[0]?.count || 0) / analytics.totalWorkflows * 100)}
              />
            </div>
            <div class="text-xs text-gray-500 mt-1">
              {formatNumber(analytics.aiStats.aiCategories[0]?.count || 0)} of {formatNumber(analytics.totalWorkflows)} templates in AI category
            </div>
          </div>
          <!-- AI Agent Node Usage -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-gray-300">Using AI Agent Node</span>
              <span class="text-2xl font-bold text-cyan-400 ai-pct-display" data-target={Math.round((analytics.topNodes.find(n => n.value === 'AI Agent')?.count || 0) / analytics.totalWorkflows * 100)}>
                {Math.round((analytics.topNodes.find(n => n.value === 'AI Agent')?.count || 0) / analytics.totalWorkflows * 100)}%
              </span>
            </div>
            <div class="relative h-5 bg-n8n-darker rounded overflow-hidden">
              <div
                class="ai-inline-bar ai-inline-bar-delay absolute inset-y-0 left-0 bg-gradient-to-r from-cyan-600 to-cyan-400 rounded"
                style={`--target-width: ${Math.round((analytics.topNodes.find(n => n.value === 'AI Agent')?.count || 0) / analytics.totalWorkflows * 100)}%;`}
                data-target-width={Math.round((analytics.topNodes.find(n => n.value === 'AI Agent')?.count || 0) / analytics.totalWorkflows * 100)}
              />
            </div>
            <div class="text-xs text-gray-500 mt-1">
              {formatNumber(analytics.topNodes.find(n => n.value === 'AI Agent')?.count || 0)} templates use the AI Agent node
            </div>
          </div>
        </div>
        <div class="card ai-breakdown-card">
          <h4 class="text-lg font-semibold text-white mb-4">AI Category Breakdown</h4>
          <div class="space-y-3">
            {analytics.aiStats.aiCategories.map((cat, index) => {
              const maxCount = analytics.aiStats.aiCategories[0]?.count || 1;
              const percentage = (cat.count / maxCount) * 100;
              const colors = ['#9966ff', '#b366ff', '#cc99ff', '#7733ff'];
              return (
                <div class="flex items-center gap-4">
                  <div class="w-32 text-sm text-gray-300 truncate" title={cat.value}>
                    {cat.value}
                  </div>
                  <div class="flex-1 h-6 bg-n8n-darker rounded overflow-hidden">
                    <div
                      class="ai-category-bar h-full rounded"
                      style={`--target-width: ${percentage}%; --bar-color: ${colors[index % colors.length]}; --bar-delay: ${index * 100}ms;`}
                      data-target-width={percentage}
                    ></div>
                  </div>
                  <div class="w-16 text-right text-sm text-gray-400">
                    {formatNumber(cat.count)}
                  </div>
                </div>
              );
            })}
          </div>
          <div class="mt-4 pt-4 border-t border-gray-700">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">Total AI category assignments:</span>
              <span class="text-purple-400 font-bold">{formatNumber(analytics.aiStats.aiCategoryCount)}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category Breakdown -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Templates by Category</h2>
      <p class="text-gray-400 mb-4">
        Rectangle size represents the number of templates in each category.
        <span class="text-n8n-primary">Click any category to browse templates on n8n.io.</span>
      </p>
      <CategoryTreemapChart data={sortedCategories.map(c => ({ name: c.value, count: c.count }))} />
    </section>

    <!-- Trending Creators -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Trending Template Creators</h2>
          <p class="text-gray-400 mt-1">
            Creators with the most templates in n8n.io's current top 100 trending list
          </p>
        </div>
        <a
          href={n8nUrls.creators()}
          target="_blank"
          rel="noopener noreferrer"
          class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
        >
          View all creators &rarr;
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {analytics.topCreators.slice(0, 10).map((creator, index) => (
          <a
            href={n8nUrls.creator(creator.username)}
            target="_blank"
            rel="noopener noreferrer"
            class="card flex items-center gap-3 hover:bg-n8n-darker/50 transition-colors"
          >
            <div class={`text-xl font-bold w-8 ${index < 3 ? 'text-n8n-primary' : 'text-gray-500'}`}>
              #{index + 1}
            </div>
            {creator.avatar ? (
              <img
                src={creator.avatar}
                alt={creator.name}
                class="w-10 h-10 rounded-full bg-n8n-darker"
                loading="lazy"
              />
            ) : (
              <div class="w-10 h-10 rounded-full bg-n8n-darker flex items-center justify-center text-gray-500">
                <span class="text-lg">{creator.name.charAt(0).toUpperCase()}</span>
              </div>
            )}
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-white truncate">{creator.name}</span>
                {creator.verified && (
                  <span class="text-blue-400 text-xs" title="Verified Creator">âœ“</span>
                )}
              </div>
              <div class="text-sm text-gray-400">@{creator.username}</div>
            </div>
            <div class="text-right text-sm">
              <div class="text-white">
                <span class="font-bold text-n8n-primary">{creator.templateCount}</span>
                <span class="text-gray-400"> of {creator.totalTemplates} trending</span>
              </div>
              <div class="text-gray-500">{formatNumber(creator.totalViews)} views</div>
            </div>
          </a>
        ))}
      </div>
      <p class="text-sm text-gray-500 mt-4">
        Ranked by presence in trending templates. Click a creator to see their full profile.
      </p>
    </section>

    <!-- Most Used Nodes -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Used Nodes</h2>
          <p class="text-gray-400 mt-1">
            Nodes appearing in the most templates across all {formatNumber(analytics.totalWorkflows)} workflows
          </p>
        </div>
        <a
          href="/nodes"
          class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
        >
          View all nodes &rarr;
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
        {analytics.topNodes.slice(0, 10).map((node, index) => (
          <div class="card py-3 px-4 flex items-center gap-3">
            <div class={`text-lg font-bold ${index < 3 ? 'text-n8n-primary' : 'text-gray-500'}`}>
              #{index + 1}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-white text-sm truncate" title={node.value}>
                {node.value}
              </div>
              <div class="text-xs text-gray-400">
                {formatNumber(node.count)} templates
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Workflow Complexity - Complete Data -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Workflow Complexity</h2>
          <p class="text-gray-400 mt-1">
            Distribution of nodes per template across all {formatNumber(analytics.totalWorkflows)} templates
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">
            Average: <span class="text-white font-medium">{completeDataStats?.avgComplexity || 4} nodes</span>
          </div>
          <div class="text-sm text-gray-400">
            Median: <span class="text-white font-medium">{completeDataStats?.medianComplexity || 4} nodes</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="relative h-[240px] md:h-[300px]">
          <canvas id="complexity-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Top Creators by Insertions (Arena Data) -->
    {topCreatorsByInsertions.length > 0 && (
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-white">Top Creators by Insertions</h2>
            <p class="text-gray-400 mt-1">
              Total all-time template imports by users (from n8n Arena)
            </p>
          </div>
          <a
            href="https://n8narena.com"
            target="_blank"
            rel="noopener noreferrer"
            class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
          >
            View n8n Arena &rarr;
          </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          {topCreatorsByInsertions.map((creator, index) => (
            <a
              href={n8nUrls.creator(creator.username)}
              target="_blank"
              rel="noopener noreferrer"
              class="card flex items-center gap-3 hover:bg-n8n-darker/50 transition-colors py-3"
            >
              <div class={`text-lg font-bold w-8 ${index < 3 ? 'text-green-400' : 'text-gray-500'}`}>
                #{index + 1}
              </div>
              {creator.avatar ? (
                <img
                  src={creator.avatar}
                  alt={creator.name}
                  class="w-10 h-10 rounded-full bg-n8n-darker flex-shrink-0"
                  loading="lazy"
                />
              ) : (
                <div class="w-10 h-10 rounded-full bg-n8n-darker flex items-center justify-center text-gray-500 flex-shrink-0">
                  <span class="text-lg">{creator.name.charAt(0).toUpperCase()}</span>
                </div>
              )}
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-white truncate">{creator.name}</span>
                  {creator.verified && (
                    <span class="text-blue-400 text-xs flex-shrink-0" title="Verified Creator">âœ“</span>
                  )}
                </div>
                <div class="text-xs text-gray-400">
                  @{creator.username} Â· {creator.templateCount} templates
                </div>
              </div>
              <div class="text-right flex-shrink-0">
                <div class="text-green-400 font-bold">
                  {formatNumber(creator.totalInserters)}
                </div>
                <div class="text-xs text-gray-500">insertions</div>
              </div>
            </a>
          ))}
        </div>
        <p class="text-xs text-gray-500 mt-3">
          Data from <a href="https://n8narena.com" target="_blank" rel="noopener" class="text-n8n-primary hover:underline">n8n Arena</a>.
          Insertions = templates added to workflows by users.
        </p>
      </section>
    )}

    <!-- Top Templates by Views -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Viewed Templates</h2>
          <p class="text-gray-400 mt-1">
            Highest view counts among the top 100 trending templates
          </p>
        </div>
        <a
          href={n8nUrls.workflows()}
          target="_blank"
          rel="noopener noreferrer"
          class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
        >
          Browse all templates &rarr;
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {topTemplatesByViews.slice(0, 10).map((template, index) => (
          <a
            href={n8nUrls.workflow(template.id)}
            target="_blank"
            rel="noopener noreferrer"
            class="card flex items-center gap-3 hover:bg-n8n-darker/50 transition-colors py-3"
          >
            <div class={`text-lg font-bold w-8 ${index < 3 ? 'text-n8n-primary' : 'text-gray-500'}`}>
              #{index + 1}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-white text-sm truncate" title={template.name}>
                  {template.name}
                </span>
                {template.verified && (
                  <span class="text-blue-400 text-xs flex-shrink-0" title="Verified Creator">âœ“</span>
                )}
              </div>
              <div class="text-xs text-gray-400">
                by @{template.username} Â· {template.nodeCount} nodes
              </div>
            </div>
            <div class="text-right flex-shrink-0">
              <div class="text-n8n-primary font-bold">
                {formatNumber(template.totalViews)}
              </div>
              <div class="text-xs text-gray-500">views</div>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Trending Templates Sample Analysis -->
    <section class="mb-12">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-white mb-2">Views Distribution</h2>
        <p class="text-gray-400">
          How views are distributed among the top 100 trending templates. Click a segment to see templates in that tier.
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Chart -->
        <div class="card">
          <h3 class="text-lg font-semibold text-white mb-4">Distribution Chart</h3>
          <div class="relative h-[220px] md:h-[280px]">
            <canvas id="views-chart"></canvas>
          </div>
          <p class="text-xs text-gray-500 text-center mt-2">
            Click a segment to view templates in that tier
          </p>
        </div>

        <!-- Clickable Categories List -->
        <div class="card">
          <h3 class="text-lg font-semibold text-white mb-4">Browse by Tier</h3>
          <div class="space-y-3">
            {viewsData.map((tier) => {
              const templates = templatesByViews[tier.tier as keyof typeof templatesByViews];
              return (
                <button
                  type="button"
                  class="views-tier-btn w-full text-left p-4 rounded-lg border border-gray-700 hover:border-gray-600 hover:bg-n8n-darker/50 transition-all"
                  data-tier={tier.tier}
                  style={`border-left: 4px solid ${tier.color};`}
                >
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-white">{tier.label}</div>
                      <div class="text-sm text-gray-400">
                        {tier.value} template{tier.value !== 1 ? 's' : ''}
                      </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 transition-transform tier-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      </div>

      <!-- Expandable Template Lists -->
      {viewsData.map((tier) => {
        const templates = templatesByViews[tier.tier as keyof typeof templatesByViews];
        return (
          <div
            id={`tier-${tier.tier}`}
            class="tier-templates hidden mt-6 card"
            data-tier={tier.tier}
          >
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-semibold text-white" style={`color: ${tier.color};`}>
                {tier.label} Templates ({templates.length})
              </h4>
              <button type="button" class="tier-close-btn text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {templates.length > 0 ? (
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                {templates.map((template) => (
                  <a
                    href={n8nUrls.workflow(template.id)}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-3 p-3 rounded-lg bg-n8n-darker/50 hover:bg-n8n-darker transition-colors"
                  >
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-white text-sm truncate" title={template.name}>
                        {template.name}
                      </div>
                      <div class="text-xs text-gray-400">
                        @{template.username} Â· {template.nodeCount} nodes
                      </div>
                    </div>
                    <div class="text-sm text-gray-300 flex-shrink-0">
                      {formatNumber(template.totalViews)} views
                    </div>
                  </a>
                ))}
              </div>
            ) : (
              <p class="text-gray-500 text-center py-4">No templates in this tier</p>
            )}
          </div>
        );
      })}
    </section>

    <!-- Link to explore templates -->
    <div class="text-center mt-8">
      <p class="text-gray-400 mb-4">
        Want to explore individual templates?
      </p>
      <a
        href={n8nUrls.workflows()}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-6 py-3 bg-n8n-primary text-white rounded-lg font-medium hover:bg-n8n-primary/90 transition-colors"
      >
        Browse Templates on n8n.io
      </a>
    </div>

    <!-- Note -->
    <p class="text-sm text-gray-500 text-center mt-8">
      Complete data from n8n.io API. Trending sample analysis based on 100 templates.
    </p>
  </div>
</BaseLayout>

<script define:vars={{ viewsData, complexityData }}>
  window.__templateChartData = { viewsData, complexityData };
</script>

<script>
  import { Chart } from '../../lib/utils/chartRegistry';

  interface ChartDataItem {
    label: string;
    value: number;
    color: string;
  }

  interface ComplexityItem {
    label: string;
    count: number;
  }

  function initCharts() {
    const data = (window as any).__templateChartData;
    if (!data) return;

    const { viewsData, complexityData } = data as {
      viewsData: ChartDataItem[];
      complexityData: ComplexityItem[];
    };

    // Map tier labels to tier keys
    const tierMap: Record<string, string> = {
      'Viral (100K+)': 'viral',
      'Popular (10K-100K)': 'popular',
      'Growing (1K-10K)': 'growing',
      'New (<1K)': 'new',
    };

    // Function to show/hide tier templates
    function showTier(tier: string) {
      // Hide all tier template sections
      document.querySelectorAll('.tier-templates').forEach(el => {
        el.classList.add('hidden');
      });

      // Show the selected tier
      const tierEl = document.getElementById(`tier-${tier}`);
      if (tierEl) {
        tierEl.classList.remove('hidden');
        tierEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Update button states
      document.querySelectorAll('.views-tier-btn').forEach(btn => {
        const btnTier = btn.getAttribute('data-tier');
        const chevron = btn.querySelector('.tier-chevron');
        if (btnTier === tier) {
          btn.classList.add('ring-2', 'ring-n8n-primary');
          chevron?.classList.add('rotate-180');
        } else {
          btn.classList.remove('ring-2', 'ring-n8n-primary');
          chevron?.classList.remove('rotate-180');
        }
      });
    }

    function hideTier(tier: string) {
      const tierEl = document.getElementById(`tier-${tier}`);
      if (tierEl) {
        tierEl.classList.add('hidden');
      }

      // Reset button state
      document.querySelectorAll(`.views-tier-btn[data-tier="${tier}"]`).forEach(btn => {
        btn.classList.remove('ring-2', 'ring-n8n-primary');
        btn.querySelector('.tier-chevron')?.classList.remove('rotate-180');
      });
    }

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Views Distribution Chart
    const viewsCanvas = document.getElementById('views-chart') as HTMLCanvasElement;
    if (viewsCanvas) {
      const viewsChart = new Chart(viewsCanvas, {
        type: 'doughnut',
        data: {
          labels: viewsData.map(d => d.label),
          datasets: [{
            data: viewsData.map(d => d.value),
            backgroundColor: viewsData.map(d => d.color),
            borderColor: '#1a1a2e',
            borderWidth: 2,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          animation: prefersReducedMotion ? false : {
            animateRotate: true,
            animateScale: true,
            duration: 1200,
            easing: 'easeOutQuart',
          },
          onClick: (_event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = viewsData[index]?.label;
              const tier = tierMap[label];
              if (tier) {
                showTier(tier);
              }
            }
          },
          onHover: (event: any, elements) => {
            const target = event.native?.target as HTMLElement;
            if (target) {
              target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: '#9ca3af', padding: 12, usePointStyle: true },
              onClick: (_e, legendItem, legend) => {
                const label = legendItem.text;
                const tier = tierMap[label];
                if (tier) {
                  showTier(tier);
                }
              },
            },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: {
                afterLabel: () => 'Click to view templates',
              },
            },
          },
        },
      });
    }

    // Tier button click handlers
    document.querySelectorAll('.views-tier-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tier = btn.getAttribute('data-tier');
        if (tier) {
          const tierEl = document.getElementById(`tier-${tier}`);
          if (tierEl?.classList.contains('hidden')) {
            showTier(tier);
          } else {
            hideTier(tier);
          }
        }
      });
    });

    // Close button handlers
    document.querySelectorAll('.tier-close-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tierEl = btn.closest('.tier-templates');
        const tier = tierEl?.getAttribute('data-tier');
        if (tier) {
          hideTier(tier);
        }
      });
    });

    // Complexity Distribution Chart - Bar chart showing node counts
    const complexityCanvas = document.getElementById('complexity-chart') as HTMLCanvasElement;
    if (complexityCanvas && complexityData.length > 0) {
      // Generate gradient colors from teal to pink
      const colors = complexityData.map((_, i) => {
        const ratio = i / (complexityData.length - 1);
        // Gradient from teal (#4bc0c0) through yellow (#ffce56) to pink (#ff6384)
        if (ratio < 0.5) {
          return `hsl(${174 - ratio * 100}, 70%, 55%)`;
        } else {
          return `hsl(${74 - (ratio - 0.5) * 148}, 80%, 60%)`;
        }
      });

      new Chart(complexityCanvas, {
        type: 'bar',
        data: {
          labels: complexityData.map(d => d.label),
          datasets: [{
            label: 'Templates',
            data: complexityData.map(d => d.count),
            backgroundColor: colors,
            borderColor: '#1a1a2e',
            borderWidth: 1,
            borderRadius: 4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: prefersReducedMotion ? false : {
            duration: 1000,
            easing: 'easeOutQuart',
            delay: (context) => context.dataIndex * 50,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: {
                label: (ctx) => `${ctx.parsed.y.toLocaleString()} templates`,
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Nodes per template',
                color: '#6b7280',
              },
              grid: { display: false },
              ticks: { color: '#6b7280' },
            },
            y: {
              title: {
                display: true,
                text: 'Templates',
                color: '#6b7280',
              },
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#6b7280' },
              beginAtZero: true,
            },
          },
        },
      });
    }

  }

  // Initialize charts with viewport detection for animations
  function initChartsWithAnimation() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Observe the views chart section
    const viewsCanvas = document.getElementById('views-chart');
    const complexityCanvas = document.getElementById('complexity-chart');

    if (viewsCanvas || complexityCanvas) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              initCharts();
              observer.disconnect();
            }
          });
        },
        {
          threshold: 0.2,
          rootMargin: '50px',
        }
      );

      if (viewsCanvas) observer.observe(viewsCanvas.closest('.card') || viewsCanvas);
      if (complexityCanvas) observer.observe(complexityCanvas.closest('.card') || complexityCanvas);
    }

    // Initialize AI bar animations
    initAIBarAnimations(prefersReducedMotion);
  }

  function initAIBarAnimations(prefersReducedMotion: boolean) {
    const section = document.querySelector('.ai-templates-section');
    if (!section) return;

    if (prefersReducedMotion) {
      section.classList.add('is-visible');
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            section.classList.add('is-visible');

            // Animate percentage displays
            section.querySelectorAll<HTMLElement>('.ai-pct-display').forEach((el, index) => {
              const target = parseFloat(el.dataset.target || '0');
              animatePercentageDisplay(el, target, index * 200);
            });

            observer.unobserve(entry.target);
          }
        });
      },
      {
        threshold: 0.3,
        rootMargin: '0px 0px -50px 0px',
      }
    );

    observer.observe(section);
  }

  function animatePercentageDisplay(element: HTMLElement, target: number, delay: number) {
    const duration = 1200;
    const startTime = performance.now() + delay;

    element.textContent = '0%';

    function easeOutQuart(t: number): number {
      return 1 - Math.pow(1 - t, 4);
    }

    function update(currentTime: number) {
      if (currentTime < startTime) {
        requestAnimationFrame(update);
        return;
      }

      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easedProgress = easeOutQuart(progress);
      const currentValue = Math.round(target * easedProgress);

      element.textContent = currentValue + '%';

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }

    requestAnimationFrame(update);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChartsWithAnimation);
  } else {
    initChartsWithAnimation();
  }

  // Re-init on view transitions
  document.addEventListener('astro:after-swap', initChartsWithAnimation);
</script>

<style>
  /* AI Inline Bar Animations */
  .ai-inline-bar,
  .ai-category-bar {
    width: 0;
    transition: none;
  }

  .ai-category-bar {
    background: var(--bar-color);
  }

  .ai-templates-section.is-visible .ai-inline-bar {
    animation: fillAIBar 1s ease-out forwards;
  }

  .ai-templates-section.is-visible .ai-inline-bar.ai-inline-bar-delay {
    animation-delay: 200ms;
  }

  .ai-templates-section.is-visible .ai-category-bar {
    animation: fillAIBar 0.8s ease-out forwards;
    animation-delay: var(--bar-delay);
  }

  @keyframes fillAIBar {
    from {
      width: 0;
    }
    to {
      width: var(--target-width);
    }
  }

  /* Reduced motion: show immediately without animation */
  @media (prefers-reduced-motion: reduce) {
    .ai-inline-bar,
    .ai-category-bar {
      animation: none !important;
      width: var(--target-width) !important;
    }
  }
</style>
