---
import BaseLayout from '@/layouts/BaseLayout.astro';
import TemplatesHistoryChart from '@/components/charts/TemplatesHistoryChart.astro';
import CategoryTreemapChart from '@/components/charts/CategoryTreemapChart.astro';
import { fetchTemplateAnalytics } from '@/lib/api/n8n';
import { formatNumber } from '@/lib/utils/formatters';
import { readFileSync } from 'fs';
import { join } from 'path';

// Fetch comprehensive analytics
const analytics = await fetchTemplateAnalytics();

// Load complete template data (fetched weekly)
let allTemplatesData: any = null;
try {
  const dataPath = join(process.cwd(), 'public', 'data', 'all-templates-data.json');
  allTemplatesData = JSON.parse(readFileSync(dataPath, 'utf-8'));
} catch (e) {
  console.warn('all-templates-data.json not found, using sample data');
}

// Sort categories by count
const sortedCategories = [...analytics.categories].sort((a, b) => b.count - a.count);

// Prepare chart data
const viewsData = [
  { label: 'Viral (100K+)', value: analytics.viewsDistribution.viral, color: '#ff6384', tier: 'viral' },
  { label: 'Popular (10K-100K)', value: analytics.viewsDistribution.popular, color: '#36a2eb', tier: 'popular' },
  { label: 'Growing (1K-10K)', value: analytics.viewsDistribution.growing, color: '#ffce56', tier: 'growing' },
  { label: 'New (<1K)', value: analytics.viewsDistribution.new, color: '#4bc0c0', tier: 'new' },
];

// Templates by views tier (for expandable sections)
const templatesByViews = analytics.templatesByViews;
const topTemplatesByViews = analytics.topTemplatesByViews;

// Use complete data for complexity if available, otherwise fall back to sample
const complexityData = allTemplatesData?.complexity?.distribution || analytics.nodeCountBreakdown.map(n => ({
  label: n.nodes,
  count: n.count,
}));

// Creation timeline from complete data
const creationTimeline = allTemplatesData?.timeline?.monthly || [];

// AI categories breakdown for horizontal bar chart
const aiCategoriesData = analytics.aiStats.aiCategories;

const nodeCategoryData = analytics.nodeCategories.slice(0, 10).map(c => ({
  name: c.value,
  count: c.count,
}));

// Complete data stats
const hasCompleteData = !!allTemplatesData;
const completeDataStats = allTemplatesData ? {
  totalCreators: allTemplatesData.creators.total,
  uniqueNodes: allTemplatesData.nodes.unique,
  avgComplexity: allTemplatesData.complexity.average,
  medianComplexity: allTemplatesData.complexity.median,
  lastUpdated: allTemplatesData.lastUpdated,
} : null;
---

<BaseLayout title="Template Statistics" description="Comprehensive statistics and insights for n8n workflow templates">
  <div class="container-narrow py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Template Statistics</h1>
      <p class="text-gray-400">
        Comprehensive insights into the n8n workflow template ecosystem
      </p>
    </div>

    <!-- Overview Stats -->
    <section class="mb-12">
      <div class="grid grid-cols-3 gap-4">
        <div class="card text-center">
          <div class="text-3xl font-bold text-n8n-primary mb-1">
            {formatNumber(analytics.totalWorkflows)}
          </div>
          <div class="text-sm text-gray-400">Total Templates</div>
        </div>
        <div class="card text-center">
          <div class="text-3xl font-bold text-purple-400 mb-1">
            {completeDataStats?.uniqueNodes || analytics.topNodes.length}
          </div>
          <div class="text-sm text-gray-400">Unique Nodes Used</div>
        </div>
        <div class="card text-center">
          <div class="text-3xl font-bold text-cyan-400 mb-1">
            {formatNumber(completeDataStats?.totalCreators || 0)}
          </div>
          <div class="text-sm text-gray-400">Template Creators</div>
        </div>
      </div>
    </section>

    <!-- Growth Chart -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-4">Template Growth Over Time</h2>
      <p class="text-gray-400 mb-6">
        Track how the template library grows. Historical data builds daily.
      </p>
      <TemplatesHistoryChart />
    </section>

    <!-- AI Dominance - uses complete API data -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">AI Template Dominance</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex flex-col justify-center">
          <div class="text-6xl font-bold text-purple-400 mb-2">
            {analytics.aiStats.aiPercentage}%
          </div>
          <div class="text-xl text-gray-300 mb-4">of category assignments are AI-related</div>
          <p class="text-gray-400 mb-4">
            AI, Multimodal AI, AI Summarization, and AI Chatbot categories represent
            a major portion of template classifications, reflecting the strong focus
            on AI automation in the n8n ecosystem.
          </p>
          <p class="text-sm text-gray-500">
            Note: Templates can have multiple categories, so totals may exceed 100%.
          </p>
        </div>
        <div class="card">
          <h4 class="text-lg font-semibold text-white mb-4">AI Category Breakdown</h4>
          <div class="space-y-3">
            {analytics.aiStats.aiCategories.map((cat, index) => {
              const maxCount = analytics.aiStats.aiCategories[0]?.count || 1;
              const percentage = (cat.count / maxCount) * 100;
              const colors = ['#9966ff', '#b366ff', '#cc99ff', '#7733ff'];
              return (
                <div class="flex items-center gap-4">
                  <div class="w-32 text-sm text-gray-300 truncate" title={cat.value}>
                    {cat.value}
                  </div>
                  <div class="flex-1 h-6 bg-n8n-darker rounded overflow-hidden">
                    <div
                      class="h-full rounded transition-all duration-500"
                      style={`width: ${percentage}%; background-color: ${colors[index % colors.length]};`}
                    ></div>
                  </div>
                  <div class="w-16 text-right text-sm text-gray-400">
                    {formatNumber(cat.count)}
                  </div>
                </div>
              );
            })}
          </div>
          <div class="mt-4 pt-4 border-t border-gray-700">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400">Total AI category assignments:</span>
              <span class="text-purple-400 font-bold">{formatNumber(analytics.aiStats.aiCategoryCount)}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category Breakdown -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Templates by Category</h2>
      <p class="text-gray-400 mb-4">
        Rectangle size represents the number of templates in each category.
        <span class="text-n8n-primary">Click any category to browse templates on n8n.io.</span>
      </p>
      <CategoryTreemapChart data={sortedCategories.map(c => ({ name: c.value, count: c.count }))} />
    </section>

    <!-- Trending Creators -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Trending Template Creators</h2>
          <p class="text-gray-400 mt-1">
            Most active contributors among trending templates
          </p>
        </div>
        <a
          href="https://n8n.io/creators"
          target="_blank"
          rel="noopener noreferrer"
          class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
        >
          View all creators &rarr;
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {analytics.topCreators.slice(0, 10).map((creator, index) => (
          <a
            href={`https://n8n.io/creators/${creator.username}`}
            target="_blank"
            rel="noopener noreferrer"
            class="card flex items-center gap-3 hover:bg-n8n-darker/50 transition-colors"
          >
            <div class={`text-xl font-bold w-8 ${index < 3 ? 'text-n8n-primary' : 'text-gray-500'}`}>
              #{index + 1}
            </div>
            {creator.avatar ? (
              <img
                src={creator.avatar}
                alt={creator.name}
                class="w-10 h-10 rounded-full bg-n8n-darker"
                loading="lazy"
              />
            ) : (
              <div class="w-10 h-10 rounded-full bg-n8n-darker flex items-center justify-center text-gray-500">
                <span class="text-lg">{creator.name.charAt(0).toUpperCase()}</span>
              </div>
            )}
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-medium text-white truncate">{creator.name}</span>
                {creator.verified && (
                  <span class="text-blue-400 text-xs" title="Verified Creator">âœ“</span>
                )}
              </div>
              <div class="text-sm text-gray-400">@{creator.username}</div>
            </div>
            <div class="text-right text-sm">
              <div class="text-white">
                <span class="font-bold text-n8n-primary">{creator.templateCount}</span>
                <span class="text-gray-400"> of {creator.totalTemplates} trending</span>
              </div>
              <div class="text-gray-500">{formatNumber(creator.totalViews)} views</div>
            </div>
          </a>
        ))}
      </div>
      <p class="text-sm text-gray-500 mt-4">
        Ranked by presence in trending templates. Click a creator to see their full profile.
      </p>
    </section>

    <!-- Most Used Nodes -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Used Nodes in Templates</h2>
          <p class="text-gray-400 mt-1">
            The most popular nodes across all workflow templates.
          </p>
        </div>
        <a
          href="/nodes"
          class="text-n8n-primary hover:text-n8n-primary/80 text-sm font-medium transition-colors"
        >
          View all nodes &rarr;
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
        {analytics.topNodes.slice(0, 10).map((node, index) => (
          <div class="card py-3 px-4 flex items-center gap-3">
            <div class={`text-lg font-bold ${index < 3 ? 'text-n8n-primary' : 'text-gray-500'}`}>
              #{index + 1}
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-white text-sm truncate" title={node.value}>
                {node.value}
              </div>
              <div class="text-xs text-gray-400">
                {formatNumber(node.count)} templates
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Workflow Complexity - Complete Data -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Workflow Complexity</h2>
          <p class="text-gray-400 mt-1">
            Distribution of nodes per template across all {formatNumber(analytics.totalWorkflows)} templates
          </p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">
            Average: <span class="text-white font-medium">{completeDataStats?.avgComplexity || 4} nodes</span>
          </div>
          <div class="text-sm text-gray-400">
            Median: <span class="text-white font-medium">{completeDataStats?.medianComplexity || 4} nodes</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="relative" style="height: 300px;">
          <canvas id="complexity-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Template Creation Timeline - Complete Data -->
    {creationTimeline.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-white mb-4">Template Creation Timeline</h2>
        <p class="text-gray-400 mb-6">
          Monthly breakdown of template submissions since {creationTimeline[0]?.month || '2019'}
        </p>
        <div class="card">
          <div class="relative" style="height: 300px;">
            <canvas id="timeline-chart"></canvas>
          </div>
        </div>
      </section>
    )}

    <!-- Trending Templates Sample Analysis -->
    <section class="mb-12">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-white mb-2">Trending Templates Analysis</h2>
        <p class="text-gray-400">
          Insights from the top 100 trending templates. This sample shows what makes popular templates successful.
        </p>
      </div>

      <div class="card">
        <h3 class="text-lg font-semibold text-white mb-2">Views Distribution</h3>
        <p class="text-gray-500 text-sm mb-4">
          How views are distributed among trending templates
        </p>
        <div class="relative" style="height: 280px;">
          <canvas id="views-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Link to explore templates -->
    <div class="text-center mt-8">
      <p class="text-gray-400 mb-4">
        Want to explore individual templates?
      </p>
      <a
        href="https://n8n.io/workflows"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-6 py-3 bg-n8n-primary text-white rounded-lg font-medium hover:bg-n8n-primary/90 transition-colors"
      >
        Browse Templates on n8n.io
      </a>
    </div>

    <!-- Note -->
    <p class="text-sm text-gray-500 text-center mt-8">
      Complete data from n8n.io API. Trending sample analysis based on 100 templates.
    </p>
  </div>
</BaseLayout>

<script define:vars={{ viewsData, complexityData, creationTimeline }}>
  window.__templateChartData = { viewsData, complexityData, creationTimeline };
</script>

<script>
  import Chart from 'chart.js/auto';

  interface ChartDataItem {
    label: string;
    value: number;
    color: string;
  }

  interface ComplexityItem {
    label: string;
    count: number;
  }

  interface TimelineItem {
    month: string;
    count: number;
    cumulative: number;
  }

  function initCharts() {
    const data = (window as any).__templateChartData;
    if (!data) return;

    const { viewsData, complexityData, creationTimeline } = data as {
      viewsData: ChartDataItem[];
      complexityData: ComplexityItem[];
      creationTimeline: TimelineItem[];
    };

    // Views Distribution Chart
    const viewsCanvas = document.getElementById('views-chart') as HTMLCanvasElement;
    if (viewsCanvas) {
      new Chart(viewsCanvas, {
        type: 'doughnut',
        data: {
          labels: viewsData.map(d => d.label),
          datasets: [{
            data: viewsData.map(d => d.value),
            backgroundColor: viewsData.map(d => d.color),
            borderColor: '#1a1a2e',
            borderWidth: 2,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: '#9ca3af', padding: 12, usePointStyle: true },
            },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
            },
          },
        },
      });
    }

    // Complexity Distribution Chart - Bar chart showing node counts
    const complexityCanvas = document.getElementById('complexity-chart') as HTMLCanvasElement;
    if (complexityCanvas && complexityData.length > 0) {
      // Generate gradient colors from teal to pink
      const colors = complexityData.map((_, i) => {
        const ratio = i / (complexityData.length - 1);
        // Gradient from teal (#4bc0c0) through yellow (#ffce56) to pink (#ff6384)
        if (ratio < 0.5) {
          return `hsl(${174 - ratio * 100}, 70%, 55%)`;
        } else {
          return `hsl(${74 - (ratio - 0.5) * 148}, 80%, 60%)`;
        }
      });

      new Chart(complexityCanvas, {
        type: 'bar',
        data: {
          labels: complexityData.map(d => d.label),
          datasets: [{
            label: 'Templates',
            data: complexityData.map(d => d.count),
            backgroundColor: colors,
            borderColor: '#1a1a2e',
            borderWidth: 1,
            borderRadius: 4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: {
                label: (ctx) => `${ctx.parsed.y.toLocaleString()} templates`,
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Nodes per template',
                color: '#6b7280',
              },
              grid: { display: false },
              ticks: { color: '#6b7280' },
            },
            y: {
              title: {
                display: true,
                text: 'Templates',
                color: '#6b7280',
              },
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#6b7280' },
              beginAtZero: true,
            },
          },
        },
      });
    }

    // Creation Timeline Chart
    const timelineCanvas = document.getElementById('timeline-chart') as HTMLCanvasElement;
    if (timelineCanvas && creationTimeline.length > 0) {
      // Format month labels (YYYY-MM -> MMM YY)
      const formatMonth = (m: string) => {
        const [year, month] = m.split('-');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${monthNames[parseInt(month) - 1]} ${year.slice(2)}`;
      };

      new Chart(timelineCanvas, {
        type: 'bar',
        data: {
          labels: creationTimeline.map(d => formatMonth(d.month)),
          datasets: [{
            label: 'New Templates',
            data: creationTimeline.map(d => d.count),
            backgroundColor: '#ff6b9d',
            borderColor: '#ff6b9d',
            borderWidth: 0,
            borderRadius: 2,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
              callbacks: {
                label: (ctx) => {
                  const item = creationTimeline[ctx.dataIndex];
                  return [
                    `${ctx.parsed.y.toLocaleString()} new templates`,
                    `Total: ${item.cumulative.toLocaleString()}`,
                  ];
                },
              },
            },
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: '#6b7280',
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 24,
              },
            },
            y: {
              title: {
                display: true,
                text: 'New Templates',
                color: '#6b7280',
              },
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#6b7280' },
              beginAtZero: true,
            },
          },
        },
      });
    }

  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCharts);
  } else {
    initCharts();
  }
</script>
