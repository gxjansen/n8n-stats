---
import BaseLayout from '@/layouts/BaseLayout.astro';
import NodeTreemapChart from '@/components/charts/NodeTreemapChart.astro';
import CategoryNodesTable from '@/components/CategoryNodesTable.astro';
import StatCard from '@/components/cards/StatCard.astro';
import SecondaryCTA from '@/components/cards/SecondaryCTA.astro';
import DataSourcesSection from '@/components/DataSourcesSection.astro';
import SourceInfo from '@/components/SourceInfo.astro';
import { fetchTemplates, aggregateNodeUsage } from '@/lib/api/n8n';
import { formatNumber, getNodeIntegrationUrl, getNodePageUrl } from '@/lib/utils/formatters';
import { NODE_CATEGORY_COLORS, NODE_CATEGORY_ORDER } from '@/lib/utils/colors';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load community nodes data (fetched weekly via fetch-community-nodes.ts)
interface CommunityPackage {
  name: string;
  description: string;
  version: string;
  author: string;
  downloadsWeekly: number;
  downloadsMonthly: number;
  score: number;
  lastUpdated: string;
  repository?: string;
  category: string;
  keywords: string[];
}

interface CommunityNodesData {
  lastUpdated: string;
  totalPackages: number;
  totalDownloadsWeekly: number;
  totalDownloadsMonthly: number;
  byCategory: Record<string, number>;
  packages: CommunityPackage[];
}

let communityNodesData: CommunityNodesData | null = null;
try {
  const communityPath = join(process.cwd(), 'public', 'data', 'community-nodes.json');
  if (existsSync(communityPath)) {
    communityNodesData = JSON.parse(readFileSync(communityPath, 'utf-8'));
  }
} catch (e) {
  console.warn('community-nodes.json not found, community section unavailable');
}

// Load complete node data (fetched weekly via fetch-all-nodes.ts)
interface NodeData {
  type: string;
  displayName: string;
  category: string;
  count: number;
  percentage: number;
}

interface AllNodesData {
  lastUpdated: string;
  fetchDuration: number;
  totalTemplates: number;
  nodes: {
    total: number;
    withData: number;
    byCategory: Record<string, NodeData[]>;
    all: NodeData[];
  };
}

// Weighted node scores from n8n Arena
interface WeightedNodeScore {
  type: string;
  weightedScore: number;
  templateCount: number;
  totalNodeUsages: number;
  avgInsertersPerTemplate: number;
}

interface WeightedNodesData {
  lastUpdated: string;
  totalWorkflows: number;
  totalInserters: number;
  nodes: WeightedNodeScore[];
}

let allNodesData: AllNodesData | null = null;
try {
  const dataPath = join(process.cwd(), 'public', 'data', 'all-nodes-data.json');
  allNodesData = JSON.parse(readFileSync(dataPath, 'utf-8'));
} catch (e) {
  console.warn('all-nodes-data.json not found, using fallback data');
}

// Load weighted node scores from n8n Arena
let weightedNodesData: WeightedNodesData | null = null;
try {
  const weightedPath = join(process.cwd(), 'public', 'data', 'external', 'n8narena-weighted-nodes.json');
  if (existsSync(weightedPath)) {
    weightedNodesData = JSON.parse(readFileSync(weightedPath, 'utf-8'));
  }
} catch (e) {
  console.warn('n8narena-weighted-nodes.json not found, weighted scores unavailable');
}

// Create a map of weighted scores by node type for quick lookup
const weightedScoresMap = new Map<string, WeightedNodeScore>();
if (weightedNodesData?.nodes) {
  for (const node of weightedNodesData.nodes) {
    weightedScoresMap.set(node.type, node);
  }
}

// Load LLM models data from templates-raw-log
interface LLMModel {
  name: string;
  count: number;
}
let llmModels: LLMModel[] = [];
try {
  const rawLogPath = join(process.cwd(), 'public', 'data', 'templates-raw-log.json');
  if (existsSync(rawLogPath)) {
    const rawLog = JSON.parse(readFileSync(rawLogPath, 'utf-8'));
    const latestEntry = rawLog.entries?.[rawLog.entries.length - 1];
    llmModels = latestEntry?.llmModels || [];
  }
} catch (e) {
  console.warn('Could not load LLM models data');
}

// Calculate LLM statistics
const totalLLMTemplates = llmModels.reduce((sum, m) => sum + m.count, 0);
const topLLM = llmModels[0];
const openSourceLLMs = llmModels.filter(m =>
  ['Ollama Chat Model', 'Hugging Face Chat Model'].includes(m.name)
);
const cloudLLMs = llmModels.filter(m =>
  !['Ollama Chat Model', 'Hugging Face Chat Model'].includes(m.name)
);

// LLM brand colors
const llmColors: Record<string, string> = {
  'OpenAI Chat Model': '#10a37f',
  'Google Gemini Chat Model': '#4285f4',
  'OpenRouter Chat Model': '#6366f1',
  'Anthropic Chat Model': '#d4a574',
  'Azure OpenAI Chat Model': '#0078d4',
  'Groq Chat Model': '#f55036',
  'Ollama Chat Model': '#ffffff',
  'Mistral Cloud Chat Model': '#ff7000',
  'DeepSeek Chat Model': '#4d6bfe',
  'xAI Grok Chat Model': '#1da1f2',
  'Cohere Chat Model': '#39594d',
  'Hugging Face Chat Model': '#ffcc00',
};

function getLLMColor(name: string): string {
  return llmColors[name] || '#6b7280';
}

function getShortLLMName(name: string): string {
  return name
    .replace(' Chat Model', '')
    .replace('Google ', '')
    .replace(' Cloud', '');
}

// Also fetch trending templates for comparison
const { workflows: trendingWorkflows } = await fetchTemplates({ rows: 100 });
const trendingNodeUsage = aggregateNodeUsage(trendingWorkflows);

// Use complete data if available
const hasCompleteData = !!allNodesData?.nodes?.all;
const hasWeightedData = !!weightedNodesData?.nodes?.length;

// Get node data from all-nodes-data.json with weighted scores merged
const nodeUsage = hasCompleteData
  ? allNodesData.nodes.all.filter(n => n.count > 0).map(n => {
      const weighted = weightedScoresMap.get(n.type);
      return {
        name: n.type,
        displayName: n.displayName,
        count: n.count,
        percentage: n.percentage,
        category: n.category,
        // Weighted data from n8n Arena
        weightedScore: weighted?.weightedScore || 0,
        avgInserters: weighted?.avgInsertersPerTemplate || 0,
      };
    })
  : trendingNodeUsage.map(n => ({ ...n, category: 'Other', weightedScore: 0, avgInserters: 0 }));

// Sort by weighted score when available, otherwise by template count
const nodeUsageSorted = hasWeightedData
  ? [...nodeUsage].sort((a, b) => b.weightedScore - a.weightedScore)
  : nodeUsage;

const totalTemplates = allNodesData?.totalTemplates || 100;
const uniqueNodes = allNodesData?.nodes?.withData || nodeUsage.length;
const totalNodes = allNodesData?.nodes?.total || uniqueNodes;

// Calculate total node usages
const totalNodeUsages = nodeUsage.reduce((sum: number, n: any) => sum + n.count, 0);

// Calculate total weighted score (estimated deployments)
const totalWeightedScore = nodeUsage.reduce((sum: number, n: any) => sum + n.weightedScore, 0);
const totalInserters = weightedNodesData?.totalInserters || 0;

// Use colorblind-friendly palette from shared utility
const categoryOrder = NODE_CATEGORY_ORDER;
const categoryColors = NODE_CATEGORY_COLORS;

// Group nodes by category (using pre-categorized data) with weighted scores
const nodesByCategory: Record<string, typeof nodeUsage> = {};
if (hasCompleteData && allNodesData?.nodes?.byCategory) {
  for (const [category, nodes] of Object.entries(allNodesData.nodes.byCategory)) {
    const filteredNodes = nodes
      .filter((n: NodeData) => n.count > 0)
      .map((n: NodeData) => {
        const weighted = weightedScoresMap.get(n.type);
        return {
          name: n.type,
          displayName: n.displayName,
          count: n.count,
          percentage: n.percentage,
          category: n.category,
          weightedScore: weighted?.weightedScore || 0,
          avgInserters: weighted?.avgInsertersPerTemplate || 0,
        };
      })
      // Sort by weighted score within each category
      .sort((a, b) => b.weightedScore - a.weightedScore);
    if (filteredNodes.length > 0) {
      nodesByCategory[category] = filteredNodes;
    }
  }
} else {
  // Fallback: group all nodes under 'Other'
  nodesByCategory['Other'] = nodeUsage;
}

// Prepare treemap data (top 50 nodes by weighted score)
const treemapData = nodeUsageSorted.slice(0, 50).map((node: any) => ({
  name: node.displayName,
  count: hasWeightedData ? node.weightedScore : node.count,
  category: node.category,
}));

// Get trending-specific nodes (nodes that appear more in trending than overall)
const getTrendingBoost = () => {
  if (!hasCompleteData) return [];

  const overallMap = new Map(nodeUsage.map((n: any) => [n.displayName, n.percentage || 0]));

  return trendingNodeUsage
    .slice(0, 30)
    .map(n => {
      const overallPct = overallMap.get(n.displayName) || 0;
      const trendingPct = (n.count / 100) * 100; // percentage in trending
      return {
        ...n,
        trendingPct,
        overallPct,
        boost: trendingPct - overallPct,
      };
    })
    .filter(n => n.boost > 5) // Nodes that are 5%+ more popular in trending
    .sort((a, b) => b.boost - a.boost)
    .slice(0, 10);
};

const trendingBoostNodes = getTrendingBoost();

// Get unused nodes (0 templates)
const unusedNodes = hasCompleteData
  ? allNodesData.nodes.all
      .filter((n: NodeData) => n.count === 0)
      .map((n: NodeData) => ({
        displayName: n.displayName,
        category: n.category,
        type: n.type,
      }))
  : [];

// Format last updated date
const lastUpdated = allNodesData?.lastUpdated
  ? new Date(allNodesData.lastUpdated).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    })
  : null;
---

<BaseLayout title="Node Statistics" description="Most popular nodes in n8n workflow templates">
  <div class="container-narrow py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Node Statistics</h1>
      <p class="text-gray-400">
        Explore {formatNumber(totalNodes + (communityNodesData?.totalPackages || 0))} nodes and integrations in the n8n ecosystem
      </p>
    </div>

    <!-- Quick Navigation -->
    <div class="flex flex-wrap gap-3 mb-8">
      <a href="#official-nodes" class="px-4 py-2 bg-cyan-500/10 text-cyan-400 border border-cyan-500/20 rounded-lg hover:bg-cyan-500/20 transition-colors text-sm font-medium">
        Official Nodes ({formatNumber(totalNodes)})
      </a>
      {communityNodesData && (
        <a href="#community-nodes" class="px-4 py-2 bg-purple-500/10 text-purple-400 border border-purple-500/20 rounded-lg hover:bg-purple-500/20 transition-colors text-sm font-medium">
          Community Packages ({formatNumber(communityNodesData.totalPackages)})
        </a>
      )}
      <a href="#llm-models" class="px-4 py-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-lg hover:bg-emerald-500/20 transition-colors text-sm font-medium">
        LLM Providers
      </a>
    </div>

    <!-- Official vs Community Explainer -->
    {communityNodesData && (
      <div class="card p-6 border-gray-700 mb-8">
        <div class="flex items-start gap-3">
          <div class="text-gray-400 mt-0.5">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h3 class="text-white font-semibold mb-2">Official vs Community Nodes</h3>
            <p class="text-gray-400 text-sm leading-relaxed">
              <span class="inline-flex items-center gap-1"><span class="px-1.5 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span> nodes ({formatNumber(totalNodes)})</span> are maintained by n8n and available on both cloud and self-hosted instances.
              <span class="inline-flex items-center gap-1"><span class="px-1.5 py-0.5 bg-purple-500/10 text-purple-400 text-xs font-medium rounded">Community</span> packages ({formatNumber(communityNodesData.totalPackages)})</span> are built by the community and available for self-hosted installations.
              Some popular community nodes are verified and available on n8n Cloud through the
              <a href="https://docs.n8n.io/integrations/community-nodes/" target="_blank" rel="noopener" class="text-cyan-400 hover:underline">verified community nodes program</a>.
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Overview Stats -->
    <section class="mb-12">
      <h2 class="text-xl font-semibold text-white mb-4">Ecosystem Overview</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <StatCard
          label="Total Ecosystem"
          value={totalNodes + (communityNodesData?.totalPackages || 0)}
          subtitle="Official + Community"
        />
        <StatCard
          label="Templates Analyzed"
          value={totalTemplates}
          source={{ source: "n8n Templates API", url: "https://api.n8n.io", note: "weekly full scan" }}
        />
        {hasWeightedData ? (
          <StatCard
            label="Template Insertions"
            value={totalInserters}
            source={{ source: "n8n Arena", url: "https://n8narena.com", note: "community project" }}
          />
        ) : (
          <StatCard
            label="Node Usages"
            value={totalNodeUsages}
            source={{ source: "n8n Templates API", url: "https://api.n8n.io", note: "weekly full scan" }}
          />
        )}
        {communityNodesData && (
          <StatCard
            label="Weekly npm Downloads"
            value={communityNodesData.totalDownloadsWeekly}
            subtitle="Community packages"
            source={{ source: "npm Registry", url: "https://www.npmjs.com", note: "top 500 packages" }}
          />
        )}
      </div>
      <!-- Official vs Community breakdown -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          label="Official Nodes"
          value={totalNodes}
          subtitle="n8n maintained"
          source={{ source: "n8n Templates API", url: "https://api.n8n.io", note: "weekly full scan" }}
        />
        <StatCard
          label="Official Categories"
          value={Object.keys(nodesByCategory).length}
          subtitle="n8n maintained"
          source={{ source: "n8n Templates API", url: "https://api.n8n.io", note: "weekly full scan" }}
        />
        {communityNodesData && (
          <>
            <StatCard
              label="Community Packages"
              value={communityNodesData.totalPackages}
              subtitle="Self-hosted"
              source={{ source: "npm Registry", url: "https://www.npmjs.com/search?q=keywords:n8n-community-node-package", note: "weekly scan" }}
            />
            <StatCard
              label="Community Categories"
              value={Object.keys(communityNodesData.byCategory).length}
              subtitle="Inferred from keywords"
              source={{ source: "npm Registry", url: "https://www.npmjs.com", note: "weekly scan" }}
            />
          </>
        )}
      </div>
    </section>

    <!-- Node Usage Treemap (Official) -->
    <section id="official-nodes" class="mb-12 scroll-mt-20">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-2xl font-bold text-white">Node Usage Overview</h2>
        <span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span>
      </div>
      <p class="text-gray-400 mb-6">
        {hasWeightedData
          ? 'Rectangle size represents estimated deployments (weighted by template insertions). Colors indicate category.'
          : 'Rectangle size represents usage frequency across all templates. Colors indicate category.'}
      </p>
      <NodeTreemapChart data={treemapData} source={{ source: hasWeightedData ? "n8n Arena" : "n8n Templates API", url: hasWeightedData ? "https://n8narena.com" : "https://api.n8n.io", note: hasWeightedData ? "community project" : "weekly full scan" }} />
      <div class="flex flex-wrap gap-4 mt-4 text-sm">
        {categoryOrder.filter(cat => nodesByCategory[cat]?.length > 0).map((category) => (
          <span class="flex items-center gap-2">
            <span class="w-3 h-3 rounded" style={`background: ${categoryColors[category]}`}></span>
            {category}
          </span>
        ))}
      </div>
    </section>

    <!-- Top 10 Overall (Official) -->
    <section class="mb-12">
      <div class="flex items-center gap-3 mb-2">
        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
          Top 10 Most Used Nodes
          <SourceInfo
            source={hasWeightedData ? "n8n Arena" : "n8n Templates API"}
            url={hasWeightedData ? "https://n8narena.com" : "https://api.n8n.io"}
            note={hasWeightedData ? "weighted by insertions" : "weekly full scan"}
            position="inline"
          />
        </h2>
        <span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span>
      </div>
      <p class="text-gray-400 mb-6">
        {hasWeightedData
          ? 'Ranked by estimated deployments (node usage weighted by template insertions).'
          : 'Ranked by number of templates using each node.'}
      </p>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        {nodeUsageSorted.slice(0, 10).map((node: any, index: number) => (
          <a
            href={getNodePageUrl(node.displayName)}
            class="card text-center hover:border-n8n-primary transition-colors"
          >
            <div class="text-3xl font-bold text-n8n-primary mb-2">#{index + 1}</div>
            <span class="font-medium text-white">
              {node.displayName}
            </span>
            {hasWeightedData && node.weightedScore > 0 ? (
              <>
                <div class="text-sm text-cyan-400 mt-1">
                  ~{formatNumber(node.weightedScore)} deployments
                </div>
                <div class="text-xs text-gray-500">
                  {formatNumber(node.count)} templates
                </div>
              </>
            ) : (
              <>
                <div class="text-sm text-gray-400 mt-1">
                  {formatNumber(node.count)} templates
                </div>
                {node.percentage && (
                  <div class="text-xs text-gray-500">
                    {node.percentage}% of all
                  </div>
                )}
              </>
            )}
          </a>
        ))}
      </div>
    </section>

    <!-- LLM Models Section -->
    {llmModels.length > 0 && (
      <section id="llm-models" class="mb-12 scroll-mt-20">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            LLM Provider Breakdown
            <SourceInfo source="n8n Templates API" url="https://api.n8n.io" note="updated daily" position="inline" />
          </h2>
          <span class="px-2 py-0.5 bg-emerald-500/10 text-emerald-400 text-xs font-medium rounded">AI</span>
        </div>
        <p class="text-gray-400 mb-6">
          Language model nodes used across {formatNumber(totalLLMTemplates)} AI-powered templates.
        </p>

        <!-- LLM Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="card text-center">
            <div class="text-3xl font-bold text-emerald-400 mb-1">
              {llmModels.length}
            </div>
            <div class="text-sm text-gray-400">LLM Providers</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold text-white mb-1">
              {formatNumber(totalLLMTemplates)}
            </div>
            <div class="text-sm text-gray-400">Templates with LLMs</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold mb-1" style={`color: ${getLLMColor(topLLM?.name || '')}`}>
              {topLLM ? Math.round((topLLM.count / totalLLMTemplates) * 100) : 0}%
            </div>
            <div class="text-sm text-gray-400">{getShortLLMName(topLLM?.name || 'OpenAI')} Dominance</div>
          </div>
          <div class="card text-center">
            <div class="text-3xl font-bold text-gray-400 mb-1">
              {openSourceLLMs.reduce((sum, m) => sum + m.count, 0)}
            </div>
            <div class="text-sm text-gray-400">Self-Hosted (Ollama)</div>
          </div>
        </div>

        <!-- Full LLM Chart -->
        <div class="card p-6 mb-6">
          <h3 class="text-lg font-semibold text-white mb-4">Market Share by Provider</h3>
          <div class="space-y-3">
            {llmModels.map((model, i) => {
              const pct = (model.count / totalLLMTemplates) * 100;
              const maxPct = (llmModels[0]?.count / totalLLMTemplates) * 100;
              const barWidth = (pct / maxPct) * 100;
              const color = getLLMColor(model.name);
              return (
                <div class="group">
                  <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                      <span class="text-gray-500 w-6 text-right">#{i + 1}</span>
                      <span
                        class="w-3 h-3 rounded-full flex-shrink-0"
                        style={`background: ${color}`}
                      />
                      <span class="text-white font-medium">{getShortLLMName(model.name)}</span>
                    </div>
                    <div class="flex items-center gap-4">
                      <span class="text-gray-400">{formatNumber(model.count)} templates</span>
                      <span class="text-white font-semibold w-14 text-right">{pct.toFixed(1)}%</span>
                    </div>
                  </div>
                  <div class="ml-8 h-6 bg-gray-800 rounded overflow-hidden">
                    <div
                      class="h-full rounded transition-all duration-500 group-hover:opacity-80"
                      style={`width: ${barWidth}%; background: ${color}`}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <!-- Cloud vs Open Source Comparison -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Cloud Providers -->
          <div class="card p-6">
            <div class="flex items-center gap-2 mb-4">
              <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
              </svg>
              <h3 class="text-lg font-semibold text-white">Cloud Providers</h3>
            </div>
            <div class="space-y-2">
              {cloudLLMs.slice(0, 6).map((model) => {
                const pct = (model.count / totalLLMTemplates) * 100;
                return (
                  <div class="flex items-center justify-between p-2 rounded bg-gray-800/50">
                    <div class="flex items-center gap-2">
                      <span
                        class="w-2 h-2 rounded-full"
                        style={`background: ${getLLMColor(model.name)}`}
                      />
                      <span class="text-white text-sm">{getShortLLMName(model.name)}</span>
                    </div>
                    <div class="text-sm">
                      <span class="text-gray-400">{formatNumber(model.count)}</span>
                      <span class="text-gray-600 ml-1">({pct.toFixed(1)}%)</span>
                    </div>
                  </div>
                );
              })}
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Total Cloud Usage</span>
                <span class="text-white font-medium">
                  {formatNumber(cloudLLMs.reduce((sum, m) => sum + m.count, 0))} templates
                </span>
              </div>
            </div>
          </div>

          <!-- Open Source / Self-Hosted -->
          <div class="card p-6">
            <div class="flex items-center gap-2 mb-4">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
              </svg>
              <h3 class="text-lg font-semibold text-white">Open Source / Self-Hosted</h3>
            </div>
            {openSourceLLMs.length > 0 ? (
              <div class="space-y-2">
                {openSourceLLMs.map((model) => {
                  const pct = (model.count / totalLLMTemplates) * 100;
                  return (
                    <div class="flex items-center justify-between p-2 rounded bg-gray-800/50">
                      <div class="flex items-center gap-2">
                        <span
                          class="w-2 h-2 rounded-full"
                          style={`background: ${getLLMColor(model.name)}`}
                        />
                        <span class="text-white text-sm">{getShortLLMName(model.name)}</span>
                      </div>
                      <div class="text-sm">
                        <span class="text-gray-400">{formatNumber(model.count)}</span>
                        <span class="text-gray-600 ml-1">({pct.toFixed(1)}%)</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <p class="text-gray-500 text-sm">No open source LLM usage tracked yet.</p>
            )}
            <div class="mt-4 pt-4 border-t border-gray-700">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Total Self-Hosted Usage</span>
                <span class="text-white font-medium">
                  {formatNumber(openSourceLLMs.reduce((sum, m) => sum + m.count, 0))} templates
                </span>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-3">
              Self-hosted options like Ollama let you run models locally without API costs.
            </p>
          </div>
        </div>
      </section>
    )}

    <!-- Trending Boost Section (Official) -->
    {trendingBoostNodes.length > 0 && (
      <section class="mb-12">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            Hot in Trending Templates
            <SourceInfo source="n8n Templates API" url="https://api.n8n.io" note="top 100 trending" position="inline" />
          </h2>
          <span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span>
        </div>
        <p class="text-gray-400 mb-6">
          Nodes that appear more often in the top 100 trending templates compared to all {formatNumber(totalTemplates)} templates.
        </p>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          {trendingBoostNodes.map((node: any) => (
            <a
              href={getNodePageUrl(node.displayName)}
              class="card text-center hover:border-n8n-primary transition-colors"
            >
              <div class="font-medium text-white mb-1">{node.displayName}</div>
              <div class="text-sm">
                <span class="text-green-400">+{node.boost.toFixed(0)}%</span>
                <span class="text-gray-500"> vs overall</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                {node.trendingPct.toFixed(0)}% trending vs {node.overallPct.toFixed(0)}% overall
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- By Category - Compact Table Grid -->
    <!-- Top Nodes by Category (Official) -->
    <section class="mb-12">
      <div class="flex items-center gap-3 mb-2">
        <h2 class="text-2xl font-bold text-white">Top Nodes by Category</h2>
        <span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span>
      </div>
      <p class="text-gray-400 mb-6">
        {hasWeightedData
          ? 'Top 5 nodes in each category, ranked by estimated deployments. Hover over values to see template counts.'
          : 'Top 5 nodes in each category, ranked by template usage. Click any node to view details.'}
      </p>
      <CategoryNodesTable
        data={nodesByCategory}
        categoryOrder={categoryOrder}
        categoryColors={categoryColors}
        nodesPerCategory={5}
        showWeighted={hasWeightedData}
        source={{ source: hasWeightedData ? "n8n Arena" : "n8n Templates API", url: hasWeightedData ? "https://n8narena.com" : "https://api.n8n.io", note: hasWeightedData ? "community project" : "weekly full scan" }}
      />
    </section>

    <!-- Unused Nodes Section (Official) -->
    {unusedNodes.length > 0 && (
      <section class="mb-12">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            Nodes With Zero Usage
            <SourceInfo source="n8n Templates API" url="https://api.n8n.io" note="weekly full scan" position="inline" />
          </h2>
          <span class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 text-xs font-medium rounded">Official</span>
        </div>
        <p class="text-gray-400 mb-6">
          These {unusedNodes.length} nodes don't appear in any of the {formatNumber(totalTemplates)} public templates.
        </p>
        <div class="card p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {unusedNodes.map((node: any) => {
              const color = categoryColors[node.category] || '#7c8798';
              return (
                <a
                  href={getNodePageUrl(node.displayName)}
                  class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/50 hover:bg-gray-800 transition-colors"
                >
                  <span
                    class="w-2 h-2 rounded-full flex-shrink-0"
                    style={`background: ${color}`}
                  />
                  <div class="min-w-0">
                    <div class="text-sm font-medium text-white truncate">
                      {node.displayName}
                    </div>
                    <div class="text-xs text-gray-500">
                      {node.category}
                    </div>
                  </div>
                  <span class="ml-auto text-xs text-gray-600 flex-shrink-0">
                    0 templates
                  </span>
                </a>
              );
            })}
          </div>
          <p class="text-xs text-gray-500 mt-4">
            Some nodes have zero public usage because: they're development tools (Debug),
            redundant with other platforms (Zapier), or only have trigger variants that are tracked separately
            (Typeform, Calendly, Discord action nodes vs their Trigger counterparts).
          </p>
        </div>
      </section>
    )}

    <!-- Weighted Score Explanation -->
    {hasWeightedData && (
      <section class="mb-8">
        <div class="card p-6 border-cyan-500/20">
          <div class="flex items-start gap-3">
            <div class="text-cyan-400 mt-0.5">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-2">Understanding Estimated Deployments</h3>
              <p class="text-gray-400 text-sm leading-relaxed">
                "Estimated deployments" combines how often a node appears in templates with how often those templates
                are actually used (inserted) by the community. A node used once in a highly-adopted template
                (e.g., 5,000 insertions) ranks higher than one appearing in 50 templates with only 1 insertion each.
                This gives a more accurate picture of real-world node usage.
              </p>
              <p class="text-gray-500 text-xs mt-3">
                Template insertion data powered by <a href="https://n8narena.com" class="text-cyan-400 hover:underline" target="_blank" rel="noopener">n8n Arena</a>.
              </p>
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Community Nodes Section -->
    {communityNodesData && (
      <section id="community-nodes" class="mb-12 scroll-mt-20 pt-8 border-t border-gray-800">
        <div class="flex items-center gap-3 mb-2">
          <h2 class="text-2xl font-bold text-white flex items-center gap-2">
            Community Nodes
            <SourceInfo source="npm Registry" url="https://www.npmjs.com/search?q=keywords:n8n-community-node-package" note="weekly scan" position="inline" />
          </h2>
          <span class="px-2 py-0.5 bg-purple-500/10 text-purple-400 text-xs font-medium rounded">Self-Hosted</span>
        </div>
        <p class="text-gray-400 mb-6">
          Community-built node packages from npm. These extend n8n's capabilities for self-hosted installations.
        </p>

        <!-- Community Stats Grid -->
        <div class="grid grid-cols-3 gap-4 mb-8">
          <StatCard
            label="Packages"
            value={communityNodesData.totalPackages}
            subtitle="npm packages"
            source={{ source: "npm Registry", url: "https://www.npmjs.com/search?q=keywords:n8n-community-node-package", note: "weekly scan" }}
          />
          <StatCard
            label="Weekly Downloads"
            value={communityNodesData.totalDownloadsWeekly}
            subtitle="Top 500 packages"
            source={{ source: "npm Registry", url: "https://www.npmjs.com", note: "downloads API" }}
          />
          <StatCard
            label="Categories"
            value={Object.keys(communityNodesData.byCategory).length}
            subtitle="Inferred from keywords"
            source={{ source: "npm Registry", url: "https://www.npmjs.com", note: "weekly scan" }}
          />
        </div>

        <!-- Top Community Packages -->
        <div class="card p-6 mb-8">
          <h3 class="text-lg font-semibold text-white mb-4">Top 20 Community Packages by Downloads</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left text-gray-400 font-medium py-2 pr-4">#</th>
                  <th class="text-left text-gray-400 font-medium py-2 pr-4">Package</th>
                  <th class="text-left text-gray-400 font-medium py-2 pr-4 hidden md:table-cell">Author</th>
                  <th class="text-left text-gray-400 font-medium py-2 pr-4 hidden lg:table-cell">Category</th>
                  <th class="text-right text-gray-400 font-medium py-2">Weekly Downloads</th>
                </tr>
              </thead>
              <tbody>
                {communityNodesData.packages.slice(0, 20).map((pkg, i) => (
                  <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="py-2 pr-4 text-gray-500">#{i + 1}</td>
                    <td class="py-2 pr-4">
                      <a
                        href={`https://www.npmjs.com/package/${pkg.name}`}
                        target="_blank"
                        rel="noopener"
                        class="text-white hover:text-n8n-primary transition-colors"
                      >
                        {pkg.name.replace('n8n-nodes-', '')}
                      </a>
                      <div class="text-xs text-gray-500 truncate max-w-[200px] md:max-w-[300px]">
                        {pkg.description?.slice(0, 60)}{pkg.description && pkg.description.length > 60 ? '...' : ''}
                      </div>
                    </td>
                    <td class="py-2 pr-4 text-gray-400 hidden md:table-cell">{pkg.author}</td>
                    <td class="py-2 pr-4 hidden lg:table-cell">
                      <span class="px-2 py-0.5 bg-gray-800 text-gray-300 text-xs rounded">
                        {pkg.category}
                      </span>
                    </td>
                    <td class="py-2 text-right text-purple-400 font-medium">
                      {formatNumber(pkg.downloadsWeekly)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-center">
            <a
              href="https://www.npmjs.com/search?q=keywords:n8n-community-node-package"
              target="_blank"
              rel="noopener"
              class="text-sm text-purple-400 hover:text-purple-300 transition-colors"
            >
              View all {formatNumber(communityNodesData.totalPackages)} packages on npm &rarr;
            </a>
          </div>
        </div>

        <!-- Category Distribution -->
        <div class="card p-6 mb-8">
          <h3 class="text-lg font-semibold text-white mb-4">Packages by Category</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            {Object.entries(communityNodesData.byCategory)
              .sort((a, b) => b[1] - a[1])
              .map(([category, count]) => {
                const pct = (count / communityNodesData!.totalPackages) * 100;
                return (
                  <div class="p-3 bg-gray-800/50 rounded-lg">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-white font-medium text-sm">{category}</span>
                      <span class="text-gray-400 text-xs">{pct.toFixed(0)}%</span>
                    </div>
                    <div class="text-purple-400 font-bold">{formatNumber(count)}</div>
                    <div class="mt-2 h-1 bg-gray-700 rounded-full overflow-hidden">
                      <div
                        class="h-full bg-purple-500 rounded-full"
                        style={`width: ${pct}%`}
                      />
                    </div>
                  </div>
                );
              })}
          </div>
        </div>
      </section>
    )}

    <!-- Link to integrations -->
    <SecondaryCTA
      title="Explore Integrations"
      description="Browse the full library of n8n nodes and discover new ways to connect your apps."
      actions={[
        {
          label: "Browse All Integrations",
          href: "https://n8n.io/integrations/?utm_source=n8n-stats&utm_medium=referral&utm_campaign=nodes-page",
          variant: "primary",
          external: true,
        },
        {
          label: "Node Documentation",
          href: "https://docs.n8n.io/integrations/builtin/core-nodes/?utm_source=n8n-stats&utm_medium=referral&utm_campaign=nodes-page",
          variant: "outline",
          external: true,
        }
      ]}
    />


    <!-- Data Sources Attribution -->
    <DataSourcesSection sources={[
      { label: "Node usage", source: "n8n Templates API", url: "https://api.n8n.io", note: "weekly full scan" },
      { label: "Insertion metrics", source: "n8n Arena", url: "https://n8narena.com", note: "community project" },
      { label: "Community packages", source: "npm Registry", url: "https://www.npmjs.com", note: "weekly scan" },
    ]} />
  </div>
</BaseLayout>
