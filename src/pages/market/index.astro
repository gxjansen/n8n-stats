---
/**
 * Automation Market Page
 *
 * Compares n8n with other automation platforms across:
 * - GitHub stars (open-source tools)
 * - LinkedIn followers (all platforms)
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import DataSourcesSection from '@/components/DataSourcesSection.astro';
import { formatNumber } from '@/lib/utils/formatters';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load landscape data
const landscapePath = join(process.cwd(), 'public', 'data', 'history', 'landscape.json');
const npmLandscapePath = join(process.cwd(), 'public', 'data', 'history', 'npm-landscape.json');

interface Platform {
  name: string;
  type: 'open-source' | 'closed-source';
  website: string;
  github: string | null;
  linkedin: string | null;
  focus: string;
  selfHostable: boolean;
  founded: number;
}

interface LandscapeData {
  lastUpdated: string;
  platforms: Record<string, Platform>;
  github: {
    description: string;
    daily: Array<Record<string, any>>;
  };
  npm: {
    description: string;
    daily: Array<Record<string, any>>;
  };
  docker: {
    description: string;
    daily: Array<Record<string, any>>;
  };
  velocity: {
    description: string;
    daily: Array<Record<string, any>>;
  };
  linkedin: {
    description: string;
    daily: Array<Record<string, any>>;
  };
  community: {
    description: string;
    current: {
      discord: number;
      forum: number;
      reddit: number;
      linkedin: number;
      github: number;
      lastUpdated: string;
    };
  };
}

let landscapeData: LandscapeData | null = null;
try {
  if (existsSync(landscapePath)) {
    landscapeData = JSON.parse(readFileSync(landscapePath, 'utf-8'));
  }
} catch (e) {
  console.warn('Could not load landscape data');
}

// Load npm landscape time series data
interface NpmLandscapeEntry {
  weekStart: string;
  [platform: string]: string | number;
}
let npmLandscapeData: NpmLandscapeEntry[] = [];
try {
  if (existsSync(npmLandscapePath)) {
    const data = JSON.parse(readFileSync(npmLandscapePath, 'utf-8'));
    npmLandscapeData = data.weekly || [];
  }
} catch (e) {
  console.warn('Could not load npm landscape data');
}

// Get latest GitHub stars
const githubDaily = landscapeData?.github?.daily || [];
const latestGithub = githubDaily.slice(-1)[0] || {};

// Helper to find entry from X months ago
function findEntryMonthsAgo(daily: Array<Record<string, any>>, months: number): Record<string, any> | null {
  const targetDate = new Date();
  targetDate.setMonth(targetDate.getMonth() - months);
  const targetStr = targetDate.toISOString().split('T')[0];
  const filtered = daily.filter(e => e.date <= targetStr);
  return filtered.length > 0 ? filtered[filtered.length - 1] : null;
}

// Get historical data for growth calculations
const github3MonthsAgo = findEntryMonthsAgo(githubDaily, 3);

const githubPlatforms = ['n8n', 'huginn', 'nodered', 'activepieces', 'windmill', 'pipedream'];
const githubData = githubPlatforms
  .map((id) => {
    const current = latestGithub[id] || 0;
    const previous = github3MonthsAgo?.[id] || 0;
    const growthAbs = current - previous; // Absolute growth (can be negative)
    const growthPct = previous > 0 ? ((current - previous) / previous) * 100 : null;
    return {
      id,
      name: landscapeData?.platforms[id]?.name || id,
      stars: current,
      base: previous > 0 ? previous : current, // Stars 3 months ago (or current if no history)
      growth: previous > 0 ? growthAbs : 0, // Growth in last 3 months
      website: landscapeData?.platforms[id]?.website || '',
      focus: landscapeData?.platforms[id]?.focus || '',
      growth3m: growthPct,
    };
  })
  .filter((p) => p.stars > 0)
  .sort((a, b) => b.stars - a.stars);

// Get latest LinkedIn followers
const latestLinkedin = landscapeData?.linkedin?.daily?.slice(-1)[0] || {};
const linkedinPlatforms = ['n8n', 'zapier', 'workato', 'make', 'tray'];
const linkedinData = linkedinPlatforms
  .map((id) => ({
    id,
    name: landscapeData?.platforms[id]?.name || id,
    followers: latestLinkedin[id] || 0,
    website: landscapeData?.platforms[id]?.website || '',
    type: landscapeData?.platforms[id]?.type || 'closed-source',
  }))
  .filter((p) => p.followers > 0)
  .sort((a, b) => b.followers - a.followers);

// Get latest npm downloads
const latestNpm = landscapeData?.npm?.daily?.slice(-1)[0] || {};
const npmPlatforms = ['n8n', 'pipedream', 'windmill', 'nodered', 'activepieces'];
const npmData = npmPlatforms
  .map((id) => ({
    id,
    name: landscapeData?.platforms[id]?.name || id,
    downloads: latestNpm[id] || 0,
  }))
  .filter((p) => p.downloads > 0)
  .sort((a, b) => b.downloads - a.downloads);

// Get latest Docker pulls
const latestDocker = landscapeData?.docker?.daily?.slice(-1)[0] || {};
const dockerPlatforms = ['nodered', 'n8n', 'huginn', 'activepieces'];
const dockerData = dockerPlatforms
  .map((id) => ({
    id,
    name: landscapeData?.platforms[id]?.name || id,
    pulls: latestDocker[id] || 0,
  }))
  .filter((p) => p.pulls > 0)
  .sort((a, b) => b.pulls - a.pulls);

// Get latest velocity data
const latestVelocity = landscapeData?.velocity?.daily?.slice(-1)[0] || {};
const velocityPlatforms = ['n8n', 'activepieces', 'windmill', 'pipedream', 'nodered', 'huginn'];
const velocityData = velocityPlatforms
  .map((id) => ({
    id,
    name: landscapeData?.platforms[id]?.name || id,
    commits90d: latestVelocity[`${id}_commits90d`] || 0,
    releases90d: latestVelocity[`${id}_releases90d`] || 0,
    weeklyCommits: latestVelocity[`${id}_weeklyCommits`] || 0,
    latestRelease: latestVelocity[`${id}_latestRelease`] || null,
  }))
  .filter((p) => p.commits90d > 0 || p.releases90d > 0)
  .sort((a, b) => b.commits90d - a.commits90d);

// All platforms for comparison table
const allPlatforms = Object.entries(landscapeData?.platforms || {}).map(([id, platform]) => ({
  id,
  ...platform,
  githubStars: latestGithub[id] || null,
  linkedinFollowers: latestLinkedin[id] || null,
  npmDownloads: latestNpm[id] || null,
  dockerPulls: latestDocker[id] || null,
}));

// Format date
const lastUpdated = landscapeData?.lastUpdated
  ? new Date(landscapeData.lastUpdated).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    })
  : 'Unknown';

// Pass data to client-side charts
const githubChartData = JSON.stringify(githubData);
const linkedinChartData = JSON.stringify(linkedinData);
const npmChartData = JSON.stringify(npmData);
const npmTimeSeriesData = JSON.stringify(npmLandscapeData);
const dockerChartData = JSON.stringify(dockerData);
const velocityChartData = JSON.stringify(velocityData);

// Icons
const icons = {
  landscape: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
  github: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="20" height="20" fill="currentColor"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>`,
  linkedin: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>`,
  community: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  star: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"></path></svg>`,
  check: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd"/></svg>`,
  x: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/></svg>`,
  external: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="14" height="14" fill="currentColor"><path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z" clip-rule="evenodd"/></svg>`,
  npm: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M0 0v24h24V0H0zm19.2 19.2H12v-9.6H7.2v9.6H4.8V4.8h14.4v14.4z"/></svg>`,
  docker: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M13.983 11.078h2.119a.186.186 0 0 0 .186-.185V9.006a.186.186 0 0 0-.186-.186h-2.119a.185.185 0 0 0-.185.185v1.888c0 .102.083.185.185.185m-2.954-5.43h2.118a.186.186 0 0 0 .186-.186V3.574a.186.186 0 0 0-.186-.185h-2.118a.185.185 0 0 0-.185.185v1.888c0 .102.082.185.185.185m0 2.716h2.118a.187.187 0 0 0 .186-.186V6.29a.186.186 0 0 0-.186-.185h-2.118a.185.185 0 0 0-.185.185v1.887c0 .102.082.186.185.186m-2.93 0h2.12a.186.186 0 0 0 .184-.186V6.29a.185.185 0 0 0-.185-.185H8.1a.185.185 0 0 0-.185.185v1.887c0 .102.083.186.185.186m-2.964 0h2.119a.186.186 0 0 0 .185-.186V6.29a.186.186 0 0 0-.185-.185H5.136a.186.186 0 0 0-.186.185v1.887c0 .102.084.186.186.186m5.893 2.715h2.118a.186.186 0 0 0 .186-.185V9.006a.186.186 0 0 0-.186-.186h-2.118a.185.185 0 0 0-.185.185v1.888c0 .102.082.185.185.185m-2.93 0h2.12a.185.185 0 0 0 .184-.185V9.006a.185.185 0 0 0-.184-.186h-2.12a.185.185 0 0 0-.184.185v1.888c0 .102.083.185.185.185m-2.964 0h2.119a.185.185 0 0 0 .185-.185V9.006a.185.185 0 0 0-.185-.186h-2.12a.186.186 0 0 0-.185.186v1.887c0 .102.084.185.186.185m-2.92 0h2.12a.185.185 0 0 0 .184-.185V9.006a.185.185 0 0 0-.184-.186h-2.12a.185.185 0 0 0-.184.185v1.888c0 .102.082.185.185.185M23.763 9.89c-.065-.051-.672-.51-1.954-.51-.338.001-.676.03-1.01.087-.248-1.7-1.653-2.53-1.716-2.566l-.344-.199-.226.327c-.284.438-.49.922-.612 1.43-.23.97-.09 1.882.403 2.661-.595.332-1.55.413-1.744.42H.751a.751.751 0 0 0-.75.748 11.376 11.376 0 0 0 .692 4.062c.545 1.428 1.355 2.48 2.41 3.124 1.18.723 3.1 1.137 5.275 1.137.983.003 1.963-.086 2.93-.266a12.248 12.248 0 0 0 3.823-1.389c.98-.567 1.86-1.288 2.61-2.136 1.252-1.418 1.998-2.997 2.553-4.4h.221c1.372 0 2.215-.549 2.68-1.009.309-.293.55-.65.707-1.046l.098-.288Z"/></svg>`,
  velocity: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
};
---

<BaseLayout title="Automation Market" description="Compare n8n with other workflow automation platforms - GitHub stars, LinkedIn followers, and community reach">
  <div class="container-narrow py-12">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
        <span class="text-n8n-primary" set:html={icons.landscape} />
        Automation Market
      </h1>
      <p class="text-gray-400">
        How n8n compares to other workflow automation platforms. GitHub stars, LinkedIn presence, and community reach.
      </p>
      <p class="text-gray-500 text-sm mt-1">
        Last updated: {lastUpdated}
      </p>
    </div>

    <!-- Open Source GitHub Stars -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-gray-400" set:html={icons.github} />
        Open Source Automation Tools
      </h2>
      <p class="text-gray-400 mb-6">
        GitHub stars for self-hostable automation platforms. Showing 3-month growth rates.
      </p>

      <div class="card">
        <div class="relative h-[350px]">
          <canvas id="github-stars-chart"></canvas>
        </div>
        {github3MonthsAgo && (
          <p class="text-gray-500 text-xs mt-3 text-center">
            Growth calculated from {github3MonthsAgo.date} to {latestGithub.date}
          </p>
        )}
      </div>
    </section>

    <!-- npm Weekly Downloads -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-gray-400" set:html={icons.npm} />
        npm Weekly Downloads
      </h2>
      <p class="text-gray-400 mb-6">
        Weekly npm package downloads over time. Excludes Activepieces (Docker-only distribution).
      </p>

      <div class="card">
        <!-- Controls -->
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-400">Range:</label>
            <select id="npm-date-range" class="bg-n8n-darker border border-n8n-border rounded px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-n8n-primary">
              <option value="26">6 months</option>
              <option value="52" selected>1 year</option>
              <option value="104">2 years</option>
              <option value="all">All time</option>
            </select>
          </div>
        </div>
        <div class="relative h-[350px]">
          <canvas id="npm-chart"></canvas>
        </div>
        <!-- Legend -->
        <div class="flex flex-wrap items-center justify-center gap-4 mt-4 text-xs">
          <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-[#ff6d5a]"></span><span class="text-gray-400">n8n</span></div>
          <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-[#f59e0b]"></span><span class="text-gray-400">Pipedream</span></div>
          <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-[#22c55e]"></span><span class="text-gray-400">Windmill</span></div>
          <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-[#8f3e3e]"></span><span class="text-gray-400">Node-RED</span></div>
        </div>
      </div>
    </section>

    <!-- Docker Hub Pulls -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-gray-400" set:html={icons.docker} />
        Docker Hub Pulls
      </h2>
      <p class="text-gray-400 mb-6">
        Total Docker image pulls for self-hostable platforms. Higher numbers indicate broader deployment.
      </p>

      <div class="card">
        <div class="relative h-[250px]">
          <canvas id="docker-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Development Velocity -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-gray-400" set:html={icons.velocity} />
        Development Velocity (90 days)
      </h2>
      <p class="text-gray-400 mb-6">
        Commits and releases over the last 90 days. Indicates active development and release cadence.
      </p>

      <div class="card">
        <div class="relative h-[350px]">
          <canvas id="velocity-chart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          {velocityData.slice(0, 3).map((p) => (
            <div class="bg-n8n-bg-secondary rounded-lg p-3">
              <div class="font-semibold text-white">{p.name}</div>
              <div class="text-gray-400 mt-1">
                <span class="text-n8n-primary font-mono">{p.commits90d.toLocaleString()}</span> commits
                {' | '}
                <span class="text-green-400 font-mono">{p.releases90d}</span> releases
              </div>
              {p.latestRelease && (
                <div class="text-gray-500 text-xs mt-1">Latest: {p.latestRelease}</div>
              )}
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- LinkedIn Industry Presence -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
        <span class="text-gray-400" set:html={icons.linkedin} />
        Industry LinkedIn Presence
      </h2>
      <p class="text-gray-400 mb-6">
        LinkedIn company page followers across automation platforms.
      </p>

      <div class="card">
        <div class="relative h-[300px]">
          <canvas id="linkedin-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Full Platform Comparison -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2">Platform Comparison</h2>
      <p class="text-gray-400 mb-6">
        Overview of workflow automation platforms in the market.
      </p>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-n8n-border">
              <th class="text-left py-3 px-4 text-gray-400 font-medium">Platform</th>
              <th class="text-center py-3 px-4 text-gray-400 font-medium">Type</th>
              <th class="text-center py-3 px-4 text-gray-400 font-medium">Self-Host</th>
              <th class="text-right py-3 px-4 text-gray-400 font-medium">GitHub Stars</th>
              <th class="text-right py-3 px-4 text-gray-400 font-medium">LinkedIn</th>
              <th class="text-left py-3 px-4 text-gray-400 font-medium">Focus</th>
              <th class="text-center py-3 px-4 text-gray-400 font-medium">Founded</th>
            </tr>
          </thead>
          <tbody>
            {allPlatforms
              .sort((a, b) => (b.githubStars || 0) + (b.linkedinFollowers || 0) - (a.githubStars || 0) - (a.linkedinFollowers || 0))
              .map((platform) => (
              <tr class={`border-b border-n8n-border/50 ${platform.id === 'n8n' ? 'bg-n8n-primary/10' : ''}`}>
                <td class="py-3 px-4">
                  <a
                    href={platform.website}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-white hover:text-n8n-primary flex items-center gap-1"
                  >
                    {platform.name}
                    <span class="text-gray-500" set:html={icons.external} />
                  </a>
                </td>
                <td class="py-3 px-4 text-center">
                  <span class={`px-2 py-1 rounded text-xs ${platform.type === 'open-source' ? 'bg-green-900/50 text-green-400' : 'bg-gray-700 text-gray-300'}`}>
                    {platform.type === 'open-source' ? 'Open' : 'Closed'}
                  </span>
                </td>
                <td class="py-3 px-4">
                  <div class="flex justify-center">
                    {platform.selfHostable ? (
                      <span class="text-green-400" set:html={icons.check} />
                    ) : (
                      <span class="text-gray-500" set:html={icons.x} />
                    )}
                  </div>
                </td>
                <td class="py-3 px-4 text-right font-mono text-white">
                  {platform.githubStars ? formatNumber(platform.githubStars) : '-'}
                </td>
                <td class="py-3 px-4 text-right font-mono text-white">
                  {platform.linkedinFollowers ? formatNumber(platform.linkedinFollowers) : '-'}
                </td>
                <td class="py-3 px-4 text-gray-400 text-xs">{platform.focus}</td>
                <td class="py-3 px-4 text-center text-gray-400">{platform.founded}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Data Sources -->
    <DataSourcesSection sources={[
      { label: "GitHub stars", source: "GitHub API", url: "https://api.github.com", note: "updated weekly" },
      { label: "LinkedIn followers", source: "LinkedIn", url: "https://www.linkedin.com/company/n8n", note: "updated monthly" },
      { label: "npm downloads", source: "npm API", url: "https://npmjs.com", note: "updated weekly" },
      { label: "Docker pulls", source: "Docker Hub API", url: "https://hub.docker.com", note: "updated weekly" },
    ]} />
  </div>
</BaseLayout>

<script define:vars={{ githubChartData, linkedinChartData, npmChartData, npmTimeSeriesData, dockerChartData, velocityChartData }}>
  window.__landscapeGithubData = JSON.parse(githubChartData);
  window.__landscapeLinkedinData = JSON.parse(linkedinChartData);
  window.__landscapeNpmData = JSON.parse(npmChartData);
  window.__npmTimeSeriesData = JSON.parse(npmTimeSeriesData);
  window.__landscapeDockerData = JSON.parse(dockerChartData);
  window.__landscapeVelocityData = JSON.parse(velocityChartData);
</script>

<script>
  import { Chart, registerables } from 'chart.js';
  import 'chartjs-adapter-date-fns';  // Required for TimeScale
  import { initChartWhenVisible } from '../../lib/utils/lazyChart';

  Chart.register(...registerables);

  // Colors
  const COLORS = {
    n8n: '#ff6d5a',
    huginn: '#4bc0c0',
    nodered: '#8f3e3e',
    activepieces: '#6366f1',
    windmill: '#22c55e',
    pipedream: '#f59e0b',
    zapier: '#ff4a00',
    make: '#6d28d9',
    workato: '#0ea5e9',
    tray: '#ec4899',
  };

  function initGithubChart() {
    const canvas = document.getElementById('github-stars-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const data = (window as any).__landscapeGithubData || [];

    // Create labels with growth indicators
    const labelsWithGrowth = data.map((d: any) => {
      if (d.growth3m !== null && d.growth3m !== undefined) {
        const sign = d.growth3m >= 0 ? '+' : '';
        return `${d.name} (${sign}${d.growth3m.toFixed(1)}%)`;
      }
      return d.name;
    });

    // For stacked chart: base = 3 months ago, growth = increase since then
    // Handle negative growth by showing full bar as "base" with no growth segment
    const baseData = data.map((d: any) => d.growth > 0 ? d.base : d.stars);
    const growthData = data.map((d: any) => d.growth > 0 ? d.growth : 0);

    // Colors: base is darker, growth is the platform's bright color
    const baseColors = data.map((d: any) => {
      const color = COLORS[d.id as keyof typeof COLORS] || '#6b7280';
      // Darken the color for base
      return color + '80'; // 50% opacity
    });
    const growthColors = data.map((d: any) => COLORS[d.id as keyof typeof COLORS] || '#6b7280');

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labelsWithGrowth,
        datasets: [
          {
            label: '3 months ago',
            data: baseData,
            backgroundColor: baseColors,
            borderRadius: 0,
          },
          {
            label: '3-month growth',
            data: growthData,
            backgroundColor: growthColors,
            borderRadius: { topRight: 4, bottomRight: 4 },
          },
        ],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            align: 'end',
            labels: {
              color: '#9ca3af',
              boxWidth: 12,
              padding: 15,
              usePointStyle: false,
            },
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            callbacks: {
              title: (items) => data[items[0].dataIndex]?.name || '',
              label: (ctx) => {
                const item = data[ctx.dataIndex];
                if (ctx.datasetIndex === 0) {
                  // Base dataset
                  return `3 months ago: ${ctx.parsed.x.toLocaleString()} stars`;
                } else {
                  // Growth dataset
                  if (item?.growth > 0) {
                    return `Growth: +${ctx.parsed.x.toLocaleString()} stars`;
                  }
                  return null; // Don't show for zero/negative growth
                }
              },
              afterBody: (items) => {
                const item = data[items[0].dataIndex];
                const lines = [`Total: ${item.stars.toLocaleString()} stars`];
                if (item?.growth3m !== null && item?.growth3m !== undefined) {
                  const sign = item.growth3m >= 0 ? '+' : '';
                  lines.push(`Growth rate: ${sign}${item.growth3m.toFixed(1)}%`);
                }
                return lines;
              },
            },
          },
        },
        scales: {
          x: {
            stacked: true,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#6b7280',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              },
            },
          },
          y: {
            stacked: true,
            grid: { display: false },
            ticks: { color: '#e5e7eb', font: { weight: 'bold' } },
          },
        },
      },
    });
  }

  let npmChart: Chart | null = null;

  function initNpmChart() {
    const canvas = document.getElementById('npm-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const timeSeriesData = (window as any).__npmTimeSeriesData || [];
    if (timeSeriesData.length === 0) return;

    // Platforms to show (excluding activepieces - Docker-only)
    const platforms = ['n8n', 'pipedream', 'windmill', 'nodered'];
    const platformNames: Record<string, string> = {
      n8n: 'n8n',
      pipedream: 'Pipedream',
      windmill: 'Windmill',
      nodered: 'Node-RED',
    };

    function renderNpmChart(weeks: number | 'all') {
      const data = weeks === 'all'
        ? timeSeriesData
        : timeSeriesData.slice(-weeks);

      // Destroy existing chart
      if (npmChart) {
        npmChart.destroy();
        npmChart = null;
      }

      // Build datasets
      const datasets = platforms.map((platform) => ({
        label: platformNames[platform] || platform,
        data: data.map((d: any) => ({
          x: d.weekStart,
          y: d[platform] || 0,
        })),
        borderColor: COLORS[platform as keyof typeof COLORS],
        backgroundColor: COLORS[platform as keyof typeof COLORS] + '20',
        fill: false,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 4,
        borderWidth: 2,
      }));

      npmChart = new Chart(canvas, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              callbacks: {
                title: (items) => {
                  const date = new Date(items[0].parsed.x);
                  return `Week of ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                },
                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString()}`,
              },
            },
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: weeks === 'all' || weeks > 104 ? 'year' : weeks > 52 ? 'quarter' : 'month',
                displayFormats: {
                  month: 'MMM yyyy',
                  quarter: 'MMM yyyy',
                  year: 'yyyy',
                },
              },
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#6b7280' },
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: {
                color: '#6b7280',
                callback: (value) => {
                  if (typeof value === 'number') {
                    if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                  }
                  return value;
                },
              },
            },
          },
        },
      });
    }

    // Initial render with 1 year
    renderNpmChart(52);

    // Wire up date range control
    const rangeSelect = document.getElementById('npm-date-range') as HTMLSelectElement;
    if (rangeSelect) {
      rangeSelect.addEventListener('change', () => {
        const val = rangeSelect.value;
        renderNpmChart(val === 'all' ? 'all' : parseInt(val));
      });
    }
  }

  function initDockerChart() {
    const canvas = document.getElementById('docker-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const data = (window as any).__landscapeDockerData || [];

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: data.map((d: any) => d.name),
        datasets: [
          {
            label: 'Docker Pulls',
            data: data.map((d: any) => d.pulls),
            backgroundColor: data.map((d: any) => COLORS[d.id as keyof typeof COLORS] || '#6b7280'),
            borderRadius: 4,
          },
        ],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            callbacks: {
              label: (ctx) => `${ctx.parsed.x.toLocaleString()} pulls`,
            },
          },
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#6b7280',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000000) return (value / 1000000).toFixed(0) + 'M';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              },
            },
          },
          y: {
            grid: { display: false },
            ticks: { color: '#e5e7eb', font: { weight: 'bold' } },
          },
        },
      },
    });
  }

  function initVelocityChart() {
    const canvas = document.getElementById('velocity-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const data = (window as any).__landscapeVelocityData || [];

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: data.map((d: any) => d.name),
        datasets: [
          {
            label: 'Commits (90 days)',
            data: data.map((d: any) => d.commits90d),
            backgroundColor: data.map((d: any) => COLORS[d.id as keyof typeof COLORS] || '#6b7280'),
            borderRadius: 4,
            yAxisID: 'y',
          },
          {
            label: 'Releases (90 days)',
            data: data.map((d: any) => d.releases90d),
            backgroundColor: 'rgba(34, 197, 94, 0.8)', // Green for releases
            borderRadius: 4,
            yAxisID: 'y1',
          },
        ],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            align: 'end',
            labels: {
              color: '#9ca3af',
              boxWidth: 12,
              padding: 15,
            },
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            callbacks: {
              afterBody: (items) => {
                const item = data[items[0].dataIndex];
                if (item?.latestRelease) {
                  return [`Latest: ${item.latestRelease}`];
                }
                return [];
              },
            },
          },
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#6b7280',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              },
            },
            title: {
              display: true,
              text: 'Commits',
              color: '#6b7280',
            },
          },
          x1: {
            type: 'linear',
            position: 'top',
            grid: { display: false },
            ticks: { color: '#22c55e' },
            title: {
              display: true,
              text: 'Releases',
              color: '#22c55e',
            },
          },
          y: {
            grid: { display: false },
            ticks: { color: '#e5e7eb', font: { weight: 'bold' } },
          },
          y1: {
            display: false,
          },
        },
      },
    });
  }

  function initLinkedinChart() {
    const canvas = document.getElementById('linkedin-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const data = (window as any).__landscapeLinkedinData || [];

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: data.map((d: any) => d.name),
        datasets: [
          {
            label: 'LinkedIn Followers',
            data: data.map((d: any) => d.followers),
            backgroundColor: data.map((d: any) => COLORS[d.id as keyof typeof COLORS] || '#6b7280'),
            borderRadius: 4,
          },
        ],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            callbacks: {
              label: (ctx) => `${ctx.parsed.x.toLocaleString()} followers`,
            },
          },
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#6b7280',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              },
            },
          },
          y: {
            grid: { display: false },
            ticks: { color: '#e5e7eb', font: { weight: 'bold' } },
          },
        },
      },
    });
  }

  // Initialize charts when visible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initChartWhenVisible('github-stars-chart', initGithubChart);
      initChartWhenVisible('npm-chart', initNpmChart);
      initChartWhenVisible('docker-chart', initDockerChart);
      initChartWhenVisible('velocity-chart', initVelocityChart);
      initChartWhenVisible('linkedin-chart', initLinkedinChart);
    });
  } else {
    initChartWhenVisible('github-stars-chart', initGithubChart);
    initChartWhenVisible('npm-chart', initNpmChart);
    initChartWhenVisible('docker-chart', initDockerChart);
    initChartWhenVisible('velocity-chart', initVelocityChart);
    initChartWhenVisible('linkedin-chart', initLinkedinChart);
  }
</script>
