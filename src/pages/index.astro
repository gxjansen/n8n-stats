---
import BaseLayout from '@/layouts/BaseLayout.astro';
import StatCard from '@/components/cards/StatCard.astro';
import VelocityCard from '@/components/cards/VelocityCard.astro';
import TemplateCard from '@/components/cards/TemplateCard.astro';
import SubpageTeaserCard from '@/components/cards/SubpageTeaserCard.astro';
import EventsSpotlightCard from '@/components/cards/EventsSpotlightCard.astro';
import CommunityActivityCard from '@/components/cards/CommunityActivityCard.astro';
import AIInsightCard from '@/components/cards/AIInsightCard.astro';
import LLMSummaryCard from '@/components/cards/LLMSummaryCard.astro';
import { fetchTemplates } from '@/lib/api/n8n';
import { fetchForumStats } from '@/lib/api/discourse';
import { formatNumber } from '@/lib/utils/formatters';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load GitHub stats and monthly history from stored data (no API calls during build)
let githubStats = { stars: 0, forks: 0, watchers: 0, openIssues: 0, subscribers: 0 };
let githubMonthlyHistory: number[] = [];
try {
  const historyPath = join(process.cwd(), 'public', 'data', 'github-history.json');
  if (existsSync(historyPath)) {
    const historyData = JSON.parse(readFileSync(historyPath, 'utf-8'));
    const latest = historyData.monthly?.[historyData.monthly.length - 1];
    if (latest) {
      githubStats = {
        stars: latest.stars || 0,
        forks: latest.forks || 0,
        watchers: latest.watchers || 0,
        openIssues: latest.openIssues || 0,
        subscribers: latest.watchers || 0,
      };
    }
    // Get last 12 months for sparkline
    githubMonthlyHistory = historyData.monthly?.slice(-12).map((d: { stars: number }) => d.stars) || [];
  }
} catch (e) { /* use defaults */ }

// Load Community/Forum monthly history for sparkline
let communityMonthlyHistory: number[] = [];
try {
  const communityPath = join(process.cwd(), 'public', 'data', 'community-history.json');
  if (existsSync(communityPath)) {
    const communityData = JSON.parse(readFileSync(communityPath, 'utf-8'));
    // Get last 12 months for sparkline
    communityMonthlyHistory = communityData.monthly?.slice(-12).map((d: { users: number }) => d.users) || [];
  }
} catch (e) { /* use defaults */ }

// Fetch templates and forum stats at build time (with error handling)
const [templatesResponse, forumStats] = await Promise.all([
  fetchTemplates({ rows: 6, sort: 'trendingScore:desc' }),
  fetchForumStats().catch(() => ({ usersCount: 0, topicsCount: 0, postsCount: 0, likesCount: 0, activeUsers7Days: 0, postsLast7Days: 0 })),
]);

const { totalWorkflows, workflows: trendingTemplates } = templatesResponse;

// Load historical data for velocity calculations
interface CreatorStatsEntry {
  date: string;
  total: number;
  verified: number;
  totalViews: number;
  totalInserters: number;
}

interface GitHubRawEntry {
  date: string;
  stars: number;
  source: string;
}

let creatorsHistory: { weekly: CreatorStatsEntry[] } = { weekly: [] };
let githubRawLog: { entries: GitHubRawEntry[] } = { entries: [] };
let templatesHistory: { daily: { date: string; total: number; categories: Record<string, number> }[] } = { daily: [] };

try {
  const creatorsPath = join(process.cwd(), 'public', 'data', 'history', 'creators-stats.json');
  creatorsHistory = JSON.parse(readFileSync(creatorsPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  // Use raw log to get ONLY real collected data (source: github-api)
  const githubPath = join(process.cwd(), 'public', 'data', 'github-raw-log.json');
  githubRawLog = JSON.parse(readFileSync(githubPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  const templatesPath = join(process.cwd(), 'public', 'data', 'history', 'templates.json');
  templatesHistory = JSON.parse(readFileSync(templatesPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load templates raw log for AI Agent node count, top nodes, and LLM models
interface TemplatesRawEntry {
  date: string;
  total: number;
  categories: Record<string, number>;
  topNodes: { name: string; count: number }[];
  llmModels?: { name: string; count: number }[];
}
let templatesRawLog: { entries: TemplatesRawEntry[] } = { entries: [] };
try {
  const rawPath = join(process.cwd(), 'public', 'data', 'templates-raw-log.json');
  templatesRawLog = JSON.parse(readFileSync(rawPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load events data
interface EventData {
  id: string;
  name: string;
  startDate: string;
  location: { city: string; country: string };
  isOnline: boolean;
  registrations?: number;
}
interface EventsHistory {
  upcoming: EventData[];
  stats: { upcomingCount: number; countriesCount: number; totalEvents: number };
}
let eventsData: EventsHistory = { upcoming: [], stats: { upcomingCount: 0, countriesCount: 0, totalEvents: 0 } };
try {
  const eventsPath = join(process.cwd(), 'public', 'data', 'history', 'events.json');
  eventsData = JSON.parse(readFileSync(eventsPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load Discord data
interface DiscordHistory {
  daily: { date: string; members: number; online: number }[];
}
let discordData: DiscordHistory = { daily: [] };
try {
  const discordPath = join(process.cwd(), 'public', 'data', 'history', 'discord.json');
  discordData = JSON.parse(readFileSync(discordPath, 'utf-8'));
} catch (e) { /* use defaults */ }

const latestDiscord = discordData.daily?.[discordData.daily.length - 1] || { members: 0, online: 0 };

// Load Reddit data
interface RedditHistory {
  daily: { date: string; subscribers: number }[];
  current: { subscribers: number };
}
let redditData: RedditHistory = { daily: [], current: { subscribers: 0 } };
let redditGrowthText = '';
try {
  const redditPath = join(process.cwd(), 'public', 'data', 'history', 'reddit.json');
  redditData = JSON.parse(readFileSync(redditPath, 'utf-8'));

  // Calculate growth for display
  if (redditData.daily.length >= 2) {
    const latest = redditData.daily[redditData.daily.length - 1];
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
    const oldEntry = [...redditData.daily].reverse().find(d => d.date <= thirtyDaysAgoStr) || redditData.daily[0];

    if (oldEntry && oldEntry.subscribers > 0) {
      const growth = latest.subscribers - oldEntry.subscribers;
      if (growth > 0) {
        redditGrowthText = `+${formatNumber(growth)} recent`;
      }
    }
  }
} catch (e) { /* use defaults */ }

const redditSubscribers = redditData.current?.subscribers || 0;

// Load events monthly history for sparkline
interface EventsMonthlyEntry {
  date: string;
  events: number;
  registrations: number;
}
let eventsMonthlyHistory: number[] = [];
try {
  const eventsHistoryPath = join(process.cwd(), 'public', 'data', 'history', 'events-history.json');
  if (existsSync(eventsHistoryPath)) {
    const eventsHistoryData = JSON.parse(readFileSync(eventsHistoryPath, 'utf-8'));
    // Get last 12 months of event counts
    eventsMonthlyHistory = eventsHistoryData.monthly?.slice(-12).map((d: EventsMonthlyEntry) => d.events) || [];
  }
} catch (e) { /* use defaults */ }

// Load templates daily history for sparkline
let templatesDailyHistory: number[] = [];
try {
  const templatesHistoryPath = join(process.cwd(), 'public', 'data', 'templates-history.json');
  if (existsSync(templatesHistoryPath)) {
    const templatesHistoryData = JSON.parse(readFileSync(templatesHistoryPath, 'utf-8'));
    // Get all daily totals (data is still being collected)
    templatesDailyHistory = templatesHistoryData.daily?.map((d: { total: number }) => d.total) || [];
  }
} catch (e) { /* use defaults */ }

// Load ambassador stats for homepage teaser
let ambassadorStats = { total: 0, countries: 0 };
try {
  const ambassadorPath = join(process.cwd(), 'public', 'data', 'history', 'ambassadors.json');
  if (existsSync(ambassadorPath)) {
    const data = JSON.parse(readFileSync(ambassadorPath, 'utf-8'));
    ambassadorStats = { total: data.stats?.total || 0, countries: data.stats?.countries || 0 };
  }
} catch (e) { /* use defaults */ }

// Load landscape data for market position teaser
let marketPosition = { n8nStars: 0 };
try {
  const landscapePath = join(process.cwd(), 'public', 'data', 'history', 'landscape.json');
  if (existsSync(landscapePath)) {
    const data = JSON.parse(readFileSync(landscapePath, 'utf-8'));
    const latestGithub = data.github?.daily?.slice(-1)[0] || {};
    marketPosition = { n8nStars: latestGithub.n8n || 0 };
  }
} catch (e) { /* use defaults */ }

// Filter GitHub data to ONLY real collected data (exclude seed, ossinsight, etc.)
const realGithubData = githubRawLog.entries
  ?.filter(e => e.source === 'github-api')
  .sort((a, b) => a.date.localeCompare(b.date)) || [];

// Calculate velocity metrics from REAL data only
const recentCreatorData = creatorsHistory.weekly?.slice(-12) || [];
const latestCreators = recentCreatorData[recentCreatorData.length - 1];
const prevCreators = recentCreatorData[recentCreatorData.length - 2];

// GitHub stars: only calculate if we have 7+ days of real data
const MIN_DAYS_FOR_GITHUB_TREND = 7;
const hasEnoughGithubData = realGithubData.length >= MIN_DAYS_FOR_GITHUB_TREND;
const githubTrendData = realGithubData.slice(-12).map(d => d.stars);

// Calculate stars per day from last 7 days of real data (current week velocity)
let starsPerDay: number | null = null;
if (realGithubData.length >= 2) {
  const last = realGithubData[realGithubData.length - 1];
  // Find entry from ~7 days ago
  const sevenDaysAgo = new Date(last.date);
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
  const weekAgoEntry = [...realGithubData].reverse().find(d => d.date <= sevenDaysAgoStr) || realGithubData[0];

  const daysDiff = Math.max(1, Math.round(
    (new Date(last.date).getTime() - new Date(weekAgoEntry.date).getTime()) / (1000 * 60 * 60 * 24)
  ));
  starsPerDay = Math.round((last.stars - weekAgoEntry.stars) / daysDiff);
}

// Weekly growth metrics (n8n Arena data is all real)
const creatorsPerWeek = latestCreators && prevCreators
  ? latestCreators.total - prevCreators.total
  : null;

const insertersPerWeek = latestCreators && prevCreators
  ? latestCreators.totalInserters - prevCreators.totalInserters
  : null;

// Calculate conversion rates for current and previous week
const currentConversionRate = latestCreators && latestCreators.totalViews > 0
  ? (latestCreators.totalInserters / latestCreators.totalViews) * 100
  : null;
const prevConversionRate = prevCreators && prevCreators.totalViews > 0
  ? (prevCreators.totalInserters / prevCreators.totalViews) * 100
  : null;
const conversionRateChange = currentConversionRate !== null && prevConversionRate !== null
  ? currentConversionRate - prevConversionRate
  : null;

// Get weekly data for sparklines (all real from n8n Arena)
const creatorTotals = recentCreatorData.map(d => d.total);
const inserterTotals = recentCreatorData.map(d => d.totalInserters);

// Conversion rate trend (real data)
const conversionTrend = recentCreatorData
  .filter(d => d.totalViews > 0)
  .map(d => (d.totalInserters / d.totalViews) * 100);

// Get AI templates count from categories
const latestTemplateData = templatesHistory.daily?.[templatesHistory.daily.length - 1];
const aiTemplates = latestTemplateData?.categories?.['AI'] || 5189;

// Get node stats from latest raw log entry (all templates)
const latestRawEntry = templatesRawLog.entries?.[templatesRawLog.entries.length - 1];
const topNodes = latestRawEntry?.topNodes || [];
const llmModels = latestRawEntry?.llmModels || [];

// Calculate AI percentage for AIInsightCard
const aiPercentage = totalWorkflows > 0 ? (aiTemplates / totalWorkflows) * 100 : 67;

// Define AI-related nodes to highlight (common AI/LLM nodes in n8n)
const aiNodeNames = [
  'AI Agent', 'OpenAI Chat Model', 'Google Gemini Chat Model', 'Anthropic Chat Model',
  'Groq Chat Model', 'Azure OpenAI Chat Model', 'Ollama Chat Model', 'Mistral Cloud Chat Model',
  'OpenAI', 'Basic LLM Chain', 'Information Extractor', 'Text Classifier', 'Sentiment Analysis',
  'Summarization Chain', 'Question and Answer Chain', 'Embeddings OpenAI', 'Embeddings Google Gemini'
];

// Get top AI nodes from all nodes (filter to AI-related ones)
const topAINodes = topNodes
  .filter(node => aiNodeNames.some(aiName =>
    node.name.toLowerCase().includes(aiName.toLowerCase().replace(/ /g, ''))
  ))
  .slice(0, 4)
  .map(node => ({
    name: node.name,
    displayName: node.name.replace(/([A-Z])/g, ' $1').trim(), // Add spaces before capitals
    count: node.count
  }));

// If not enough AI nodes found, add some defaults with data from topNodes
const aiNodeMatches = [
  { searchTerm: 'aiagent', displayName: 'AI Agent' },
  { searchTerm: 'openaichat', displayName: 'OpenAI Chat Model' },
  { searchTerm: 'geminich', displayName: 'Gemini Chat Model' },
  { searchTerm: 'anthropic', displayName: 'Anthropic Chat Model' },
];

const finalAINodes = topAINodes.length >= 4 ? topAINodes : aiNodeMatches
  .map(ai => {
    const found = topNodes.find(n => n.name.toLowerCase().includes(ai.searchTerm));
    return found ? { name: found.name, displayName: ai.displayName, count: found.count } : null;
  })
  .filter((n): n is { name: string; displayName: string; count: number } => n !== null)
  .slice(0, 4);

// Data status for UI feedback
const dataStatus = {
  github: {
    daysCollected: realGithubData.length,
    daysNeeded: MIN_DAYS_FOR_GITHUB_TREND,
    hasEnough: hasEnoughGithubData,
  },
  creators: {
    weeksCollected: recentCreatorData.length,
    hasEnough: recentCreatorData.length >= 2,
  },
};

// Calculate milestone prediction for GitHub
const nextMilestone = Math.ceil(githubStats.stars / 10000) * 10000;
const starsToMilestone = nextMilestone - githubStats.stars;
const daysToMilestone = starsPerDay && starsPerDay > 0 ? Math.ceil(starsToMilestone / starsPerDay) : null;
---

<BaseLayout title="Dashboard">
  <div class="container-narrow py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <img src="/logo.svg" alt="n8n stats logo" class="h-16 md:h-20 mx-auto mb-6" />
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        The pulse of the <span class="text-n8n-primary">n8n</span> community
      </h1>
      <p class="text-xl text-gray-400 max-w-2xl mx-auto">
        Track ecosystem growth, discover trends, and see what others can't.
      </p>
    </div>

    <!-- Growth Velocity Section - UNIQUE VALUE -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-2">Growth Velocity</h2>
      <p class="text-gray-400 mb-6">Weekly growth metrics, updated every day.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <VelocityCard
          label="GitHub Stars"
          value={hasEnoughGithubData && starsPerDay !== null ? `+${starsPerDay}/day` : null}
          subtitle="Average daily growth"
          trend={githubTrendData}
          color="#ff6d5a"
          to="/dev"
          animationDelay={0}
          collecting={!hasEnoughGithubData ? {
            current: dataStatus.github.daysCollected,
            needed: dataStatus.github.daysNeeded,
            unit: 'days'
          } : undefined}
        />
        <VelocityCard
          label="New Creators"
          value={creatorsPerWeek !== null ? `+${creatorsPerWeek}/week` : null}
          subtitle="Template authors joined"
          trend={creatorTotals}
          color="#36a2eb"
          to="/creators"
          animationDelay={200}
        />
        <VelocityCard
          label="Template Imports"
          value={insertersPerWeek !== null ? `+${formatNumber(insertersPerWeek)}/week` : null}
          subtitle="Workflows imported"
          trend={inserterTotals}
          color="#9966ff"
          to="/templates"
          animationDelay={400}
        />
        <VelocityCard
          label="Conversion Rate"
          value={conversionRateChange !== null ? `${conversionRateChange >= 0 ? '+' : ''}${conversionRateChange.toFixed(2)}%` : null}
          subtitle="Views â†’ imports change"
          trend={conversionTrend}
          color="#4bc0c0"
          to="/creators"
          animationDelay={600}
        />
      </div>
    </section>

    <!-- AI & LLM Insight Section -->
    <section class="mb-12">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <AIInsightCard
          aiPercentage={aiPercentage}
          aiTemplates={aiTemplates}
          totalTemplates={totalWorkflows}
          topAINodes={finalAINodes}
          href="/templates"
        />
        {llmModels.length > 0 && (
          <LLMSummaryCard
            llmModels={llmModels}
            href="/nodes#llm-models"
          />
        )}
        <CommunityActivityCard
          discordMembers={latestDiscord.members}
          discordOnline={latestDiscord.online}
          forumUsers={forumStats.usersCount}
          forumTopics={forumStats.topicsCount}
          redditSubscribers={redditSubscribers}
          redditGrowth={redditGrowthText}
        />
      </div>
    </section>

    <!-- Explore the Ecosystem - Subpage Teasers Grid -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Explore the Ecosystem</h2>
      <p class="text-gray-400 mb-6">Dive deeper into the n8n community data.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Templates - with sparkline -->
        <SubpageTeaserCard
          title="Templates"
          href="/templates"
          mainStat={totalWorkflows}
          mainLabel="workflow templates"
          secondaryStat={aiTemplates}
          secondaryLabel="AI templates"
          accentColor="#ff6d5a"
          ctaText="Browse templates"
          sparklineData={templatesDailyHistory.length > 1 ? templatesDailyHistory : undefined}
          sparklineColor="#ff6d5a"
          animationDelay={0}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Nodes -->
        <SubpageTeaserCard
          title="Nodes"
          href="/nodes"
          mainStat={topNodes.length > 0 ? topNodes[0].name : 'Loading...'}
          mainLabel="most used node"
          secondaryStat={topNodes.length > 0 ? topNodes[0].count : 0}
          secondaryLabel="templates use it"
          accentColor="#36a2eb"
          ctaText="View node stats"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
          </svg>
        </SubpageTeaserCard>

        <!-- Creators - with sparkline -->
        <SubpageTeaserCard
          title="Creators"
          href="/creators"
          mainStat={latestCreators?.total || 0}
          mainLabel="template creators"
          secondaryStat={creatorsPerWeek !== null ? `+${creatorsPerWeek}/week` : undefined}
          secondaryLabel="new creators"
          accentColor="#9966ff"
          ctaText="See leaderboard"
          sparklineData={creatorTotals.length > 1 ? creatorTotals : undefined}
          sparklineColor="#9966ff"
          animationDelay={200}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Dev - with sparkline -->
        <SubpageTeaserCard
          title="Dev"
          href="/dev"
          mainStat={githubStats.stars}
          mainLabel="stars on GitHub"
          secondaryStat={daysToMilestone !== null ? `${daysToMilestone} days` : undefined}
          secondaryLabel={`to ${formatNumber(nextMilestone)}`}
          accentColor="#f97316"
          ctaText="View dev stats"
          sparklineData={githubMonthlyHistory}
          sparklineColor="#f97316"
          animationDelay={400}
        >
          <svg slot="icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
          </svg>
        </SubpageTeaserCard>

        <!-- Discussions - with sparkline -->
        <SubpageTeaserCard
          title="Discussions"
          href="/discussions"
          mainStat={latestDiscord.members + forumStats.usersCount + redditSubscribers}
          mainLabel="total members"
          secondaryStat={redditSubscribers}
          secondaryLabel="on r/n8n"
          accentColor="#10b981"
          ctaText="View discussions"
          sparklineData={communityMonthlyHistory}
          sparklineColor="#10b981"
          animationDelay={600}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Events - with sparkline -->
        <SubpageTeaserCard
          title="Events"
          href="/events"
          mainStat={eventsData.stats.upcomingCount}
          mainLabel="upcoming events"
          secondaryStat={eventsData.stats.countriesCount}
          secondaryLabel="countries"
          accentColor="#8b5cf6"
          ctaText="See events"
          sparklineData={eventsMonthlyHistory.length > 1 ? eventsMonthlyHistory : undefined}
          sparklineColor="#8b5cf6"
          animationDelay={800}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Ambassadors -->
        <SubpageTeaserCard
          title="Ambassadors"
          href="/ambassadors"
          mainStat={ambassadorStats.total || 69}
          mainLabel="community ambassadors"
          secondaryStat={ambassadorStats.countries || 27}
          secondaryLabel="countries"
          accentColor="#ec4899"
          ctaText="Meet ambassadors"
          animationDelay={1000}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Market -->
        <SubpageTeaserCard
          title="Market"
          href="/market"
          mainStat="#1"
          mainLabel="in open-source automation"
          secondaryStat={marketPosition.n8nStars > 0 ? formatNumber(marketPosition.n8nStars) : formatNumber(githubStats.stars)}
          secondaryLabel="GitHub stars"
          accentColor="#14b8a6"
          ctaText="See comparison"
          animationDelay={1200}
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </SubpageTeaserCard>
      </div>
    </section>

    <!-- Events Spotlight -->
    <section class="mb-12">
      <EventsSpotlightCard
        upcomingEvents={eventsData.upcoming}
        totalUpcoming={eventsData.stats.upcomingCount}
        countriesCount={eventsData.stats.countriesCount}
      />
    </section>

    <!-- Trending Templates -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Trending Templates</h2>
          <p class="text-gray-400 text-sm mt-1">Ranked by n8n.io's trending algorithm (recent views + insertions)</p>
        </div>
        <a href="/templates" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {trendingTemplates.map((template) => (
          <TemplateCard template={template} />
        ))}
      </div>
    </section>

    <!-- Top Nodes -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Used Nodes</h2>
          <p class="text-gray-400 text-sm mt-1">Nodes appearing in the most templates across all {formatNumber(totalWorkflows)} workflows</p>
        </div>
        <a href="/nodes" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        {topNodes.slice(0, 5).map((node, index) => (
          <a href="/nodes" class="card text-center hover:border-n8n-primary/50 transition-colors group">
            <div class="text-3xl font-bold text-n8n-primary mb-2">#{index + 1}</div>
            <div class="font-medium text-white group-hover:text-n8n-primary transition-colors">{node.name}</div>
            <div class="text-sm text-gray-400 mt-1">
              {formatNumber(node.count)} templates
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- By the Numbers (Trust Indicators) -->
    <section class="mb-8">
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-xl font-semibold text-gray-300">By the Numbers</h2>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          label="Workflow Templates"
          value={totalWorkflows}
          to="/templates"
        />
        <StatCard
          label="GitHub Stars"
          value={githubStats.stars}
          to="/dev"
        />
        <StatCard
          label="Community Members"
          value={latestDiscord.members + forumStats.usersCount + redditSubscribers}
          to="/discussions"
        />
        <StatCard
          label="Community Events"
          value={eventsData.stats.totalEvents}
          to="/events"
        />
      </div>
    </section>
  </div>
</BaseLayout>
