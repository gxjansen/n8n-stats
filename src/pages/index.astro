---
import BaseLayout from '@/layouts/BaseLayout.astro';
import StatCard from '@/components/cards/StatCard.astro';
import VelocityCard from '@/components/cards/VelocityCard.astro';
import TemplateCard from '@/components/cards/TemplateCard.astro';
import SubpageTeaserCard from '@/components/cards/SubpageTeaserCard.astro';
import EventsSpotlightCard from '@/components/cards/EventsSpotlightCard.astro';
import CommunityActivityCard from '@/components/cards/CommunityActivityCard.astro';
import { fetchTemplates } from '@/lib/api/n8n';
import { fetchForumStats } from '@/lib/api/discourse';
import { formatNumber } from '@/lib/utils/formatters';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load GitHub stats from stored data (no API calls during build)
let githubStats = { stars: 0, forks: 0, watchers: 0, openIssues: 0, subscribers: 0 };
try {
  const historyPath = join(process.cwd(), 'public', 'data', 'github-history.json');
  if (existsSync(historyPath)) {
    const historyData = JSON.parse(readFileSync(historyPath, 'utf-8'));
    const latest = historyData.monthly?.[historyData.monthly.length - 1];
    if (latest) {
      githubStats = {
        stars: latest.stars || 0,
        forks: latest.forks || 0,
        watchers: latest.watchers || 0,
        openIssues: latest.openIssues || 0,
        subscribers: latest.watchers || 0,
      };
    }
  }
} catch (e) { /* use defaults */ }

// Fetch templates and forum stats at build time (with error handling)
const [templatesResponse, forumStats] = await Promise.all([
  fetchTemplates({ rows: 6, sort: 'trendingScore:desc' }),
  fetchForumStats().catch(() => ({ usersCount: 0, topicsCount: 0, postsCount: 0, likesCount: 0, activeUsers7Days: 0, postsLast7Days: 0 })),
]);

const { totalWorkflows, workflows: trendingTemplates } = templatesResponse;

// Load historical data for velocity calculations
interface CreatorStatsEntry {
  date: string;
  total: number;
  verified: number;
  totalViews: number;
  totalInserters: number;
}

interface GitHubRawEntry {
  date: string;
  stars: number;
  source: string;
}

let creatorsHistory: { weekly: CreatorStatsEntry[] } = { weekly: [] };
let githubRawLog: { entries: GitHubRawEntry[] } = { entries: [] };
let templatesHistory: { daily: { date: string; total: number; categories: Record<string, number> }[] } = { daily: [] };

try {
  const creatorsPath = join(process.cwd(), 'public', 'data', 'history', 'creators-stats.json');
  creatorsHistory = JSON.parse(readFileSync(creatorsPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  // Use raw log to get ONLY real collected data (source: github-api)
  const githubPath = join(process.cwd(), 'public', 'data', 'github-raw-log.json');
  githubRawLog = JSON.parse(readFileSync(githubPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  const templatesPath = join(process.cwd(), 'public', 'data', 'history', 'templates.json');
  templatesHistory = JSON.parse(readFileSync(templatesPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load templates raw log for AI Agent node count and top nodes
interface TemplatesRawEntry {
  date: string;
  total: number;
  categories: Record<string, number>;
  topNodes: { name: string; count: number }[];
}
let templatesRawLog: { entries: TemplatesRawEntry[] } = { entries: [] };
try {
  const rawPath = join(process.cwd(), 'public', 'data', 'templates-raw-log.json');
  templatesRawLog = JSON.parse(readFileSync(rawPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load events data
interface EventData {
  id: string;
  name: string;
  startDate: string;
  location: { city: string; country: string };
  isOnline: boolean;
  registrations?: number;
}
interface EventsHistory {
  upcoming: EventData[];
  stats: { upcomingCount: number; countriesCount: number; totalEvents: number };
}
let eventsData: EventsHistory = { upcoming: [], stats: { upcomingCount: 0, countriesCount: 0, totalEvents: 0 } };
try {
  const eventsPath = join(process.cwd(), 'public', 'data', 'history', 'events.json');
  eventsData = JSON.parse(readFileSync(eventsPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load Discord data
interface DiscordHistory {
  daily: { date: string; members: number; online: number }[];
}
let discordData: DiscordHistory = { daily: [] };
try {
  const discordPath = join(process.cwd(), 'public', 'data', 'history', 'discord.json');
  discordData = JSON.parse(readFileSync(discordPath, 'utf-8'));
} catch (e) { /* use defaults */ }

const latestDiscord = discordData.daily?.[discordData.daily.length - 1] || { members: 0, online: 0 };

// Filter GitHub data to ONLY real collected data (exclude seed, ossinsight, etc.)
const realGithubData = githubRawLog.entries
  ?.filter(e => e.source === 'github-api')
  .sort((a, b) => a.date.localeCompare(b.date)) || [];

// Calculate velocity metrics from REAL data only
const recentCreatorData = creatorsHistory.weekly?.slice(-12) || [];
const latestCreators = recentCreatorData[recentCreatorData.length - 1];
const prevCreators = recentCreatorData[recentCreatorData.length - 2];

// GitHub stars: only calculate if we have 7+ days of real data
const MIN_DAYS_FOR_GITHUB_TREND = 7;
const hasEnoughGithubData = realGithubData.length >= MIN_DAYS_FOR_GITHUB_TREND;
const githubTrendData = realGithubData.slice(-12).map(d => d.stars);

// Calculate stars per day from real data only
let starsPerDay: number | null = null;
if (realGithubData.length >= 2) {
  const first = realGithubData[0];
  const last = realGithubData[realGithubData.length - 1];
  const daysDiff = Math.max(1, Math.round(
    (new Date(last.date).getTime() - new Date(first.date).getTime()) / (1000 * 60 * 60 * 24)
  ));
  starsPerDay = Math.round((last.stars - first.stars) / daysDiff);
}

// Creators per week (n8n Arena data is all real)
const creatorsPerWeek = latestCreators && prevCreators
  ? latestCreators.total - prevCreators.total
  : null;

// Get weekly data for sparklines (all real from n8n Arena)
const creatorTotals = recentCreatorData.map(d => d.total);
const inserterTotals = recentCreatorData.map(d => d.totalInserters);

// Calculate views → inserters conversion rate (real data)
const conversionRate = latestCreators && latestCreators.totalViews > 0
  ? ((latestCreators.totalInserters / latestCreators.totalViews) * 100).toFixed(1)
  : null;

// Conversion rate trend (real data)
const conversionTrend = recentCreatorData
  .filter(d => d.totalViews > 0)
  .map(d => (d.totalInserters / d.totalViews) * 100);

// Get AI templates count from categories
const latestTemplateData = templatesHistory.daily?.[templatesHistory.daily.length - 1];
const aiTemplates = latestTemplateData?.categories?.['AI'] || 5189;

// Get node stats from latest raw log entry (all templates)
const latestRawEntry = templatesRawLog.entries?.[templatesRawLog.entries.length - 1];
const topNodes = latestRawEntry?.topNodes || [];

// Data status for UI feedback
const dataStatus = {
  github: {
    daysCollected: realGithubData.length,
    daysNeeded: MIN_DAYS_FOR_GITHUB_TREND,
    hasEnough: hasEnoughGithubData,
  },
  creators: {
    weeksCollected: recentCreatorData.length,
    hasEnough: recentCreatorData.length >= 2,
  },
};

// Calculate milestone prediction for GitHub
const nextMilestone = Math.ceil(githubStats.stars / 10000) * 10000;
const starsToMilestone = nextMilestone - githubStats.stars;
const daysToMilestone = starsPerDay && starsPerDay > 0 ? Math.ceil(starsToMilestone / starsPerDay) : null;

// Build timestamp for "last updated"
const buildTime = new Date().toISOString();
---

<BaseLayout title="Dashboard">
  <div class="container-narrow py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <img src="/logo.svg" alt="n8n stats logo" class="h-16 md:h-20 mx-auto mb-6" />
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        The pulse of the <span class="text-n8n-primary">n8n</span> community
      </h1>
      <p class="text-xl text-gray-400 max-w-2xl mx-auto">
        Track ecosystem growth, discover trends, and see what others can't.
      </p>
    </div>

    <!-- Growth Velocity Section - UNIQUE VALUE -->
    <section class="mb-12">
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-2xl font-bold text-white">Growth Velocity</h2>
        <span class="px-2 py-0.5 bg-blue-500/10 text-blue-400 text-xs font-medium rounded">DAILY</span>
      </div>
      <p class="text-gray-400 mb-6">Daily and weekly growth metrics.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <VelocityCard
          label="GitHub Stars"
          value={hasEnoughGithubData && starsPerDay !== null ? `~${starsPerDay}/day` : null}
          subtitle="Repository growth rate"
          trend={githubTrendData}
          color="#ff6d5a"
          to="/github"
          collecting={!hasEnoughGithubData ? {
            current: dataStatus.github.daysCollected,
            needed: dataStatus.github.daysNeeded,
            unit: 'days'
          } : undefined}
        />
        <VelocityCard
          label="New Creators"
          value={creatorsPerWeek !== null ? `+${creatorsPerWeek}/week` : null}
          subtitle="Template authors joining"
          trend={creatorTotals}
          color="#36a2eb"
          to="/creators"
        />
        <VelocityCard
          label="Workflow Inserters"
          value={latestCreators ? formatNumber(latestCreators.totalInserters) : null}
          subtitle="Templates imported by users"
          trend={inserterTotals}
          color="#9966ff"
          to="/templates"
        />
        <VelocityCard
          label="Template Conversion"
          value={conversionRate !== null ? `${conversionRate}%` : null}
          subtitle="Template views → usage"
          trend={conversionTrend}
          color="#4bc0c0"
          to="/creators"
        />
      </div>
    </section>

    <!-- Explore the Ecosystem - Subpage Teasers Grid -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Explore the Ecosystem</h2>
      <p class="text-gray-400 mb-6">Dive deeper into the n8n community data.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Templates -->
        <SubpageTeaserCard
          title="Templates"
          href="/templates"
          mainStat={totalWorkflows}
          mainLabel="workflow templates"
          secondaryStat={aiTemplates}
          secondaryLabel="AI templates"
          accentColor="#ff6d5a"
          ctaText="Browse templates"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Nodes -->
        <SubpageTeaserCard
          title="Nodes"
          href="/nodes"
          mainStat={topNodes.length > 0 ? topNodes[0].name : 'Loading...'}
          mainLabel="most used node"
          secondaryStat={topNodes.length > 0 ? topNodes[0].count : 0}
          secondaryLabel="templates use it"
          accentColor="#36a2eb"
          ctaText="View node stats"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
          </svg>
        </SubpageTeaserCard>

        <!-- Creators -->
        <SubpageTeaserCard
          title="Creators"
          href="/creators"
          mainStat={latestCreators?.total || 0}
          mainLabel="template creators"
          secondaryStat={creatorsPerWeek !== null ? `+${creatorsPerWeek}/week` : undefined}
          secondaryLabel="new creators"
          accentColor="#9966ff"
          ctaText="See leaderboard"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </SubpageTeaserCard>

        <!-- GitHub -->
        <SubpageTeaserCard
          title="GitHub"
          href="/github"
          mainStat={githubStats.stars}
          mainLabel="stars on GitHub"
          secondaryStat={daysToMilestone !== null ? `${daysToMilestone} days` : undefined}
          secondaryLabel={`to ${formatNumber(nextMilestone)}`}
          accentColor="#f97316"
          ctaText="View repo stats"
        >
          <svg slot="icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
          </svg>
        </SubpageTeaserCard>

        <!-- Community -->
        <SubpageTeaserCard
          title="Community"
          href="/community"
          mainStat={latestDiscord.members + forumStats.usersCount}
          mainLabel="total members"
          secondaryStat={latestDiscord.online}
          secondaryLabel="online now"
          accentColor="#10b981"
          ctaText="View community"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </SubpageTeaserCard>

        <!-- Events -->
        <SubpageTeaserCard
          title="Events"
          href="/events"
          mainStat={eventsData.stats.upcomingCount}
          mainLabel="upcoming events"
          secondaryStat={eventsData.stats.countriesCount}
          secondaryLabel="countries"
          accentColor="#8b5cf6"
          ctaText="See events"
        >
          <svg slot="icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </SubpageTeaserCard>
      </div>
    </section>

    <!-- Community & Events Side by Side -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Community & Events</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <CommunityActivityCard
          discordMembers={latestDiscord.members}
          discordOnline={latestDiscord.online}
          forumUsers={forumStats.usersCount}
          forumTopics={forumStats.topicsCount}
        />
        <EventsSpotlightCard
          upcomingEvents={eventsData.upcoming}
          totalUpcoming={eventsData.stats.upcomingCount}
          countriesCount={eventsData.stats.countriesCount}
        />
      </div>
    </section>

    <!-- Trending Templates -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Trending Templates</h2>
          <p class="text-gray-400 text-sm mt-1">Ranked by n8n.io's trending algorithm (recent views + insertions)</p>
        </div>
        <a href="/templates" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {trendingTemplates.map((template) => (
          <TemplateCard template={template} />
        ))}
      </div>
    </section>

    <!-- Top Nodes -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Used Nodes</h2>
          <p class="text-gray-400 text-sm mt-1">Nodes appearing in the most templates across all {formatNumber(totalWorkflows)} workflows</p>
        </div>
        <a href="/nodes" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        {topNodes.slice(0, 5).map((node, index) => (
          <a href="/nodes" class="card text-center hover:border-n8n-primary/50 transition-colors group">
            <div class="text-3xl font-bold text-n8n-primary mb-2">#{index + 1}</div>
            <div class="font-medium text-white group-hover:text-n8n-primary transition-colors">{node.name}</div>
            <div class="text-sm text-gray-400 mt-1">
              {formatNumber(node.count)} templates
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- By the Numbers (Trust Indicators) -->
    <section class="mb-8">
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-xl font-semibold text-gray-300">By the Numbers</h2>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          label="Workflow Templates"
          value={totalWorkflows}
          to="/templates"
        />
        <StatCard
          label="GitHub Stars"
          value={githubStats.stars}
          to="/github"
        />
        <StatCard
          label="Community Members"
          value={latestDiscord.members + forumStats.usersCount}
          to="/community"
        />
        <StatCard
          label="Community Events"
          value={eventsData.stats.totalEvents}
          to="/events"
        />
      </div>
    </section>

    <!-- Footer note -->
    <p class="text-center text-sm text-gray-500 mt-8">
      Last updated: {new Date(buildTime).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZoneName: 'short'
      })}
    </p>
  </div>
</BaseLayout>
