---
import BaseLayout from '@/layouts/BaseLayout.astro';
import StatCard from '@/components/cards/StatCard.astro';
import VelocityCard from '@/components/cards/VelocityCard.astro';
import TemplateCard from '@/components/cards/TemplateCard.astro';
import AIAdoptionCard from '@/components/cards/AIAdoptionCard.astro';
import EcosystemGrowthChart from '@/components/charts/EcosystemGrowthChart.astro';
import { fetchTemplates } from '@/lib/api/n8n';
import { fetchForumStats } from '@/lib/api/discourse';
import { formatNumber, n8nUrls } from '@/lib/utils/formatters';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// Load GitHub stats from stored data (no API calls during build)
let githubStats = { stars: 0, forks: 0, watchers: 0, openIssues: 0, subscribers: 0 };
try {
  const historyPath = join(process.cwd(), 'public', 'data', 'github-history.json');
  if (existsSync(historyPath)) {
    const historyData = JSON.parse(readFileSync(historyPath, 'utf-8'));
    const latest = historyData.monthly?.[historyData.monthly.length - 1];
    if (latest) {
      githubStats = {
        stars: latest.stars || 0,
        forks: latest.forks || 0,
        watchers: latest.watchers || 0,
        openIssues: latest.openIssues || 0,
        subscribers: latest.watchers || 0,
      };
    }
  }
} catch (e) { /* use defaults */ }

// Fetch templates and forum stats at build time (with error handling)
const [templatesResponse, forumStats] = await Promise.all([
  fetchTemplates({ rows: 6, sort: 'trendingScore:desc' }),
  fetchForumStats().catch(() => ({ usersCount: 0, topicsCount: 0, postsCount: 0, likesCount: 0, activeUsers7Days: 0, postsLast7Days: 0 })),
]);

const { totalWorkflows, workflows: trendingTemplates } = templatesResponse;

// Load historical data for velocity calculations
interface CreatorStatsEntry {
  date: string;
  total: number;
  verified: number;
  totalViews: number;
  totalInserters: number;
}

interface GitHubRawEntry {
  date: string;
  stars: number;
  source: string;
}

let creatorsHistory: { weekly: CreatorStatsEntry[] } = { weekly: [] };
let githubRawLog: { entries: GitHubRawEntry[] } = { entries: [] };
let templatesHistory: { daily: { date: string; total: number; categories: Record<string, number> }[] } = { daily: [] };

try {
  const creatorsPath = join(process.cwd(), 'public', 'data', 'history', 'creators-stats.json');
  creatorsHistory = JSON.parse(readFileSync(creatorsPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  // Use raw log to get ONLY real collected data (source: github-api)
  const githubPath = join(process.cwd(), 'public', 'data', 'github-raw-log.json');
  githubRawLog = JSON.parse(readFileSync(githubPath, 'utf-8'));
} catch (e) { /* use defaults */ }

try {
  const templatesPath = join(process.cwd(), 'public', 'data', 'history', 'templates.json');
  templatesHistory = JSON.parse(readFileSync(templatesPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Load templates raw log for AI Agent node count
interface TemplatesRawEntry {
  date: string;
  total: number;
  categories: Record<string, number>;
  topNodes: { name: string; count: number }[];
}
let templatesRawLog: { entries: TemplatesRawEntry[] } = { entries: [] };
try {
  const rawPath = join(process.cwd(), 'public', 'data', 'templates-raw-log.json');
  templatesRawLog = JSON.parse(readFileSync(rawPath, 'utf-8'));
} catch (e) { /* use defaults */ }

// Filter GitHub data to ONLY real collected data (exclude seed, ossinsight, etc.)
const realGithubData = githubRawLog.entries
  ?.filter(e => e.source === 'github-api')
  .sort((a, b) => a.date.localeCompare(b.date)) || [];

// Calculate velocity metrics from REAL data only
const recentCreatorData = creatorsHistory.weekly?.slice(-12) || [];
const latestCreators = recentCreatorData[recentCreatorData.length - 1];
const prevCreators = recentCreatorData[recentCreatorData.length - 2];

// GitHub stars: only calculate if we have 7+ days of real data
const MIN_DAYS_FOR_GITHUB_TREND = 7;
const hasEnoughGithubData = realGithubData.length >= MIN_DAYS_FOR_GITHUB_TREND;
const githubTrendData = realGithubData.slice(-12).map(d => d.stars);

// Calculate stars per day from real data only
let starsPerDay: number | null = null;
if (realGithubData.length >= 2) {
  const first = realGithubData[0];
  const last = realGithubData[realGithubData.length - 1];
  const daysDiff = Math.max(1, Math.round(
    (new Date(last.date).getTime() - new Date(first.date).getTime()) / (1000 * 60 * 60 * 24)
  ));
  starsPerDay = Math.round((last.stars - first.stars) / daysDiff);
}

// Creators per week (n8n Arena data is all real)
const creatorsPerWeek = latestCreators && prevCreators
  ? latestCreators.total - prevCreators.total
  : null;

// Get weekly data for sparklines (all real from n8n Arena)
const creatorTotals = recentCreatorData.map(d => d.total);
const inserterTotals = recentCreatorData.map(d => d.totalInserters);

// Calculate views → inserters conversion rate (real data)
const conversionRate = latestCreators && latestCreators.totalViews > 0
  ? ((latestCreators.totalInserters / latestCreators.totalViews) * 100).toFixed(1)
  : null;

// Conversion rate trend (real data)
const conversionTrend = recentCreatorData
  .filter(d => d.totalViews > 0)
  .map(d => (d.totalInserters / d.totalViews) * 100);

// Get AI templates count from categories
const latestTemplateData = templatesHistory.daily?.[templatesHistory.daily.length - 1];
const aiTemplates = latestTemplateData?.categories?.['AI'] || 5189;

// Get node stats from latest raw log entry (all templates)
const latestRawEntry = templatesRawLog.entries?.[templatesRawLog.entries.length - 1];
const topNodes = latestRawEntry?.topNodes || [];
const aiAgentNode = topNodes.find(n => n.name === 'AI Agent');
const aiAgentTemplates = aiAgentNode?.count || 0;

// Data status for UI feedback
const dataStatus = {
  github: {
    daysCollected: realGithubData.length,
    daysNeeded: MIN_DAYS_FOR_GITHUB_TREND,
    hasEnough: hasEnoughGithubData,
  },
  creators: {
    weeksCollected: recentCreatorData.length,
    hasEnough: recentCreatorData.length >= 2,
  },
};

// Compile stats for trust indicators
const stats = {
  templates: totalWorkflows,
  githubStars: githubStats.stars,
  forumUsers: forumStats.usersCount,
  integrations: 1313, // Hardcoded - scraped from n8n.io/integrations
};

// Build timestamp for "last updated"
const buildTime = new Date().toISOString();
---

<BaseLayout title="Dashboard">
  <div class="container-narrow py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <img src="/logo.svg" alt="n8n stats logo" class="h-16 md:h-20 mx-auto mb-6" />
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        The pulse of the <span class="text-n8n-primary">n8n</span> community
      </h1>
      <p class="text-xl text-gray-400 max-w-2xl mx-auto">
        Track ecosystem growth, discover trends, and see what others can't.
      </p>
    </div>

    <!-- Growth Velocity Section - UNIQUE VALUE -->
    <section class="mb-12">
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-2xl font-bold text-white">Growth Velocity</h2>
        <span class="px-2 py-0.5 bg-blue-500/10 text-blue-400 text-xs font-medium rounded">DAILY</span>
      </div>
      <p class="text-gray-400 mb-6">Daily and weekly growth metrics.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <VelocityCard
          label="GitHub Stars"
          value={hasEnoughGithubData && starsPerDay !== null ? `~${starsPerDay}/day` : null}
          subtitle="Repository growth rate"
          trend={githubTrendData}
          color="#ff6d5a"
          to="/github"
          collecting={!hasEnoughGithubData ? {
            current: dataStatus.github.daysCollected,
            needed: dataStatus.github.daysNeeded,
            unit: 'days'
          } : undefined}
        />
        <VelocityCard
          label="New Creators"
          value={creatorsPerWeek !== null ? `+${creatorsPerWeek}/week` : null}
          subtitle="Template authors joining"
          trend={creatorTotals}
          color="#36a2eb"
          to="/creators"
        />
        <VelocityCard
          label="Workflow Inserters"
          value={latestCreators ? formatNumber(latestCreators.totalInserters) : null}
          subtitle="Templates imported by users"
          trend={inserterTotals}
          color="#9966ff"
          to="/templates"
        />
        <VelocityCard
          label="Template Conversion"
          value={conversionRate !== null ? `${conversionRate}%` : null}
          subtitle="Template views → usage"
          trend={conversionTrend}
          color="#4bc0c0"
          to="/creators"
        />
      </div>
    </section>

    <!-- Ecosystem Insights - 2 column layout -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-white mb-6">Ecosystem Insights</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Creator Economy Growth Chart -->
        <EcosystemGrowthChart height={200} />

        <!-- AI Adoption Visual -->
        <AIAdoptionCard aiTemplates={aiTemplates} totalTemplates={totalWorkflows} aiAgentTemplates={aiAgentTemplates} />
      </div>
    </section>

    <!-- Trending Templates -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Trending Templates</h2>
          <p class="text-gray-400 text-sm mt-1">Ranked by n8n.io's trending algorithm (recent views + insertions)</p>
        </div>
        <a href="/templates" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {trendingTemplates.map((template) => (
          <TemplateCard template={template} />
        ))}
      </div>
    </section>

    <!-- Top Nodes -->
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">Most Used Nodes</h2>
          <p class="text-gray-400 text-sm mt-1">Nodes appearing in the most templates across all {formatNumber(totalWorkflows)} workflows</p>
        </div>
        <a href="/nodes" class="text-n8n-primary hover:underline">
          View all &rarr;
        </a>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        {topNodes.slice(0, 5).map((node, index) => (
          <a href="/nodes" class="card text-center hover:border-n8n-primary/50 transition-colors group">
            <div class="text-3xl font-bold text-n8n-primary mb-2">#{index + 1}</div>
            <div class="font-medium text-white group-hover:text-n8n-primary transition-colors">{node.name}</div>
            <div class="text-sm text-gray-400 mt-1">
              {formatNumber(node.count)} templates
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Trust Indicators (totals) -->
    <section class="mb-8">
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-xl font-semibold text-gray-300">By the Numbers</h2>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          label="Workflow Templates"
          value={stats.templates}
          to="/templates"
        />
        <StatCard
          label="GitHub Stars"
          value={stats.githubStars}
          to="/github"
        />
        <StatCard
          label="Community Members"
          value={stats.forumUsers}
          href={n8nUrls.community()}
        />
        <StatCard
          label="Integrations"
          value={stats.integrations}
          href={n8nUrls.integrations()}
        />
      </div>
    </section>

    <!-- Footer note -->
    <p class="text-center text-sm text-gray-500">
      Last updated: {new Date(buildTime).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZoneName: 'short'
      })}
    </p>
  </div>
</BaseLayout>
