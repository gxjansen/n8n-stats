---
/**
 * Velocity Card
 *
 * Shows rate of change metrics (per day/week) with mini sparkline.
 * Key differentiator - shows momentum, not just totals.
 *
 * Supports a "collecting" state when there's not enough real data.
 */

import MiniSparkline from '@/components/charts/MiniSparkline.astro';

interface Props {
  label: string;
  value: string | null;      // null = still collecting
  subtitle?: string;
  trend: number[];           // Array of values for sparkline
  color?: string;
  href?: string;
  to?: string;
  collecting?: {             // Show collecting state
    current: number;         // Days/weeks collected
    needed: number;          // Days/weeks needed
    unit: string;            // "days" or "weeks"
  };
}

const {
  label,
  value,
  subtitle,
  trend,
  color = '#ff6d5a',
  href,
  to,
  collecting,
} = Astro.props;

const isClickable = href || to;
const linkProps = href
  ? { href, target: '_blank', rel: 'noopener noreferrer' }
  : to
    ? { href: to }
    : {};

// Only show trend analysis if we have enough data points
const hasEnoughData = trend.length >= 2 && !collecting;
const isUpward = hasEnoughData && trend[trend.length - 1] > trend[0];

// Show collecting state if value is null or collecting prop is set
const isCollecting = value === null || collecting;
const displayValue = value ?? 'Collecting...';
---

{isClickable ? (
  <a
    {...linkProps}
    class={`card block transition-all cursor-pointer group ${isCollecting ? 'opacity-75' : 'hover:border-n8n-primary/50 hover:bg-gray-800/50'}`}
  >
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <p class="text-sm text-gray-400 group-hover:text-gray-300 transition-colors truncate">{label}</p>
        <p class={`text-2xl font-bold mt-1 ${isCollecting ? 'text-gray-500' : 'text-white'}`}>
          {displayValue}
        </p>
        {isCollecting && collecting ? (
          <p class="text-xs text-yellow-500/80 mt-1">
            {collecting.current}/{collecting.needed} {collecting.unit} collected
          </p>
        ) : subtitle && (
          <p class="text-xs text-gray-500 mt-1">{subtitle}</p>
        )}
      </div>
      <div class="flex flex-col items-end gap-1">
        {hasEnoughData ? (
          <>
            <MiniSparkline data={trend} color={color} width={64} height={28} />
            <span class={`text-xs ${isUpward ? 'text-green-400' : 'text-gray-500'}`}>
              {isUpward ? 'trending up' : 'stable'}
            </span>
          </>
        ) : (
          <>
            <div class="w-16 h-7 bg-gray-800 rounded flex items-center justify-center">
              <svg class="w-4 h-4 text-gray-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <span class="text-xs text-gray-600">gathering data</span>
          </>
        )}
      </div>
    </div>
  </a>
) : (
  <div class={`card ${isCollecting ? 'opacity-75' : ''}`}>
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <p class="text-sm text-gray-400 truncate">{label}</p>
        <p class={`text-2xl font-bold mt-1 ${isCollecting ? 'text-gray-500' : 'text-white'}`}>
          {displayValue}
        </p>
        {isCollecting && collecting ? (
          <p class="text-xs text-yellow-500/80 mt-1">
            {collecting.current}/{collecting.needed} {collecting.unit} collected
          </p>
        ) : subtitle && (
          <p class="text-xs text-gray-500 mt-1">{subtitle}</p>
        )}
      </div>
      <div class="flex flex-col items-end gap-1">
        {hasEnoughData ? (
          <>
            <MiniSparkline data={trend} color={color} width={64} height={28} />
            <span class={`text-xs ${isUpward ? 'text-green-400' : 'text-gray-500'}`}>
              {isUpward ? 'trending up' : 'stable'}
            </span>
          </>
        ) : (
          <>
            <div class="w-16 h-7 bg-gray-800 rounded flex items-center justify-center">
              <svg class="w-4 h-4 text-gray-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <span class="text-xs text-gray-600">gathering data</span>
          </>
        )}
      </div>
    </div>
  </div>
)}
