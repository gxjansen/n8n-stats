---
/**
 * Interactive Creators History Chart
 *
 * Client-side component that:
 * - Loads history data from /data/history/creators-stats.json
 * - Renders Chart.js line/area chart
 * - Shows total and verified creator growth over time
 */
---

<div id="creators-chart-container" class="card">
  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-4 mb-6">
    <!-- Date Range -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-400">Range:</label>
      <select id="creators-date-range" class="bg-n8n-darker border border-n8n-border rounded px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-n8n-primary">
        <option value="12">Last 12 months</option>
        <option value="24" selected>Last 24 months</option>
        <option value="36">Last 3 years</option>
        <option value="all">All time</option>
      </select>
    </div>

    <!-- Chart Type -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-400">Type:</label>
      <select id="creators-chart-type" class="bg-n8n-darker border border-n8n-border rounded px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-n8n-primary">
        <option value="line">Line</option>
        <option value="area" selected>Area</option>
      </select>
    </div>

    <!-- Metrics Toggle -->
    <div class="flex items-center gap-3 ml-auto">
      <label class="flex items-center gap-1.5 cursor-pointer">
        <input type="checkbox" id="creators-toggle-total" checked class="accent-[#ff6d5a]" />
        <span class="text-sm text-gray-300">Total Creators</span>
      </label>
      <label class="flex items-center gap-1.5 cursor-pointer">
        <input type="checkbox" id="creators-toggle-verified" checked class="accent-[#36a2eb]" />
        <span class="text-sm text-gray-300">Verified</span>
      </label>
    </div>
  </div>

  <!-- Chart Canvas -->
  <div class="relative" style="height: 350px;">
    <canvas id="creators-history-chart"></canvas>
  </div>

  <!-- Loading/Error States -->
  <div id="creators-chart-loading" class="absolute inset-0 flex items-center justify-center bg-n8n-card/80">
    <span class="text-gray-400">Loading chart data...</span>
  </div>
  <div id="creators-chart-error" class="hidden absolute inset-0 flex items-center justify-center bg-n8n-card/80">
    <span class="text-red-400">Failed to load chart data</span>
  </div>
</div>

<script>
  import Chart from 'chart.js/auto';

  interface CreatorStats {
    date: string;
    total: number;
    verified: number;
    totalViews: number;
    totalInserters: number;
  }

  interface CreatorsHistory {
    lastUpdated: string;
    dataSource: {
      name: string;
      repository: string;
      attribution: string;
    };
    daily: CreatorStats[];
    weekly: CreatorStats[];
  }

  let creatorsChart: Chart | null = null;
  let creatorsHistoryData: CreatorsHistory | null = null;

  const CREATORS_COLORS = {
    total: { border: '#ff6d5a', background: 'rgba(255, 109, 90, 0.1)' },
    verified: { border: '#36a2eb', background: 'rgba(54, 162, 235, 0.1)' },
  };

  async function loadCreatorsData(): Promise<CreatorsHistory | null> {
    try {
      const response = await fetch('/data/history/creators-stats.json');
      if (!response.ok) throw new Error('Failed to fetch');
      return await response.json();
    } catch (error) {
      console.error('Failed to load creators history data:', error);
      return null;
    }
  }

  function getCreatorsVisibleMetrics(): string[] {
    const metrics: string[] = [];
    if ((document.getElementById('creators-toggle-total') as HTMLInputElement).checked) metrics.push('total');
    if ((document.getElementById('creators-toggle-verified') as HTMLInputElement).checked) metrics.push('verified');
    return metrics;
  }

  function isCreatorsAreaChart(): boolean {
    return (document.getElementById('creators-chart-type') as HTMLSelectElement).value === 'area';
  }

  function getCreatorsDateRange(): number | 'all' {
    const value = (document.getElementById('creators-date-range') as HTMLSelectElement).value;
    return value === 'all' ? 'all' : parseInt(value, 10);
  }

  function filterCreatorsByMonths(points: CreatorStats[], months: number | 'all'): CreatorStats[] {
    if (months === 'all') return points;
    return points.slice(-months);
  }

  function createCreatorsDatasets(data: CreatorStats[], metrics: string[], isArea: boolean) {
    const metricLabels: Record<string, string> = {
      total: 'Total Creators',
      verified: 'Verified Creators',
    };

    return metrics.map(metric => ({
      label: metricLabels[metric],
      data: data.map(d => d[metric as keyof CreatorStats] as number),
      borderColor: CREATORS_COLORS[metric as keyof typeof CREATORS_COLORS].border,
      backgroundColor: isArea ? CREATORS_COLORS[metric as keyof typeof CREATORS_COLORS].background : CREATORS_COLORS[metric as keyof typeof CREATORS_COLORS].border,
      fill: isArea,
      tension: 0.1,
      pointRadius: data.length > 60 ? 0 : 3,
      pointHoverRadius: 5,
    }));
  }

  function updateCreatorsChart() {
    if (!creatorsHistoryData) return;

    const metrics = getCreatorsVisibleMetrics();
    const isArea = isCreatorsAreaChart();
    const range = getCreatorsDateRange();

    // Use weekly data filtered by date range
    const filteredData = filterCreatorsByMonths(creatorsHistoryData.weekly, range);

    const labels = filteredData.map(d => d.date);
    const datasets = createCreatorsDatasets(filteredData, metrics, isArea);

    if (creatorsChart) {
      creatorsChart.data.labels = labels;
      creatorsChart.data.datasets = datasets;
      creatorsChart.update();
    }
  }

  async function initCreatorsChart() {
    const canvas = document.getElementById('creators-history-chart') as HTMLCanvasElement;
    const loadingEl = document.getElementById('creators-chart-loading');
    const errorEl = document.getElementById('creators-chart-error');

    creatorsHistoryData = await loadCreatorsData();

    loadingEl?.classList.add('hidden');

    if (!creatorsHistoryData) {
      errorEl?.classList.remove('hidden');
      return;
    }

    if (creatorsHistoryData.weekly.length === 0) {
      errorEl?.classList.remove('hidden');
      return;
    }

    const metrics = getCreatorsVisibleMetrics();
    const isArea = isCreatorsAreaChart();
    const range = getCreatorsDateRange();

    const filteredData = filterCreatorsByMonths(creatorsHistoryData.weekly, range);
    const labels = filteredData.map(d => d.date);
    const datasets = createCreatorsDatasets(filteredData, metrics, isArea);

    creatorsChart = new Chart(canvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              color: '#9ca3af',
              usePointStyle: true,
              padding: 20,
            },
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            borderColor: '#333',
            borderWidth: 1,
            callbacks: {
              label: (context) => {
                const value = context.parsed.y;
                return `${context.dataset.label}: ${value.toLocaleString()}`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#6b7280', maxRotation: 45 },
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#6b7280',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                }
                return value;
              },
            },
          },
        },
      },
    });

    // Attach event listeners
    document.getElementById('creators-date-range')?.addEventListener('change', updateCreatorsChart);
    document.getElementById('creators-chart-type')?.addEventListener('change', updateCreatorsChart);
    document.getElementById('creators-toggle-total')?.addEventListener('change', updateCreatorsChart);
    document.getElementById('creators-toggle-verified')?.addEventListener('change', updateCreatorsChart);
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCreatorsChart);
  } else {
    initCreatorsChart();
  }
</script>

<style>
  #creators-chart-container {
    position: relative;
  }
</style>
