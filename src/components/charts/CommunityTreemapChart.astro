---
/**
 * Community Category Treemap Chart
 *
 * Visualizes forum category distribution as a treemap where:
 * - Rectangle size = number of topics in category
 * - Color = distinct color per category (colorblind-friendly)
 * - Click opens the category on community.n8n.io
 */
import { COMMUNITY_CATEGORY_COLORS, FALLBACK_COLORS } from '@/lib/utils/colors';

interface CategoryData {
  name: string;
  slug: string;
  id: number;
  topicCount: number;
  postCount: number;
  description?: string;
}

interface Props {
  data: CategoryData[];
}

const { data } = Astro.props;

// Pass colors to client-side script
const categoryColors = COMMUNITY_CATEGORY_COLORS;
const fallbackColors = FALLBACK_COLORS;
---

<div id="community-treemap-container" class="card">
  <div class="relative" style="height: 350px;">
    <canvas id="community-treemap-chart"></canvas>
  </div>
  <p class="text-xs text-gray-500 mt-2 text-center">
    Click a category to view it on community.n8n.io
  </p>
  <div id="community-treemap-loading" class="absolute inset-0 flex items-center justify-center bg-n8n-card/80">
    <span class="text-gray-400">Loading treemap...</span>
  </div>
</div>

<script define:vars={{ data, categoryColors, fallbackColors }}>
  window.__communityTreemapData = data;
  window.__communityColors = categoryColors;
  window.__communityFallbackColors = fallbackColors;
</script>

<script>
  import { Chart } from '../../lib/utils/chartRegistry';
  import { TreemapController, TreemapElement } from 'chartjs-chart-treemap';
  import { initChartWhenVisible } from '../../lib/utils/lazyChart';

  // Register treemap plugin (not in shared registry as only treemap charts use it)
  Chart.register(TreemapController, TreemapElement);

  interface CategoryData {
    name: string;
    slug: string;
    id: number;
    topicCount: number;
    postCount: number;
    description?: string;
  }

  // Colorblind-friendly palette passed from server (WCAG AA compliant)
  const CATEGORY_COLORS: Record<string, string> = (window as any).__communityColors || {};

  // Fallback colors - colorblind-friendly spectrum (WCAG AA compliant)
  const FALLBACK_COLORS: string[] = (window as any).__communityFallbackColors || [];

  // ============================================================================
  // WCAG Contrast Utilities (client-side)
  // ============================================================================

  function hexToRgb(hex: string): { r: number; g: number; b: number } {
    const cleanHex = hex.replace('#', '');
    return {
      r: parseInt(cleanHex.substring(0, 2), 16),
      g: parseInt(cleanHex.substring(2, 4), 16),
      b: parseInt(cleanHex.substring(4, 6), 16),
    };
  }

  function getLuminance(hex: string): number {
    const { r, g, b } = hexToRgb(hex);
    const rsRGB = r / 255;
    const gsRGB = g / 255;
    const bsRGB = b / 255;
    const rLinear = rsRGB <= 0.03928 ? rsRGB / 12.92 : Math.pow((rsRGB + 0.055) / 1.055, 2.4);
    const gLinear = gsRGB <= 0.03928 ? gsRGB / 12.92 : Math.pow((gsRGB + 0.055) / 1.055, 2.4);
    const bLinear = bsRGB <= 0.03928 ? bsRGB / 12.92 : Math.pow((bsRGB + 0.055) / 1.055, 2.4);
    return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear;
  }

  function getContrastRatio(hex1: string, hex2: string): number {
    const lum1 = getLuminance(hex1);
    const lum2 = getLuminance(hex2);
    const lighter = Math.max(lum1, lum2);
    const darker = Math.min(lum1, lum2);
    return (lighter + 0.05) / (darker + 0.05);
  }

  function getAccessibleTextColor(bgHex: string): string {
    const WHITE = '#FFFFFF';
    const BLACK = '#000000';
    const whiteContrast = getContrastRatio(bgHex, WHITE);
    // WCAG AA requires 4.5:1 for normal text
    return whiteContrast >= 4.5 ? WHITE : BLACK;
  }

  function getColorForCategory(name: string, index: number): string {
    // Check for partial matches in category names
    for (const [key, color] of Object.entries(CATEGORY_COLORS)) {
      if (name.toLowerCase().includes(key.toLowerCase())) {
        return color;
      }
    }
    return FALLBACK_COLORS[index % FALLBACK_COLORS.length] || '#666666';
  }

  // Build a color map for quick lookup
  let categoryColorMap: Record<string, string> = {};

  function initTreemap() {
    const canvas = document.getElementById('community-treemap-chart') as HTMLCanvasElement;
    const loadingEl = document.getElementById('community-treemap-loading');
    const data = (window as any).__communityTreemapData as CategoryData[];

    if (!data || data.length === 0) {
      loadingEl?.classList.add('hidden');
      return;
    }

    loadingEl?.classList.add('hidden');

    // Build color map from category names
    data.forEach((item, index) => {
      categoryColorMap[item.name] = getColorForCategory(item.name, index);
    });

    // Transform data for treemap
    const treemapData = data.map((item) => ({
      ...item,
      count: item.topicCount,
    }));

    const chart = new Chart(canvas, {
      type: 'treemap',
      data: {
        datasets: [{
          label: 'Topics by Category',
          tree: treemapData,
          key: 'count',
          groups: ['name'],
          backgroundColor: (ctx: any) => {
            if (ctx.type !== 'data') return 'transparent';
            const item = ctx.raw;
            // Get category name from grouped data (g) or _data
            const name = item.g || item._data?.name || '';
            return categoryColorMap[name] || '#7c3aed';
          },
          borderColor: '#1a1a2e',
          borderWidth: 2,
          spacing: 2,
          labels: {
            display: true,
            align: 'center',
            position: 'middle',
            formatter: (ctx: any) => {
              const item = ctx.raw;
              if (item.w < 80 || item.h < 40) return '';
              const name = item._data?.name || item.g || '';
              const count = item._data?.count || item.v || 0;
              return [name, count.toLocaleString() + ' topics'];
            },
            // Dynamic text color based on background luminance (WCAG AA compliant)
            color: (ctx: any) => {
              if (ctx.type !== 'data') return '#fff';
              const item = ctx.raw;
              const name = item.g || item._data?.name || '';
              const bgColor = categoryColorMap[name] || '#666666';
              return getAccessibleTextColor(bgColor);
            },
            font: {
              size: 11,
              weight: 'bold',
            },
          },
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        onClick: (_event: any, elements: any[]) => {
          if (elements.length > 0) {
            const element = elements[0];
            const item = (chart.data.datasets[0] as any).tree[element.index];
            const slug = item?.slug;
            const id = item?.id;
            if (slug && id) {
              const url = `https://community.n8n.io/c/${slug}/${id}?utm_source=n8n-stats-by-guido-jansen&utm_medium=website&utm_campaign=community`;
              window.open(url, '_blank', 'noopener,noreferrer');
            }
          }
        },
        onHover: (event: any, elements: any[]) => {
          const target = event.native?.target as HTMLElement;
          if (target) {
            target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
          }
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            borderColor: '#333',
            borderWidth: 1,
            callbacks: {
              title: (items: any[]) => {
                if (!items.length) return '';
                const item = items[0].raw;
                return item._data?.name || item.g || '';
              },
              label: (ctx: any) => {
                const item = ctx.raw;
                const topics = item._data?.topicCount || item._data?.count || item.v || 0;
                const posts = item._data?.postCount || 0;
                return [
                  `${topics.toLocaleString()} topics`,
                  `${posts.toLocaleString()} posts`,
                ];
              },
              afterLabel: () => 'Click to view category',
            },
          },
        },
      },
    });
  }

  // Initialize when DOM is ready and chart is visible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initChartWhenVisible('community-treemap-container', initTreemap);
    });
  } else {
    initChartWhenVisible('community-treemap-container', initTreemap);
  }
</script>

<style>
  #community-treemap-container {
    position: relative;
  }
</style>
