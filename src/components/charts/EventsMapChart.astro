---
/**
 * Events Map Chart
 * Displays event locations on a world map using equirectangular projection
 *
 * Map source: NASA Blue Marble (public domain)
 * https://visibleearth.nasa.gov/collection/1484/blue-marble
 */

interface Location {
  name: string;
  city: string;
  country: string;
  lat: number;
  lng: number;
  eventCount: number;
  totalRegistrations: number;
}

interface Props {
  locations: Location[];
}

const { locations } = Astro.props;

// Map dimensions (2:1 ratio for equirectangular projection)
const mapWidth = 800;
const mapHeight = 400;

// Standard equirectangular projection formula
// Maps longitude -180 to +180 across width, latitude +90 to -90 across height
function latLngToXY(lat: number, lng: number): { x: number; y: number } {
  const x = ((lng + 180) / 360) * mapWidth;
  const y = ((90 - lat) / 180) * mapHeight;
  return { x, y };
}

// Process locations for display
const markers = locations.map(loc => {
  const { x, y } = latLngToXY(loc.lat, loc.lng);
  // Size based on event count (min 4, max 10)
  const size = Math.min(10, Math.max(4, 2 + loc.eventCount * 1.2));
  return {
    ...loc,
    x,
    y,
    size,
  };
});

const viewBox = `0 0 ${mapWidth} ${mapHeight}`;
---

<div id="events-map-container" class="card">
  <div class="relative overflow-hidden rounded-lg">
    <svg
      viewBox={viewBox}
      class="w-full h-auto"
      style="max-height: 450px;"
    >
      <!-- World map background (NASA Blue Marble, equirectangular projection) -->
      <image
        href="/images/world-equirect.jpg"
        x="0"
        y="0"
        width={mapWidth}
        height={mapHeight}
        preserveAspectRatio="none"
        class="map-image"
      />

      <!-- Event markers -->
      <g class="markers">
        {markers.map((marker, index) => (
          <g
            class="marker-group"
            data-city={marker.city}
            data-country={marker.country}
            data-events={marker.eventCount}
            data-registrations={marker.totalRegistrations}
          >
            <!-- Glow effect -->
            <circle
              cx={marker.x}
              cy={marker.y}
              r={marker.size + 5}
              fill="url(#markerGlow)"
              opacity="0.7"
            />
            <!-- Main marker -->
            <circle
              cx={marker.x}
              cy={marker.y}
              r={marker.size}
              fill="#ff6d5a"
              stroke="#fff"
              stroke-width="1.5"
              class="marker"
              style={`animation-delay: ${index * 50}ms`}
            />
            <!-- Event count label for larger markers -->
            {marker.eventCount > 1 && (
              <text
                x={marker.x}
                y={marker.y + 3}
                text-anchor="middle"
                fill="#fff"
                font-size="8"
                font-weight="bold"
              >
                {marker.eventCount}
              </text>
            )}
          </g>
        ))}
      </g>

      <!-- Gradient definitions -->
      <defs>
        <radialGradient id="markerGlow">
          <stop offset="0%" stop-color="#ff6d5a" stop-opacity="0.8" />
          <stop offset="100%" stop-color="#ff6d5a" stop-opacity="0" />
        </radialGradient>
      </defs>
    </svg>

    <!-- Tooltip -->
    <div
      id="map-tooltip"
      class="absolute hidden bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm shadow-xl pointer-events-none z-10"
    >
      <div class="font-semibold text-white" id="tooltip-city"></div>
      <div class="text-gray-400 text-xs" id="tooltip-country"></div>
      <div class="text-n8n-primary mt-1 font-medium" id="tooltip-events"></div>
    </div>
  </div>

  <!-- Legend -->
  <div class="flex items-center justify-center gap-6 mt-4 text-sm text-gray-400">
    <div class="flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-[#ff6d5a]"></span>
      <span>Event location</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-5 h-5 rounded-full bg-[#ff6d5a] flex items-center justify-center text-xs text-white font-bold">3</span>
      <span>Multiple events</span>
    </div>
  </div>
</div>

<style>
  /* Dark theme filter for the map image */
  .map-image {
    filter: brightness(0.4) saturate(0.6) hue-rotate(180deg);
  }

  .marker {
    cursor: pointer;
    transition: transform 0.2s ease;
    transform-origin: center;
  }

  .marker-group:hover .marker {
    transform: scale(1.3);
  }

  .marker {
    animation: markerPulse 3s ease-in-out infinite;
  }

  @keyframes markerPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.75; }
  }
</style>

<script>
  function initMapTooltip() {
    const tooltip = document.getElementById('map-tooltip');
    const tooltipCity = document.getElementById('tooltip-city');
    const tooltipCountry = document.getElementById('tooltip-country');
    const tooltipEvents = document.getElementById('tooltip-events');
    const markers = document.querySelectorAll('.marker-group');

    if (!tooltip || !tooltipCity || !tooltipCountry || !tooltipEvents) return;

    markers.forEach(marker => {
      marker.addEventListener('mouseenter', (e) => {
        const city = marker.getAttribute('data-city') || 'Unknown';
        const country = marker.getAttribute('data-country') || '';
        const events = marker.getAttribute('data-events') || '1';
        const registrations = marker.getAttribute('data-registrations') || '0';

        tooltipCity.textContent = city || country;
        tooltipCountry.textContent = country;
        tooltipEvents.textContent = `${events} event${parseInt(events) !== 1 ? 's' : ''} Â· ${parseInt(registrations).toLocaleString()} registrations`;

        tooltip.classList.remove('hidden');
      });

      marker.addEventListener('mousemove', (e) => {
        const container = document.getElementById('events-map-container');
        if (!container) return;

        const rect = container.getBoundingClientRect();
        const mouseEvent = e as MouseEvent;
        const x = mouseEvent.clientX - rect.left;
        const y = mouseEvent.clientY - rect.top;

        // Position tooltip, keeping it within bounds
        const tooltipRect = tooltip.getBoundingClientRect();
        let left = x + 15;
        let top = y - 10;

        if (left + tooltipRect.width > rect.width) {
          left = x - tooltipRect.width - 15;
        }

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
      });

      marker.addEventListener('mouseleave', () => {
        tooltip.classList.add('hidden');
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMapTooltip);
  } else {
    initMapTooltip();
  }
</script>
