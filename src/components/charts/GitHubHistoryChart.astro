---
/**
 * Interactive GitHub History Chart
 *
 * Renders Chart.js line/area chart for cumulative stars
 * with optional monthly new star bars overlay.
 * Data is loaded at build time for instant rendering.
 */

import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

interface GitHubDataPoint {
  date: string;
  stars: number;
  forks: number;
  watchers: number;
  openIssues: number;
  source?: string;
}

interface GitHubHistory {
  lastUpdated: string;
  daily: GitHubDataPoint[];
  weekly: GitHubDataPoint[];
  monthly: GitHubDataPoint[];
}

interface ChartDataPoint {
  date: string;
  stars: number;
  newStars: number;
  source?: string;
}

// Load data at build time
let chartDataPoints: ChartDataPoint[] = [];
try {
  const dataPath = join(process.cwd(), 'public', 'data', 'github-history.json');
  if (existsSync(dataPath)) {
    const data: GitHubHistory = JSON.parse(readFileSync(dataPath, 'utf-8'));
    chartDataPoints = data.monthly.map((point, index) => {
      const prevStars = index > 0 ? data.monthly[index - 1].stars : point.stars;
      return {
        date: point.date,
        stars: point.stars,
        newStars: Math.max(0, point.stars - prevStars),
        source: point.source,
      };
    });
  }
} catch (e) { /* use empty array */ }

const chartDataJson = JSON.stringify(chartDataPoints);
---

<div id="github-chart-container" class="card">
  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-4 mb-6">
    <!-- Date Range -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-400">Range:</label>
      <select id="date-range" class="bg-n8n-darker border border-n8n-border rounded px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-n8n-primary">
        <option value="12">Last 12 months</option>
        <option value="24" selected>Last 24 months</option>
        <option value="36">Last 3 years</option>
        <option value="all">All time</option>
      </select>
    </div>

    <!-- Chart Type -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-400">Type:</label>
      <select id="chart-type" class="bg-n8n-darker border border-n8n-border rounded px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-n8n-primary">
        <option value="line">Line</option>
        <option value="area" selected>Area</option>
      </select>
    </div>

    <!-- Show Monthly New Toggle -->
    <label class="flex items-center gap-2 cursor-pointer">
      <input type="checkbox" id="github-show-monthly" checked class="w-4 h-4 rounded border-gray-600 bg-n8n-darker text-n8n-primary focus:ring-n8n-primary focus:ring-offset-0">
      <span class="text-sm text-gray-400">Show monthly new</span>
    </label>

    <!-- Show Milestones Toggle -->
    <label class="flex items-center gap-1.5 cursor-pointer ml-auto">
      <input type="checkbox" id="github-toggle-milestones" checked class="accent-[#ff6384]" />
      <span class="text-sm text-gray-300">Show milestones</span>
    </label>
  </div>

  <!-- Chart Canvas -->
  <div class="relative h-[300px] md:h-[400px]">
    <canvas id="github-history-chart"></canvas>
  </div>

  <!-- Legend -->
  <div id="github-chart-legend" class="flex items-center justify-center gap-6 mt-4 text-sm">
    <div class="flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-[#ff6384]"></span>
      <span class="text-gray-400">Total Stars</span>
    </div>
    <div id="github-legend-monthly" class="flex items-center gap-2">
      <span class="w-3 h-3 rounded bg-[#4bc0c0]"></span>
      <span class="text-gray-400">New This Month</span>
    </div>
  </div>

  <!-- Legend note for scaled data -->
  <p id="github-chart-note" class="text-xs text-gray-500 mt-2 text-center">
    <span class="inline-block border-t-2 border-dashed border-gray-400 w-4 align-middle mr-1"></span>
    Dashed lines indicate scaled historical data from ossinsight.io
  </p>

  <!-- No Data State (only shown if build-time data is empty) -->
  <div id="chart-no-data" class="hidden absolute inset-0 flex items-center justify-center bg-n8n-card/80">
    <span class="text-gray-400">No historical data yet. Check back tomorrow!</span>
  </div>
</div>

<script define:vars={{ chartDataJson }}>
  window.__githubChartData = JSON.parse(chartDataJson);
</script>

<script>
  import { Chart } from '../../lib/utils/chartRegistry';
  import { axisTruncationPlugin } from '../../lib/utils/chartPlugins';
  import { initChartWhenVisible } from '../../lib/utils/lazyChart';
  import annotationPlugin from 'chartjs-plugin-annotation';

  // Register plugins
  Chart.register(axisTruncationPlugin);
  Chart.register(annotationPlugin);

  interface ChartDataPoint {
    date: string;
    stars: number;
    newStars: number;
    source?: string;
  }

  let chart: Chart | null = null;
  // Data is loaded at build time and passed via define:vars
  let chartData: ChartDataPoint[] = (window as any).__githubChartData || [];

  const COLORS = {
    stars: { border: '#ff6384', background: 'rgba(255, 99, 132, 0.1)' },
    newStars: { border: '#4bc0c0', background: 'rgba(75, 192, 192, 0.6)' },
  };

  // Key milestones to annotate (stars)
  const MILESTONES = [
    { value: 10000, label: '10K' },
    { value: 25000, label: '25K' },
    { value: 50000, label: '50K' },
    { value: 75000, label: '75K' },
    { value: 100000, label: '100K' },
    { value: 150000, label: '150K' },
    { value: 200000, label: '200K' },
  ];

  // Sources that indicate scaled/estimated data
  const SCALED_SOURCES = ['ossinsight'];

  function isScaledData(source?: string): boolean {
    return SCALED_SOURCES.includes(source || '');
  }

  function filterByMonths(points: ChartDataPoint[], months: number | 'all'): ChartDataPoint[] {
    if (months === 'all') return points;
    return points.slice(-months);
  }

  function isAreaChart(): boolean {
    return (document.getElementById('chart-type') as HTMLSelectElement).value === 'area';
  }

  function getDateRange(): number | 'all' {
    const value = (document.getElementById('date-range') as HTMLSelectElement).value;
    return value === 'all' ? 'all' : parseInt(value, 10);
  }

  function showMonthly(): boolean {
    return (document.getElementById('github-show-monthly') as HTMLInputElement).checked;
  }

  function showMilestones(): boolean {
    return (document.getElementById('github-toggle-milestones') as HTMLInputElement)?.checked ?? true;
  }

  function createMilestoneAnnotations(data: ChartDataPoint[]) {
    if (!showMilestones()) return {};

    const annotations: Record<string, any> = {};
    const maxValue = Math.max(...data.map(d => d.stars));

    MILESTONES.forEach((milestone, idx) => {
      if (milestone.value <= maxValue) {
        annotations[`milestone-${idx}`] = {
          type: 'line',
          yMin: milestone.value,
          yMax: milestone.value,
          borderColor: 'rgba(255, 99, 132, 0.3)',
          borderWidth: 1,
          borderDash: [5, 5],
          label: {
            display: true,
            content: milestone.label,
            position: 'start',
            backgroundColor: 'rgba(255, 99, 132, 0.8)',
            color: '#fff',
            font: { size: 10 },
            padding: 2,
          },
        };
      }
    });

    return annotations;
  }

  function updateChart() {
    if (chartData.length === 0) return;

    const range = getDateRange();
    const isArea = isAreaChart();
    const includeMonthly = showMonthly();

    const filteredData = filterByMonths(chartData, range);

    if (filteredData.length === 0) {
      document.getElementById('chart-no-data')?.classList.remove('hidden');
      return;
    }
    document.getElementById('chart-no-data')?.classList.add('hidden');

    // Show/hide monthly legend
    const monthlyLegend = document.getElementById('github-legend-monthly');
    if (includeMonthly) {
      monthlyLegend?.classList.remove('hidden');
    } else {
      monthlyLegend?.classList.add('hidden');
    }

    const labels = filteredData.map(d => d.date);
    const datasets: any[] = [{
      label: 'Total Stars',
      data: filteredData.map(d => d.stars),
      borderColor: COLORS.stars.border,
      backgroundColor: isArea ? COLORS.stars.background : COLORS.stars.border,
      fill: isArea,
      tension: 0.1,
      pointRadius: filteredData.length > 60 ? 0 : 3,
      pointHoverRadius: 5,
      yAxisID: 'y',
      type: 'line',
      order: 1,
      // Use dashed line segments for scaled/estimated data
      segment: {
        borderDash: (ctx: any) => {
          const index = ctx.p0DataIndex;
          const isEstimated = isScaledData(filteredData[index]?.source) ||
                              isScaledData(filteredData[index + 1]?.source);
          return isEstimated ? [5, 5] : [];
        },
      },
    }];

    if (includeMonthly) {
      datasets.push({
        label: 'New This Month',
        data: filteredData.map(d => d.newStars),
        borderColor: COLORS.newStars.border,
        backgroundColor: COLORS.newStars.background,
        type: 'bar',
        yAxisID: 'y1',
        order: 2,
      });
    }

    if (chart) {
      chart.data.labels = labels;
      chart.data.datasets = datasets;
      if ((chart.options.scales as any)?.y1) {
        (chart.options.scales as any).y1.display = includeMonthly;
      }
      // Update annotations
      const annotations = createMilestoneAnnotations(filteredData);
      if (chart.options.plugins?.annotation) {
        (chart.options.plugins.annotation as any).annotations = annotations;
      }
      chart.update();
    }
  }

  function initChart() {
    const canvas = document.getElementById('github-history-chart') as HTMLCanvasElement;
    const noDataEl = document.getElementById('chart-no-data');

    if (chartData.length === 0) {
      noDataEl?.classList.remove('hidden');
      return;
    }

    const range = getDateRange();
    const isArea = isAreaChart();
    const includeMonthly = showMonthly();

    const filteredData = filterByMonths(chartData, range);
    const labels = filteredData.map(d => d.date);
    const datasets: any[] = [{
      label: 'Total Stars',
      data: filteredData.map(d => d.stars),
      borderColor: COLORS.stars.border,
      backgroundColor: isArea ? COLORS.stars.background : COLORS.stars.border,
      fill: isArea,
      tension: 0.1,
      pointRadius: filteredData.length > 60 ? 0 : 3,
      pointHoverRadius: 5,
      yAxisID: 'y',
      type: 'line',
      order: 1,
      segment: {
        borderDash: (ctx: any) => {
          const index = ctx.p0DataIndex;
          const isEstimated = isScaledData(filteredData[index]?.source) ||
                              isScaledData(filteredData[index + 1]?.source);
          return isEstimated ? [5, 5] : [];
        },
      },
    }];

    if (includeMonthly) {
      datasets.push({
        label: 'New This Month',
        data: filteredData.map(d => d.newStars),
        borderColor: COLORS.newStars.border,
        backgroundColor: COLORS.newStars.background,
        type: 'bar',
        yAxisID: 'y1',
        order: 2,
      });
    }

    const annotations = createMilestoneAnnotations(filteredData);

    chart = new Chart(canvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: false,
          },
          annotation: {
            annotations,
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            borderColor: '#333',
            borderWidth: 1,
            callbacks: {
              label: (context) => {
                const value = context.parsed.y;
                const dataIndex = context.dataIndex;
                const dataPoint = filteredData[dataIndex];
                const isScaled = isScaledData(dataPoint?.source);

                if (context.dataset.label === 'Total Stars') {
                  const suffix = isScaled ? ' (scaled)' : '';
                  return `Stars: ${value.toLocaleString()}${suffix}`;
                }
                return `${context.dataset.label}: ${value.toLocaleString()}`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#9ca3af', maxRotation: 45 },
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#9ca3af',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                }
                return value;
              },
            },
            title: {
              display: true,
              text: 'Total Stars',
              color: '#9ca3af',
            },
          },
          y1: {
            type: 'linear',
            display: includeMonthly,
            position: 'right',
            beginAtZero: true,
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#4bc0c0',
              callback: (value) => {
                if (typeof value === 'number') {
                  if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                }
                return value;
              },
            },
            title: {
              display: true,
              text: 'New / Month',
              color: '#4bc0c0',
            },
          },
        },
      },
    });

    // Attach event listeners
    document.getElementById('date-range')?.addEventListener('change', updateChart);
    document.getElementById('chart-type')?.addEventListener('change', updateChart);
    document.getElementById('github-show-monthly')?.addEventListener('change', updateChart);
    document.getElementById('github-toggle-milestones')?.addEventListener('change', updateChart);
  }

  // Initialize when DOM is ready and chart is visible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initChartWhenVisible('github-chart-container', initChart);
    });
  } else {
    initChartWhenVisible('github-chart-container', initChart);
  }
</script>

<style>
  #github-chart-container {
    position: relative;
  }
</style>
