---
/**
 * Events History Chart
 * Shows monthly event counts and participant registrations
 * Split by in-person vs online events
 */

import SourceInfo from '@/components/SourceInfo.astro';

interface SourceAttribution {
  source: string;
  url?: string;
  note?: string;
}

interface MonthlyData {
  month: string;
  count: number;
  registrations: number;
  inPersonCount?: number;
  inPersonRegistrations?: number;
  onlineCount?: number;
  onlineRegistrations?: number;
}

interface Props {
  data: MonthlyData[];
  /** Minimum month to show (YYYY-MM format), filters out earlier months */
  startMonth?: string;
  source?: SourceAttribution;
}

const { data, startMonth = '2024-06', source } = Astro.props;

// Filter data to only show months from startMonth onwards
// and only months that have at least one event with registration data
const chartData = data
  .filter(d => d.month >= startMonth)
  .filter(d => {
    // Keep months that have at least one event type with registrations > 0
    // OR at least one event (to show event counts even without registration data)
    const hasInPersonData = (d.inPersonCount || 0) > 0;
    const hasOnlineData = (d.onlineCount || 0) > 0;
    return hasInPersonData || hasOnlineData;
  });
---

<div id="events-history-container" class="card relative">
  {source && (
    <SourceInfo source={source.source} url={source.url} note={source.note} />
  )}
  {chartData.length === 0 ? (
    <div class="flex items-center justify-center h-64 text-gray-400">
      <p>No historical event data available yet. Check back after more events are tracked.</p>
    </div>
  ) : (
    <>
      <div class="relative h-[280px] md:h-[350px]">
        <canvas id="events-history-chart"></canvas>
      </div>
      <p class="text-xs text-gray-500 mt-2 text-center">
        Events tracked from the n8n Community Events calendar on Luma. Zero registrations indicates missing data.
      </p>
    </>
  )}
</div>

<script define:vars={{ chartData }}>
  // Make data available to the client-side script
  window.eventsChartData = chartData;
</script>

<script>
  import { Chart } from '../../lib/utils/chartRegistry';
  import { axisTruncationPlugin } from '../../lib/utils/chartPlugins';
  import { initChartWhenVisible } from '../../lib/utils/lazyChart';

  // Register project-specific plugin
  Chart.register(axisTruncationPlugin);

  interface MonthlyData {
    month: string;
    count: number;
    registrations: number;
    inPersonCount?: number;
    inPersonRegistrations?: number;
    onlineCount?: number;
    onlineRegistrations?: number;
  }

  declare global {
    interface Window {
      eventsChartData: MonthlyData[];
    }
  }

  function initEventsChart() {
    const canvas = document.getElementById('events-history-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const data = window.eventsChartData || [];
    if (data.length === 0) return;

    // Format month labels (e.g., "2024-01" -> "Jan 2024")
    const formatMonth = (monthStr: string) => {
      const [year, month] = monthStr.split('-');
      const date = new Date(parseInt(year), parseInt(month) - 1);
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    };

    const labels = data.map(d => formatMonth(d.month));

    // In-person data
    const inPersonCounts = data.map(d => d.inPersonCount || 0);
    const inPersonRegs = data.map(d => {
      // Treat 0 registrations as null (missing data) if there were events
      const count = d.inPersonCount || 0;
      const regs = d.inPersonRegistrations || 0;
      if (count > 0 && regs === 0) return null;
      return regs > 0 ? regs : null;
    });

    // Online data
    const onlineCounts = data.map(d => d.onlineCount || 0);
    const onlineRegs = data.map(d => {
      // Treat 0 registrations as null (missing data) if there were events
      const count = d.onlineCount || 0;
      const regs = d.onlineRegistrations || 0;
      if (count > 0 && regs === 0) return null;
      return regs > 0 ? regs : null;
    });

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          // In-person events (bars)
          {
            label: 'In-Person Events',
            data: inPersonCounts,
            backgroundColor: '#f97316',
            borderColor: '#f97316',
            borderWidth: 1,
            borderRadius: 4,
            hoverBackgroundColor: '#fb923c',
            yAxisID: 'y',
            order: 3,
            stack: 'events',
          },
          // Online events (bars, stacked)
          {
            label: 'Online Events',
            data: onlineCounts,
            backgroundColor: '#8b5cf6',
            borderColor: '#8b5cf6',
            borderWidth: 1,
            borderRadius: 4,
            hoverBackgroundColor: '#a78bfa',
            yAxisID: 'y',
            order: 4,
            stack: 'events',
          },
          // In-person registrations (line)
          {
            label: 'In-Person Participants',
            data: inPersonRegs,
            type: 'line',
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#22c55e',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
            order: 1,
            spanGaps: true, // Connect line across null values
          },
          // Online registrations (line)
          {
            label: 'Online Participants',
            data: onlineRegs,
            type: 'line',
            borderColor: '#06b6d4',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#06b6d4',
            fill: false,
            tension: 0.3,
            yAxisID: 'y1',
            order: 2,
            spanGaps: true, // Connect line across null values
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#9ca3af',
              usePointStyle: true,
              padding: 15,
              font: { size: 11 },
            },
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            titleColor: '#fff',
            bodyColor: '#9ca3af',
            borderColor: '#333',
            borderWidth: 1,
            callbacks: {
              label: (context) => {
                const value = context.parsed.y;
                const label = context.dataset.label || '';

                if (value === null) {
                  return `${label}: No data`;
                }

                if (label.includes('Events')) {
                  return `${label}: ${value} event${value !== 1 ? 's' : ''}`;
                }
                return `${label}: ${value.toLocaleString()}`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#9ca3af',
              maxRotation: 45,
            },
            stacked: true,
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            stacked: true,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: {
              color: '#f97316',
              stepSize: 5,
              callback: (value) => {
                if (Number.isInteger(value)) {
                  return value;
                }
                return null;
              },
            },
            title: {
              display: true,
              text: 'Events',
              color: '#f97316',
            },
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              color: '#22c55e',
              callback: (value) => {
                if (typeof value === 'number' && value >= 1000) {
                  return (value / 1000).toFixed(1) + 'k';
                }
                return value;
              },
            },
            title: {
              display: true,
              text: 'Participants',
              color: '#22c55e',
            },
          },
        },
      },
    });
  }

  // Initialize when DOM is ready and chart is visible
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initChartWhenVisible('events-history-container', initEventsChart);
    });
  } else {
    initChartWhenVisible('events-history-container', initEventsChart);
  }
</script>
