---
/**
 * Ecosystem Growth Chart
 *
 * Compact multi-line chart showing ecosystem health:
 * - Creators growth (from n8n Arena)
 * - Template inserters growth
 *
 * Designed for homepage hero placement.
 * Data is loaded at build time for instant rendering.
 */

import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

interface Props {
  height?: number;
}

const { height = 200 } = Astro.props;

interface CreatorStats {
  date: string;
  total: number;
  verified: number;
  totalViews: number;
  totalInserters: number;
}

interface CreatorsHistory {
  lastUpdated: string;
  dataSource: {
    name: string;
    repository: string;
    attribution: string;
  };
  daily: CreatorStats[];
  weekly: CreatorStats[];
}

// Load data at build time - only last 16 weeks for compact view
let weeklyData: CreatorStats[] = [];
try {
  const dataPath = join(process.cwd(), 'public', 'data', 'history', 'creators-stats.json');
  if (existsSync(dataPath)) {
    const data: CreatorsHistory = JSON.parse(readFileSync(dataPath, 'utf-8'));
    weeklyData = data.weekly?.slice(-16) || [];
  }
} catch (e) { /* use empty array */ }

const chartDataJson = JSON.stringify(weeklyData);
---

<div id="ecosystem-chart-container" class="card">
  <div class="flex items-center justify-between mb-3">
    <div>
      <h3 class="text-lg font-semibold text-white">Ecosystem Growth</h3>
      <p class="text-sm text-gray-500">Creator economy growth over time</p>
    </div>
    <a href="/creators" class="text-n8n-primary text-sm hover:underline">Details &rarr;</a>
  </div>
  <div class="flex items-center gap-4 text-xs mb-2">
    <span class="flex items-center gap-1.5">
      <span class="w-2 h-2 rounded-full bg-[#ff6d5a]"></span>
      Creators
    </span>
    <span class="flex items-center gap-1.5">
      <span class="w-2 h-2 rounded-full bg-[#36a2eb]"></span>
      Verified
    </span>
  </div>

  <div class="relative" style={`height: ${height}px;`}>
    <canvas id="ecosystem-growth-chart"></canvas>
  </div>

  <!-- No Data State (only shown if build-time data is empty) -->
  <div id="ecosystem-chart-no-data" class="hidden absolute inset-0 flex items-center justify-center bg-n8n-card/80 rounded-lg">
    <span class="text-gray-400 text-sm">No data available</span>
  </div>
</div>

<script define:vars={{ chartDataJson }}>
  window.__ecosystemChartData = JSON.parse(chartDataJson);
</script>

<script>
  import Chart from 'chart.js/auto';
  import { axisTruncationPlugin } from '../../lib/utils/chartPlugins';

  // Register the axis truncation plugin globally
  Chart.register(axisTruncationPlugin);

  interface CreatorStats {
    date: string;
    total: number;
    verified: number;
    totalViews: number;
    totalInserters: number;
  }

  let ecosystemChart: Chart | null = null;

  function initEcosystemChart() {
    const canvas = document.getElementById('ecosystem-growth-chart') as HTMLCanvasElement;
    const noDataEl = document.getElementById('ecosystem-chart-no-data');

    // Data is loaded at build time and passed via define:vars
    const weeklyData: CreatorStats[] = (window as any).__ecosystemChartData || [];

    if (weeklyData.length === 0) {
      noDataEl?.classList.remove('hidden');
      return;
    }

    const labels = weeklyData.map((d: CreatorStats) => {
      // Shorten date labels
      const date = d.date;
      if (date.includes('W')) {
        const [year, week] = date.split('-W');
        return `W${week}`;
      }
      return date;
    });

    ecosystemChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Total Creators',
              data: weeklyData.map((d: CreatorStats) => d.total),
              borderColor: '#ff6d5a',
              backgroundColor: 'rgba(255, 109, 90, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
            {
              label: 'Verified Creators',
              data: weeklyData.map((d: CreatorStats) => d.verified),
              borderColor: '#36a2eb',
              backgroundColor: 'rgba(54, 162, 235, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: '#1e1e1e',
              titleColor: '#fff',
              bodyColor: '#9ca3af',
              borderColor: '#333',
              borderWidth: 1,
              padding: 10,
              callbacks: {
                label: (context) => {
                  return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                },
              },
            },
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                color: '#6b7280',
                font: { size: 10 },
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 8,
              },
            },
            y: {
              display: true,
              position: 'right',
              grid: { color: 'rgba(255,255,255,0.03)' },
              ticks: {
                color: '#6b7280',
                font: { size: 10 },
                callback: (value) => {
                  if (typeof value === 'number') {
                    if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                  }
                  return value;
                },
              },
            },
          },
        },
      });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEcosystemChart);
  } else {
    initEcosystemChart();
  }
</script>

<style>
  #ecosystem-chart-container {
    position: relative;
  }
</style>
