---
/**
 * SourceInfo Component
 *
 * Displays a subtle info icon that reveals data source attribution
 * on hover/focus/click. Provides contextual, accessible attribution
 * without visual noise.
 *
 * Features:
 * - Keyboard accessible (button element)
 * - Hover + focus + click to show tooltip
 * - Screen reader friendly
 * - Minimal visual footprint
 */

interface Props {
  /** Name of the data source (e.g., "GitHub API", "n8n Arena") */
  source: string;
  /** Optional URL to the data source (displayed but not linked) */
  url?: string;
  /** Optional note (e.g., "updated daily", "estimated") */
  note?: string;
  /** Position of the icon relative to parent */
  position?: 'top-right' | 'bottom-right' | 'inline';
  /** Size variant */
  size?: 'sm' | 'md';
}

const {
  source,
  url,
  note,
  position = 'top-right',
  size = 'sm',
} = Astro.props;

// Build tooltip content
let tooltipContent = `Source: ${source}`;
if (note) tooltipContent += ` (${note})`;
if (url) tooltipContent += `\n${url}`;

const positionClasses = {
  'top-right': 'absolute top-2 right-2',
  'bottom-right': 'absolute bottom-2 right-2',
  'inline': 'inline-flex ml-1',
};

const sizeClasses = {
  'sm': 'w-3.5 h-3.5',
  'md': 'w-4 h-4',
};
---

<button
  type="button"
  class={`source-info-btn ${positionClasses[position]} z-10 text-gray-500 hover:text-gray-300 focus:text-gray-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-n8n-primary focus-visible:ring-offset-2 focus-visible:ring-offset-n8n-card rounded-full transition-colors`}
  aria-label={`Data source: ${source}`}
  data-source-tooltip={tooltipContent}
>
  <svg
    class={sizeClasses[size]}
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
    aria-hidden="true"
  >
    <circle cx="12" cy="12" r="10" stroke-width="1.5" />
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 16v-4m0-4h.01" />
  </svg>
  <span class="sr-only">Data source information</span>
</button>

<script>
  function initSourceInfoTooltips() {
    const buttons = document.querySelectorAll<HTMLButtonElement>('.source-info-btn');

    buttons.forEach((btn) => {
      if (btn.dataset.initialized) return;
      btn.dataset.initialized = 'true';

      const tooltipText = btn.dataset.sourceTooltip || '';
      let tooltip: HTMLDivElement | null = null;
      let isVisible = false;

      function createTooltip() {
        tooltip = document.createElement('div');
        tooltip.className = 'source-info-tooltip';
        tooltip.setAttribute('role', 'tooltip');
        tooltip.innerHTML = tooltipText.replace(/\n/g, '<br>');
        document.body.appendChild(tooltip);
        return tooltip;
      }

      function positionTooltip() {
        if (!tooltip) return;
        const btnRect = btn.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        // Position above the button by default
        let top = btnRect.top - tooltipRect.height - 8;
        let left = btnRect.left + (btnRect.width / 2) - (tooltipRect.width / 2);

        // If tooltip would go off top, position below
        if (top < 8) {
          top = btnRect.bottom + 8;
          tooltip.classList.add('tooltip-below');
        } else {
          tooltip.classList.remove('tooltip-below');
        }

        // Keep within viewport horizontally
        if (left < 8) left = 8;
        if (left + tooltipRect.width > window.innerWidth - 8) {
          left = window.innerWidth - tooltipRect.width - 8;
        }

        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;
      }

      function showTooltip() {
        if (isVisible) return;
        isVisible = true;

        if (!tooltip) createTooltip();
        tooltip!.classList.add('visible');
        positionTooltip();

        // Track analytics
        if (typeof umami !== 'undefined') {
          umami.track('source-info-view', { source: tooltipText.split('\n')[0] });
        }
      }

      function hideTooltip() {
        if (!isVisible) return;
        isVisible = false;

        if (tooltip) {
          tooltip.classList.remove('visible');
        }
      }

      function toggleTooltip() {
        if (isVisible) {
          hideTooltip();
        } else {
          showTooltip();
        }
      }

      // Mouse events
      btn.addEventListener('mouseenter', showTooltip);
      btn.addEventListener('mouseleave', hideTooltip);

      // Focus events (keyboard navigation)
      btn.addEventListener('focus', showTooltip);
      btn.addEventListener('blur', hideTooltip);

      // Click/touch for mobile
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleTooltip();
      });

      // Close on Escape
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isVisible) {
          hideTooltip();
        }
      });

      // Close tooltip when clicking outside
      document.addEventListener('click', (e) => {
        if (isVisible && !btn.contains(e.target as Node) && !tooltip?.contains(e.target as Node)) {
          hideTooltip();
        }
      });
    });
  }

  // Initialize on load and after view transitions
  initSourceInfoTooltips();
  document.addEventListener('astro:after-swap', initSourceInfoTooltips);
</script>

<style is:global>
  .source-info-tooltip {
    position: fixed;
    z-index: 50;
    max-width: 220px;
    padding: 0.5rem 0.75rem;
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 0.375rem;
    color: #e5e7eb;
    font-size: 0.75rem;
    line-height: 1.4;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    opacity: 0;
    visibility: hidden;
    transition: opacity 150ms ease, visibility 150ms ease;
    pointer-events: none;
  }

  .source-info-tooltip.visible {
    opacity: 1;
    visibility: visible;
  }

  /* Arrow pointing down (tooltip above button) */
  .source-info-tooltip::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px 6px 0;
    border-style: solid;
    border-color: #1f2937 transparent transparent;
  }

  /* Arrow pointing up (tooltip below button) */
  .source-info-tooltip.tooltip-below::after {
    bottom: auto;
    top: -6px;
    border-width: 0 6px 6px;
    border-color: transparent transparent #1f2937;
  }
</style>
